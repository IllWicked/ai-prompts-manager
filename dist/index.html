<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompts Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    ringWidth: {
                        DEFAULT: '0px'
                    },
                    ringOffsetWidth: {
                        DEFAULT: '0px'
                    }
                }
            },
            corePlugins: {
                ringWidth: false,
                ringColor: false,
                ringOffsetWidth: false,
                ringOffsetColor: false,
                ringOpacity: false
            }
        }
    </script>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-10 -12 577 606'><defs><linearGradient id='warmGradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%23ec7441'/><stop offset='100%25' stop-color='%23f4a574'/></linearGradient></defs><path fill='none' stroke='url(%23warmGradient)' stroke-width='50' stroke-linecap='round' d='M345.39 353.66c-32.55 20.71-92.81 29.2-113.53-3.35-24.86-39.06 23.78-108 62.84-132.86 46.87-29.83 107.73 19.51 119 73.92 12.38 59.75 1.97 104.93-54.28 140.73-67.5 42.95-175.03 28.24-217.99-39.26-51.54-81 1.83-210.11 82.83-261.66 97.2-61.85 180.48-41.32 250.72 50.01 84.06 109.29 65.66 261.06-55.81 327.07C258.54 595.55 99.29 558.2 43.1 402.1 4.93 296.07 45.03 96.9 231.87 28.15'/></svg>">


    <!-- –°—Ç–∏–ª–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- JavaScript –º–æ–¥—É–ª–∏ -->
    <script src="js/config.js"></script>
    <script src="js/remote-prompts.js"></script>
    <script src="js/languages.js"></script>
    <script src="js/embedded-scripts.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/undo.js"></script>
    <script src="js/tabs.js"></script>
    <script src="js/blocks.js"></script>
    <!-- Workflow –º–æ–¥—É–ª–∏ (—Ñ–∞–∑–∞ 2) -->
    <script src="js/workflow-state.js"></script>
    <script src="js/workflow-grid.js"></script>
    <script src="js/workflow-zoom.js"></script>
    <script src="js/connections.js"></script>
    <script src="js/workflow-interactions.js"></script>
    <script src="js/workflow-render.js"></script>
    <!-- Claude –º–æ–¥—É–ª–∏ (—Ñ–∞–∑–∞ 2) -->
    <script src="js/claude-state.js"></script>
    <script src="js/claude-ui.js"></script>
    <script src="js/claude-api.js"></script>

</head>
<body class="text-gray-800 antialiased h-screen overflow-hidden flex flex-col select-none">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="flex flex-col items-center gap-4 text-gray-700">
            <div class="spinner"></div>
            –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤...
        </div>
    </div>

    <!-- Header -->
    <header class="flex-shrink-0 z-50" style="background-color: var(--bg-header);">
        <div class="w-full px-3 py-2 flex justify-between items-center gap-2 flex-wrap">
            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Å–µ–ª–µ–∫—Ç–æ—Ä –≤–∫–ª–∞–¥–æ–∫ –∏ —Å–µ–ª–µ–∫—Ç–æ—Ä —è–∑—ã–∫–∞ -->
            <div class="flex items-center gap-2 flex-wrap">
                <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä –≤–∫–ª–∞–¥–æ–∫ -->
                <div id="tab-dropdown" class="relative">
                    <button id="tab-btn" class="header-selector-btn">
                        <span id="tab-btn-text">Default</span>
                        <svg class="w-3 h-3 transition-transform" id="tab-arrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="tab-menu" class="hidden absolute left-0 top-full mt-2 bg-white rounded-xl shadow-lg border border-gray-200 min-w-[180px] z-[100] overflow-hidden">
                        <div class="py-2">
                        </div>
                    </div>
                </div>
                <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                <div class="header-separator"></div>
                <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä —è–∑—ã–∫–∞ -->
                <div id="language-dropdown" class="relative">
                    <button id="language-btn" class="header-selector-btn">
                        <span id="language-btn-text">EN –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</span>
                        <svg class="w-3 h-3 transition-transform" id="language-arrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="language-menu" class="hidden absolute left-0 top-full mt-2 bg-white rounded-xl shadow-lg border border-gray-200 min-w-[260px] z-[100] overflow-hidden">
                        <div id="language-menu-inner" class="py-2 max-h-[300px] overflow-y-auto pr-2 scrollbar-hidden">
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="at">AT –ê–≤—Å—Ç—Ä–∏—è/–ù–µ–º–µ—Ü–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="bg">BG –ë–æ–ª–≥–∞—Ä—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="ca-en">CA-EN –ö–∞–Ω–∞–¥–∞/–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="ca-fr">CA-FR –ö–∞–Ω–∞–¥–∞/–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="ch-de">CH-DE –®–≤–µ–π—Ü–∞—Ä–∏—è/–ù–µ–º–µ—Ü–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="ch-fr">CH-FR –®–≤–µ–π—Ü–∞—Ä–∏—è/–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="cz">CZ –ß–µ—à—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="de">DE –ù–µ–º–µ—Ü–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="dk">DK –î–∞—Ç—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="en">EN –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="es">ES –ò—Å–ø–∞–Ω—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="fi">FI –§–∏–Ω—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="fr">FR –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="gr">GR –ì—Ä–µ—á–µ—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="hr">HR –•–æ—Ä–≤–∞—Ç—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="hu">HU –í–µ–Ω–≥–µ—Ä—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="it">IT –ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="nl">NL –ì–æ–ª–ª–∞–Ω–¥—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="no">NO –ù–æ—Ä–≤–µ–∂—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="nz">NZ –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è/–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="pl">PL –ü–æ–ª—å—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="pt">PT –ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="ro">RO –†—É–º—ã–Ω—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="se">SE –®–≤–µ–¥—Å–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="sk">SK –°–ª–æ–≤–∞—Ü–∫–∏–π</div>
                            <div class="language-option px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" data-value="sl">SL –°–ª–æ–≤–µ–Ω—Å–∫–∏–π</div>
                        </div>
                        <div id="lang-scrollbar" class="lang-menu-scrollbar">
                            <div class="lang-menu-scrollbar-thumb"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-1 flex-wrap">
                <!-- Claude: –≥–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ + —Ç–∞–±—ã -->
                <div class="claude-controls">
                    <button id="claude-toggle-btn" class="claude-toggle-btn" title="–û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å Claude">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                        <span>Claude</span>
                        <span class="claude-dot"></span>
                    </button>
                    <div class="claude-tabs">
                        <button id="claude-tab-1" class="claude-tab-btn" title="–ß–∞—Ç 1 (–ü–ö–ú: –Ω–æ–≤—ã–π —á–∞—Ç)">–ß–∞—Ç 1</button>
                        <button id="claude-tab-2" class="claude-tab-btn" title="–õ–ö–ú: –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å, –ü–ö–ú: –Ω–æ–≤—ã–π —á–∞—Ç">–ß–∞—Ç 2 √ó</button>
                        <button id="claude-tab-3" class="claude-tab-btn" title="–õ–ö–ú: –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å, –ü–ö–ú: –Ω–æ–≤—ã–π —á–∞—Ç">–ß–∞—Ç 3 √ó</button>
                        <button id="claude-add-tab" class="claude-tab-btn claude-add-btn" title="–î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14"/>
                            </svg>
                            <span>–ß–∞—Ç</span>
                        </button>
                    </div>
                    <label class="auto-send-toggle" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏">
                        <input type="checkbox" id="auto-send-checkbox" class="sr-only">
                        <svg class="auto-send-check" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="auto-send-label">Auto</span>
                    </label>
                </div>
                <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                <div class="toolbar-separator"></div>
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–µ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è, –Ω–µ —Å–∂–∏–º–∞—é—Ç—Å—è) -->
                <div class="header-toolbar-btns">
                    <button id="undo-btn" title="–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a5 5 0 0 1 5 5v2M3 10l4-4M3 10l4 4" />
                        </svg>
                    </button>
                    <button id="redo-btn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (Ctrl+Y)" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 10H11a5 5 0 0 0-5 5v2M21 10l-4-4M21 10l-4 4" />
                        </svg>
                    </button>
                    <button id="refresh-btn" title="–û–±–Ω–æ–≤–∏—Ç—å (F5)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="transform: scaleX(-1)">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                    <button id="scroll-top-btn" title="–ù–∞–≤–µ—Ä—Ö">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5M5 10l7-7 7 7"/>
                        </svg>
                    </button>
                    <button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="edit-toolbar" class="hidden bg-gray-50 border-b border-gray-200 py-2 px-3">
        <div class="w-full flex items-center gap-2 flex-wrap">
            <!-- –ü–∞–Ω–µ–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ -->
            <div id="prompt-tools" class="flex items-center gap-2 flex-wrap">
                <!-- –ö–Ω–æ–ø–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ lang –±–ª–æ–∫–∞ -->
                <div class="relative">
                    <button id="insert-lang-btn" class="edit-toolbar-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                        </svg>
                        <span>–Ø–∑—ã–∫</span>
                    </button>
                    <div id="lang-insert-menu" class="lang-dropdown hidden absolute top-full left-0 mt-1 rounded-lg shadow-lg z-50 w-56 max-h-60 overflow-y-auto">
                        <!-- –ú–µ–Ω—é –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ JS -->
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ -->
                <button id="add-block-btn" class="edit-toolbar-btn" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–∫">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>–ë–ª–æ–∫</span>
                </button>
                
                <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                <div class="toolbar-separator"></div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <button id="exit-edit-mode-btn" class="edit-done-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>–ì–æ—Ç–æ–≤–æ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scrollable Content Container -->
    <div id="scroll-container" class="scroll-container flex-1 overflow-y-auto scrollbar-hidden">
        <!-- Workflow Canvas -->
        <div id="workflow-container" class="workflow-container hidden">
            <div id="workflow-wrapper" class="workflow-wrapper">
                <div id="workflow-canvas" class="workflow-canvas">
                    <!-- –ú–∞—Ä–∫–µ—Ä —Ü–µ–Ω—Ç—Ä–∞ —Ö–æ–ª—Å—Ç–∞ -->
                    <div class="canvas-center-marker"></div>
                    <!-- –û–≤–µ—Ä–ª–µ–π —Ç–æ—á–µ–∫ —Å–µ—Ç–∫–∏ -->
                    <div id="grid-overlay" class="grid-overlay"></div>
                    <svg id="workflow-svg" class="workflow-svg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto" markerUnits="userSpaceOnUse">
                                <polygon points="0 0, 10 4, 0 8" fill="#ec7441" />
                            </marker>
                            <marker id="arrowhead-active" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto" markerUnits="userSpaceOnUse">
                                <polygon points="0 0, 10 4, 0 8" fill="#ff7237" />
                            </marker>
                        </defs>
                        <!-- –õ–∏–Ω–∏–∏ —Å–≤—è–∑–µ–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </svg>
                    <!-- –ë–ª–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <main id="app" class="max-w-4xl mx-auto px-6 pt-8 pb-6 space-y-6 hidden">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –≤–Ω–µ–¥—Ä–µ–Ω —Å—é–¥–∞ —Å –ø–æ–º–æ—â—å—é JS -->
    </main>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑—É–º–∞ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è) -->
    <div id="zoom-indicator" class="zoom-indicator">60%</div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-8 left-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg font-medium text-sm flex items-center gap-2 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span id="toast-text">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä</span>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <button id="finish-project-btn" class="finish-project-btn" onclick="finishProject()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</span>
    </button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <button id="continue-project-btn" class="continue-project-btn" onclick="continueProject()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 3l14 9-14 9V3z" />
        </svg>
        <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</span>
    </button>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–±—Ä–æ—Å–∞ -->
    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø—Ä–æ–º–ø—Ç—ã</h3>
            <p class="text-sm text-gray-600 mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø—Ä–æ–º–ø—Ç—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º?</p>
            <p class="text-sm text-red-500 font-medium">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-reset-btn" class="btn btn-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="confirm-reset-btn" 
                        class="btn btn-danger">
                    –°–±—Ä–æ—Å–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="edit-mode-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?</h3>
            <p class="text-sm text-gray-600 mb-4">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –Ω–∞ —Ö–æ–ª—Å—Ç–µ, —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É –Ω–∏–º–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.</p>
            <p class="text-sm font-medium" style="color: var(--claude-primary);">–í–∫–ª—é—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç–µ.</p>
            
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-edit-mode-btn" class="btn btn-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="confirm-edit-mode-btn" 
                        class="btn btn-primary">
                    –í–∫–ª—é—á–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ -->
    <div id="input-constructor-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column;">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
            
            <!-- –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ò–∫–æ–Ω–∫–∞</label>
                <div id="constructor-icon-selector" class="flex gap-2">
                    <button type="button" class="icon-option p-2 rounded-lg border-2 border-gray-200 hover:border-claude-accent transition-colors" data-icon="info" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                    <button type="button" class="icon-option p-2 rounded-lg border-2 border-gray-200 hover:border-claude-accent transition-colors" data-icon="paperclip" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                    </button>
                    <button type="button" class="icon-option p-2 rounded-lg border-2 border-gray-200 hover:border-claude-accent transition-colors" data-icon="edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- –¢–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –æ—Ä–∞–Ω–∂–µ–≤–æ–π –ø–æ–ª–æ—Å–µ) -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–∫—Å—Ç —Å–Ω–æ—Å–∫–∏</label>
                <input type="text" id="constructor-instruction-text" 
                       class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none text-gray-700 transition-colors"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–º–µ–Ω–∏—Ç—å –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ"
                       maxlength="34">
            </div>
            
            <div class="border-t border-gray-200 pt-4 mb-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–ª—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ</label>
            </div>
            
            <div id="constructor-fields" class="modal-scroll-area scrollbar-thin space-y-3 mb-4 flex-1" style="max-height: 40vh;">
                <!-- –ü–æ–ª—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <button type="button" id="add-constructor-field-btn" 
                    class="flex items-center gap-1 text-sm text-claude-accent hover:text-claude-accent/80 transition-colors mb-4">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</span>
            </button>
            
            <div class="flex justify-end gap-3 mt-2">
                <button id="cancel-constructor-btn" class="btn btn-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="save-constructor-btn" 
                        class="btn btn-primary">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
    
    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–≤–æ–¥–∞ (runtime) -->
    <div id="dynamic-input-modal" class="modal-overlay">
        <div class="modal-content" style="max-height: 90vh; display: flex; flex-direction: column;">
            <h3 id="dynamic-modal-title" class="text-lg font-semibold mb-4 text-gray-800">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h3>
            
            <div id="dynamic-modal-fields" class="modal-scroll-area scrollbar-thin space-y-3 mb-4 flex-1" style="max-height: 60vh;">
                <!-- –ü–æ–ª—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <div class="flex justify-end gap-3 mt-2">
                <button id="cancel-dynamic-input-btn" class="btn btn-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="apply-dynamic-input-btn" 
                        class="btn btn-primary">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞ -->
    <div id="import-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞</h3>
            <p id="import-confirm-message" class="text-sm text-gray-600 mb-4"></p>
            
            <div class="flex justify-end gap-3 mt-6">
                <button id="import-cancel-btn" class="btn btn-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="import-confirm-btn" 
                        class="btn btn-primary">
                    –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–ª—è "–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å...") -->
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 360px;">
            <div class="flex items-start gap-3 mb-4">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-claude-accent/10 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-claude-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <h3 id="alert-title" class="text-lg font-semibold text-gray-800">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
                    <p id="alert-message" class="text-sm text-gray-600 mt-1"></p>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button id="alert-ok-btn" class="btn-primary px-6">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
    <div id="update-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ -->
            <div id="update-available-state">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">üéâ –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!</h3>
                <p class="text-sm text-gray-600 mb-4">
                    –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è <span id="update-version" class="font-semibold text-claude-accent"></span> –≥–æ—Ç–æ–≤–∞ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.
                </p>
                
                <!-- –ü–∞—Ç—á–Ω–æ—É—Ç—ã -->
                <div id="update-notes" class="hidden mb-4">
                    <p class="text-xs font-medium text-gray-500 tracking-wider mb-2">–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:</p>
                    <div id="update-notes-content" class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 max-h-[200px] overflow-y-auto border border-gray-100"></div>
                </div>
                
                <p class="text-xs text-gray-400 mb-2">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button id="update-later-btn" class="btn btn-secondary">
                        –ü–æ–∑–∂–µ
                    </button>
                    <button id="install-update-btn" 
                            class="btn btn-primary">
                        –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
                    </button>
                </div>
            </div>
            
            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è -->
            <div id="update-latest-state" class="hidden">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="#228c46" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 10l4 4 8-8"/>
                    </svg>
                    –ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    –£ –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è <span id="current-version" class="font-semibold text-claude-accent"></span>
                </p>
                
                <div class="flex justify-end mt-6">
                    <button id="update-ok-btn" 
                            class="btn btn-primary">
                        –û–ö
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ü–†–û–ú–ü–¢–û–í -->
    <div id="prompts-update-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ -->
            <div id="prompts-update-available-state">
                <h3 id="prompts-update-title" class="text-lg font-semibold mb-4 text-gray-800">üìù –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤!</h3>
                <p id="prompts-update-subtitle" class="text-sm text-gray-600 mb-2">
                    –î–æ—Å—Ç—É–ø–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≤–∫–ª–∞–¥–æ–∫:
                </p>
                
                <!-- –°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π -->
                <div id="prompts-update-list" class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 mb-4 max-h-[150px] overflow-y-auto border border-gray-100">
                </div>
                
                <!-- –ü–∞—Ç—á–Ω–æ—É—Ç—ã -->
                <div id="prompts-update-notes" class="hidden mb-4">
                    <p class="text-xs font-medium text-gray-500 tracking-wider mb-2">–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:</p>
                    <div id="prompts-update-notes-content" class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 max-h-[150px] overflow-y-auto border border-gray-100"></div>
                </div>
                
                <p id="prompts-update-hint" class="text-xs text-gray-400 mb-2">–ù–æ–≤—ã–µ –≤–∫–ª–∞–¥–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤–∫–ª–∞–¥–æ–∫ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ –∑–∞–ø—Ä–æ—Å—É.</p>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button id="prompts-update-later-btn" class="btn btn-secondary">
                        –ü–æ–∑–∂–µ
                    </button>
                    <button id="prompts-update-apply-btn" class="btn btn-primary">
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button id="prompts-update-done-btn" class="btn btn-primary hidden">
                        –û–ö
                    </button>
                </div>
            </div>
            
            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è -->
            <div id="prompts-update-latest-state" class="hidden">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="#228c46" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 10l4 4 8-8"/>
                    </svg>
                    –ü—Ä–æ–º–ø—Ç—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    –£ –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –≤—Å–µ—Ö –ø—Ä–æ–º–ø—Ç–æ–≤.
                </p>
                
                <div class="flex justify-end mt-6">
                    <button id="prompts-update-ok-btn" class="btn btn-primary">
                        –û–ö
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ù–ê–°–¢–†–û–ï–ö -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; padding: 1.5rem;">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π -->
            <div class="mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col justify-center">
                        <span class="text-sm font-medium text-gray-700 leading-tight">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
                        <p class="text-xs text-gray-500 leading-tight">–ü—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ</p>
                    </div>
                    <div class="flex items-center bg-gray-100 rounded-lg p-0.5 flex-shrink-0">
                        <button id="auto-update-off" class="auto-update-btn flex items-center justify-center w-8 h-8 rounded-md transition-all" title="–í—ã–∫–ª—é—á–µ–Ω–æ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <button id="auto-update-on" class="auto-update-btn flex items-center justify-center w-8 h-8 rounded-md transition-all" title="–í–∫–ª—é—á–µ–Ω–æ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π -->
            <div class="mb-4">
                <div class="flex gap-2">
                    <button id="manual-update-check-btn" class="btn btn-secondary flex-1 text-xs px-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" style="transform: scaleX(-1)" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    </button>
                    <button id="manual-prompts-check-btn" class="btn btn-secondary flex-1 text-xs px-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        –ü—Ä–æ–º–ø—Ç—ã
                    </button>
                </div>
            </div>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
            <div class="mb-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</span>
                    <div class="flex items-center bg-gray-100 rounded-lg p-0.5">
                        <button id="theme-light" class="theme-btn flex items-center justify-center w-8 h-8 rounded-md transition-all" title="–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                        </button>
                        <button id="theme-auto" class="theme-btn flex items-center justify-center w-8 h-8 rounded-md transition-all" title="–ê–≤—Ç–æ">
                            <span class="text-sm font-bold">A</span>
                        </button>
                        <button id="theme-dark" class="theme-btn flex items-center justify-center w-8 h-8 rounded-md transition-all" title="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Hidden input –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–æ–≤ -->
            <input type="file" id="import-file-input" accept=".json" multiple class="hidden">
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="mb-4 pt-3 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col justify-center">
                        <span class="text-sm font-medium text-gray-700 leading-tight">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                        <p class="text-xs text-gray-500 leading-tight">–í–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç–µ</p>
                    </div>
                    <div class="flex items-center bg-gray-100 rounded-lg p-0.5 flex-shrink-0">
                        <button id="edit-mode-off" class="edit-mode-btn flex items-center justify-center w-8 h-8 rounded-md transition-all" title="–í—ã–∫–ª—é—á–µ–Ω–æ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <button id="edit-mode-on" class="edit-mode-btn flex items-center justify-center w-8 h-8 rounded-md transition-all" title="–í–∫–ª—é—á–µ–Ω–æ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
            <div class="mb-4 pt-3 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col justify-center">
                        <span class="text-sm font-medium text-gray-700 leading-tight">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</span>
                        <p class="text-xs text-gray-500 leading-tight">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –∏ —á–∞—Ç—ã Claude</p>
                    </div>
                    <button id="reset-btn" class="btn btn-danger">
                        –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                </div>
            </div>
            
            <!-- –†–∞–∑–¥–µ–ª –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
            <div class="mb-4 pt-3 border-t border-gray-200">
                <button id="advanced-settings-toggle" class="flex items-center justify-between w-full text-left">
                    <span class="text-sm font-medium text-gray-700">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</span>
                    <svg id="advanced-settings-arrow" class="h-4 w-4 text-gray-500 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="advanced-settings-content" class="hidden mt-3 space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</span>
                        <button id="open-app-data-btn" class="btn btn-secondary text-xs">
                            –û—Ç–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">–õ–æ–≥ –∞—Ä—Ö–∏–≤–æ–≤</span>
                        <button id="open-archive-log-btn" class="btn btn-secondary text-xs">
                            –û—Ç–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –í–µ—Ä—Å–∏—è –∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <div class="pt-3 border-t border-gray-200 flex items-center justify-between">
                <span id="version-label" class="text-xs text-gray-400 cursor-default select-none">
                    –í–µ—Ä—Å–∏—è: <span id="settings-version">4.0.1</span>
                </span>
                <button id="settings-close-btn" class="btn btn-primary">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –õ–û–ì–ê –°–ö–ê–ß–ò–í–ê–ù–ò–ô -->
    <div id="archive-log-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">–õ–æ–≥ –∞—Ä—Ö–∏–≤–æ–≤</h3>
                <div class="flex gap-2">
                    <input type="text" id="archive-log-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞..." 
                           class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" style="width: 200px;">
                    <button id="clear-archive-log-btn" class="btn btn-secondary text-xs">
                        –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
                    </button>
                </div>
            </div>
            <div id="archive-log-content" class="overflow-auto" style="max-height: 50vh;">
                <table class="w-full text-sm">
                    <thead class="archive-log-header">
                        <tr>
                            <th class="archive-log-cell archive-log-th">–î–∞—Ç–∞</th>
                            <th class="archive-log-cell archive-log-th">–§–∞–π–ª</th>
                            <th class="archive-log-cell archive-log-th">–°—Å—ã–ª–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody id="archive-log-tbody">
                    </tbody>
                </table>
            </div>
            <div class="pt-3 border-t border-gray-200 flex justify-end mt-4">
                <button id="close-archive-log-btn" class="btn btn-primary">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í–ö–õ–ê–î–ö–ò -->
    <div id="add-tab-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-1 text-gray-800">–ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞</h3>
            <p id="add-tab-error" class="text-sm mb-3 hidden" class="text-danger">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏</p>
            <input type="text" id="new-tab-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none mb-4">
            <div class="flex justify-end gap-3">
                <button id="cancel-add-tab-btn" class="btn btn-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="confirm-add-tab-btn" class="btn btn-primary">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GLOBAL ERROR HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.onerror = (msg, src, line, col, err) => {
            
            return false;
        };
        window.onunhandledrejection = (e) => {
            
        };

        /**
         * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
         * ‚ïë                    AI PROMPTS MANAGER v4.0.1                              ‚ïë
         * ‚ïë                                                                           ‚ïë
         * ‚ïë  Tauri 2.0 –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞–º–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Claude AI   ‚ïë
         * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
         * 
         * –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: docs/ARCHITECTURE.md
         * 
         * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞:
         *   –°–ï–ö–¶–ò–Ø 1:  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, AppState, –∞–ª–∏–∞—Å—ã
         *   –°–ï–ö–¶–ò–Ø 2:  –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª–∞–¥–æ–∫ (initTabSelector, switchToTab)
         *   –°–ï–ö–¶–ò–Ø 12: Workflow —Ä–µ–∂–∏–º
         *   –°–ï–ö–¶–ò–Ø 13: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Claude
         *   –°–ï–ö–¶–ò–Ø 14: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω—é
         *   –°–ï–ö–¶–ò–Ø 15: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (DOMContentLoaded)
         * 
         * –°–µ–∫—Ü–∏–∏ 3-11 –≤—ã–Ω–µ—Å–µ–Ω—ã –≤–æ –≤–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (dist/js/*.js)
         */

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –°–ï–ö–¶–ò–Ø 1: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/config.js

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SHARED STATE ‚Äî –µ–¥–∏–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–¥–ª—è –º–æ–¥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.AppState = {
            // Workflow —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            workflow: {
                mode: true,
                connections: [],
                positions: {},
                sizes: {},
                zoom: parseFloat(localStorage.getItem('workflowZoom')) || 0.6
            },
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (drag, resize, select)
            interaction: {
                isResizing: false,
                resizeNode: null,
                resizeStart: { x: 0, y: 0, width: 0, height: 0, left: 0, top: 0 },
                resizeDirection: null,
                selectedNodes: new Set(),
                isDragging: false,
                dragOffsets: {},
                clipboard: [],
                isCreatingConnection: false,
                connectionStart: null,
                tempLineEl: null
            },
            // Claude –ø–∞–Ω–µ–ª—å
            claude: {
                isVisible: false,
                activeTab: 1,
                existingTabs: [1],
                generatingTabs: {},
                tabUrls: {},
                panelRatio: 50,
                isResetting: false,
                project: null // { uuid: string, name: string, ownerTab: string } | null
            },
            // –†–µ—Å–∞–π–∑–µ—Ä –ø–∞–Ω–µ–ª–µ–π Claude
            resizer: {
                element: null,
                isResizing: false,
                startX: 0,
                startRatio: 0,
                windowWidth: 0,
                lastAppliedRatio: 0,
                updateScheduled: false
            },
            // –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            app: {
                currentTab: localStorage.getItem(STORAGE_KEYS.CURRENT_TAB) || DEFAULT_TAB,
                isEditMode: false,
                isAdminMode: false, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ getSettings()
                isAppInitialized: false,
                currentLanguage: localStorage.getItem(STORAGE_KEYS.LANGUAGE) || 'en'
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ê–õ–ò–ê–°–´ –î–õ–Ø –û–ë–†–ê–¢–ù–û–ô –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // App state –∞–ª–∏–∞—Å—ã
        Object.defineProperty(window, 'currentTab', {
            get() { return window.AppState.app.currentTab; },
            set(v) { window.AppState.app.currentTab = v; }
        });
        Object.defineProperty(window, 'isEditMode', {
            get() { return window.AppState.app.isEditMode; },
            set(v) { window.AppState.app.isEditMode = v; }
        });
        Object.defineProperty(window, 'currentLanguage', {
            get() { return window.AppState.app.currentLanguage; },
            set(v) { window.AppState.app.currentLanguage = v; }
        });
        
        // Workflow –∞–ª–∏–∞—Å—ã
        Object.defineProperty(window, 'workflowMode', {
            get() { return window.AppState.workflow.mode; },
            set(v) { window.AppState.workflow.mode = v; }
        });
        Object.defineProperty(window, 'workflowConnections', {
            get() { return window.AppState.workflow.connections; },
            set(v) { window.AppState.workflow.connections = v; }
        });
        Object.defineProperty(window, 'workflowPositions', {
            get() { return window.AppState.workflow.positions; },
            set(v) { window.AppState.workflow.positions = v; }
        });
        Object.defineProperty(window, 'workflowSizes', {
            get() { return window.AppState.workflow.sizes; },
            set(v) { window.AppState.workflow.sizes = v; }
        });
        Object.defineProperty(window, 'workflowZoom', {
            get() { return window.AppState.workflow.zoom; },
            set(v) { window.AppState.workflow.zoom = v; }
        });
        
        // Interaction –∞–ª–∏–∞—Å—ã
        Object.defineProperty(window, 'isResizingNode', {
            get() { return window.AppState.interaction.isResizing; },
            set(v) { window.AppState.interaction.isResizing = v; }
        });
        Object.defineProperty(window, 'resizeNode', {
            get() { return window.AppState.interaction.resizeNode; },
            set(v) { window.AppState.interaction.resizeNode = v; }
        });
        Object.defineProperty(window, 'resizeDirection', {
            get() { return window.AppState.interaction.resizeDirection; },
            set(v) { window.AppState.interaction.resizeDirection = v; }
        });
        Object.defineProperty(window, 'selectedNodes', {
            get() { return window.AppState.interaction.selectedNodes; },
            set(v) { window.AppState.interaction.selectedNodes = v; }
        });
        Object.defineProperty(window, 'isDraggingNode', {
            get() { return window.AppState.interaction.isDragging; },
            set(v) { window.AppState.interaction.isDragging = v; }
        });
        Object.defineProperty(window, 'dragOffsets', {
            get() { return window.AppState.interaction.dragOffsets; },
            set(v) { window.AppState.interaction.dragOffsets = v; }
        });
        Object.defineProperty(window, 'clipboard', {
            get() { return window.AppState.interaction.clipboard; },
            set(v) { window.AppState.interaction.clipboard = v; }
        });
        Object.defineProperty(window, 'isCreatingConnection', {
            get() { return window.AppState.interaction.isCreatingConnection; },
            set(v) { window.AppState.interaction.isCreatingConnection = v; }
        });
        Object.defineProperty(window, 'connectionStart', {
            get() { return window.AppState.interaction.connectionStart; },
            set(v) { window.AppState.interaction.connectionStart = v; }
        });
        Object.defineProperty(window, 'tempLineEl', {
            get() { return window.AppState.interaction.tempLineEl; },
            set(v) { window.AppState.interaction.tempLineEl = v; }
        });
        
        // Claude –∞–ª–∏–∞—Å—ã
        Object.defineProperty(window, 'isClaudeVisible', {
            get() { return window.AppState.claude.isVisible; },
            set(v) { window.AppState.claude.isVisible = v; }
        });
        Object.defineProperty(window, 'activeClaudeTab', {
            get() { return window.AppState.claude.activeTab; },
            set(v) { window.AppState.claude.activeTab = v; }
        });
        Object.defineProperty(window, 'existingTabs', {
            get() { return window.AppState.claude.existingTabs; },
            set(v) { window.AppState.claude.existingTabs = v; }
        });
        Object.defineProperty(window, 'generatingTabs', {
            get() { return window.AppState.claude.generatingTabs; },
            set(v) { window.AppState.claude.generatingTabs = v; }
        });
        Object.defineProperty(window, 'tabUrls', {
            get() { return window.AppState.claude.tabUrls; },
            set(v) { window.AppState.claude.tabUrls = v; }
        });
        Object.defineProperty(window, 'panelRatio', {
            get() { return window.AppState.claude.panelRatio; },
            set(v) { window.AppState.claude.panelRatio = v; }
        });
        Object.defineProperty(window, 'isResetting', {
            get() { return window.AppState.claude.isResetting; },
            set(v) { window.AppState.claude.isResetting = v; }
        });
        Object.defineProperty(window, 'activeProject', {
            get() { return window.AppState.claude.project; },
            set(v) { window.AppState.claude.project = v; }
        });
        
        // Resizer –∞–ª–∏–∞—Å—ã
        Object.defineProperty(window, 'resizer', {
            get() { return window.AppState.resizer.element; },
            set(v) { window.AppState.resizer.element = v; }
        });
        Object.defineProperty(window, 'isResizing', {
            get() { return window.AppState.resizer.isResizing; },
            set(v) { window.AppState.resizer.isResizing = v; }
        });
        Object.defineProperty(window, 'startX', {
            get() { return window.AppState.resizer.startX; },
            set(v) { window.AppState.resizer.startX = v; }
        });
        Object.defineProperty(window, 'startRatio', {
            get() { return window.AppState.resizer.startRatio; },
            set(v) { window.AppState.resizer.startRatio = v; }
        });
        Object.defineProperty(window, 'windowWidth', {
            get() { return window.AppState.resizer.windowWidth; },
            set(v) { window.AppState.resizer.windowWidth = v; }
        });
        Object.defineProperty(window, 'lastAppliedRatio', {
            get() { return window.AppState.resizer.lastAppliedRatio; },
            set(v) { window.AppState.resizer.lastAppliedRatio = v; }
        });
        Object.defineProperty(window, 'updateScheduled', {
            get() { return window.AppState.resizer.updateScheduled; },
            set(v) { window.AppState.resizer.updateScheduled = v; }
        });

        // –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ (—Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å)
        // let currentTab = ... ‚Äî –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ window.AppState.app.currentTab

        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –°–ï–ö–¶–ò–Ø 2: –°–ò–°–¢–ï–ú–ê –í–ö–õ–ê–î–û–ö
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // isEditMode ‚Äî —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å window.AppState.app.isEditMode
        let isAdminMode = getSettings().adminMode || false; // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º adminMode –≤ AppState
        window.AppState.app.isAdminMode = isAdminMode;
        
        // –§–ª–∞–≥ –¥–ª—è –∑–∞—â–∏—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –æ—Ç —Å–±—Ä–æ—Å–∞ –ø—Ä–∏ mouseup –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–∞
        let isTextSelecting = false;
        window.isTextSelecting = false; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
        
        // getTabItems, getTabBlocks ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ tabs.js
        
        // createNewTab, updateTab, deleteTab, addBlockToTab ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ tabs.js
        
        // removeItemFromTab, removeBlockFromTab, updateBlockTitle, updateBlockInstruction ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ tabs.js
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ –≤ JSON
        async function exportConfig() {
            const tabs = getAllTabs();
            const currentTabData = tabs[currentTab];
            
            if (!currentTabData) {
                
                return;
            }
            
            // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ localStorage –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
            const savedContent = loadFromLocalStorage();
            const blocks = getTabBlocks(currentTab);
            
            // –°–æ–∑–¥–∞—ë–º –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∏ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
            const exportTabData = JSON.parse(JSON.stringify(currentTabData));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º content –≤ items –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            let blockIndex = 0;
            exportTabData.items = exportTabData.items.map(item => {
                if (item.type === 'block') {
                    blockIndex++;
                    const blockNumber = String(blockIndex);
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ ID, –ø–æ—Ç–æ–º –ø–æ –Ω–æ–º–µ—Ä—É (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
                    const content = savedContent[item.id] !== undefined ? savedContent[item.id] : savedContent[blockNumber];
                    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
                    const scripts = getBlockScripts(item.id);
                    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤—ë—Ä–Ω—É—Ç–æ—Å—Ç–∏
                    const collapsed = isBlockCollapsed(item.id);
                    // –ü–æ–ª—É—á–∞–µ–º automation —Ñ–ª–∞–≥–∏
                    const automation = getBlockAutomationFlags(item.id);
                    // –ü–æ–ª—É—á–∞–µ–º hasAttachments
                    const hasAttachments = hasBlockAttachmentsPanel(item.id);
                    
                    const updatedItem = { ...item };
                    if (content !== undefined) {
                        updatedItem.content = content;
                    }
                    if (scripts.length > 0) {
                        updatedItem.scripts = scripts;
                    }
                    if (collapsed) {
                        updatedItem.collapsed = true;
                    }
                    if (Object.keys(automation).length > 0) {
                        updatedItem.automation = automation;
                    }
                    if (hasAttachments) {
                        updatedItem.hasAttachments = true;
                    }
                    return updatedItem;
                }
                return item;
            });
            
            const config = {
                version: 2,
                exportDate: new Date().toISOString(),
                tab: exportTabData,
                workflow: {
                    positions: workflowPositions,
                    sizes: workflowSizes,
                    connections: workflowConnections
                }
            };
            
            const jsonContent = JSON.stringify(config, null, 2);
            const safeName = currentTabData.name.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å]/g, '-').toLowerCase();
            const defaultFileName = `${safeName}-${new Date().toISOString().split('T')[0]}.json`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ Tauri API –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (window.__TAURI__ && window.__TAURI__.dialog) {
                try {
                    const filePath = await window.__TAURI__.dialog.save({
                        defaultPath: defaultFileName,
                        filters: [{
                            name: 'JSON',
                            extensions: ['json']
                        }]
                    });
                    
                    if (filePath) {
                        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ Tauri fs plugin (v2 API)
                        try {
                            if (window.__TAURI__.fs && window.__TAURI__.fs.writeTextFile) {
                                await window.__TAURI__.fs.writeTextFile(filePath, jsonContent);
                            } else {
                                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ core.invoke
                                await window.__TAURI__.core.invoke('plugin:fs|write_text_file', {
                                    path: filePath,
                                    contents: jsonContent
                                });
                            }
                            showToast('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                        } catch (writeError) {
                            
                            showToast('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞');
                        }
                    }
                } catch (e) {
                    
                    // Fallback –Ω–∞ –æ–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –µ—Å–ª–∏ dialog –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                    downloadFile(jsonContent, defaultFileName);
                    showToast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω –≤ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫');
                }
            } else {
                // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
                downloadFile(jsonContent, defaultFileName);
            }
        }
        
        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // currentLanguage ‚Äî —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å window.AppState.app.currentLanguage

        /**
         * –ó–∞–º–µ–Ω—è–µ—Ç –≤—Å–µ —Ñ–æ—Ä–º—ã –æ–¥–Ω–æ–≥–æ —è–∑—ã–∫–∞ –Ω–∞ –¥—Ä—É–≥–æ–π –≤ —Ç–µ–∫—Å—Ç–µ
         */
        function replaceLanguage(text, fromLang, toLang) {
            if (!fromLang || !toLang || fromLang === toLang) return text;
            
            const from = LANGUAGES[fromLang];
            const to = LANGUAGES[toLang];
            
            if (!from || !to) return text;
            
            let result = text;
            
            // –î–∏–∞–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ - –¥–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞
            // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π (en) –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–∏–∞–∫—Ä–∏—Ç–∏–∫–∏, –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±—É—é—Ç
            if (toLang === 'en') {
                // –£–±–∏—Ä–∞–µ–º –¥–∏–∞–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
                result = result.replace(/–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ, –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–µ, –¥–∏–∞–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ/g, '–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ, –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–µ');
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
                result = result.replace(/–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ, –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–µ(?!, –¥–∏–∞–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)/g, '–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ, –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–µ, –¥–∏–∞–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ');
            }
            
            // –ù–∞–∑–≤–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (—Ç–æ—á–Ω–∞—è –∑–∞–º–µ–Ω–∞)
            result = result.split(from.privacyPolicy).join(to.privacyPolicy);
            result = result.split(from.aboutUs).join(to.aboutUs);
            result = result.split(from.legalInfo).join(to.legalInfo);
            result = result.split(from.cookiePolicy).join(to.cookiePolicy);
            
            // –§–æ—Ä–º—ã —è–∑—ã–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–∫–∏ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Å–ª–æ–≤
            // –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: —Å–Ω–∞—á–∞–ª–∞ –¥–ª–∏–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã, –ø–æ—Ç–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ
            const replacePairs = [
                [from.segmentAudience, to.segmentAudience],
                [from.segment, to.segment],
                [from.adjectivePlural, to.adjectivePlural],
                [from.adjective, to.adjective],
                [from.prepositional, to.prepositional],
                [from.genitive, to.genitive],
                [from.name, to.name]
            ];
            
            for (const [fromWord, toWord] of replacePairs) {
                if (fromWord && toWord) {
                    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–∫–∏
                    const escaped = fromWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(escaped, 'g');
                    result = result.replace(regex, toWord);
                }
            }
            
            return result;
        }

        /**
         * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
         * @param {string} text - —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
         * @returns {string|null} - –∫–æ–¥ —è–∑—ã–∫–∞ –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω
         */
        function detectLanguageInText(text) {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–º–µ—à–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏
            // –î–ª—è –Ω–∏—Ö –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ö–û–ú–ë–ò–ù–ê–¶–ò–Æ: —Ñ–æ—Ä–º—É –∞—É–¥–∏—Ç–æ—Ä–∏–∏ + —Ñ–æ—Ä–º—É —è–∑—ã–∫–∞
            const mixedLangs = ['at', 'ca-en', 'ca-fr', 'ch-de', 'ch-fr', 'nz'];
            
            for (const langCode of mixedLangs) {
                const lang = LANGUAGES[langCode];
                if (!lang) continue;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ä–º—ã –∞—É–¥–∏—Ç–æ—Ä–∏–∏
                const hasAudience = (lang.segmentAudience && text.includes(lang.segmentAudience)) ||
                                   (lang.segment && text.includes(lang.segment)) ||
                                   (lang.adjective && text.includes(lang.adjective));
                
                if (!hasAudience) continue;
                
                // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–∫–∂–µ —Ñ–æ—Ä–º—ã —è–∑—ã–∫–∞
                // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–ª–∏—á–∏—Ç—å ca-en (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è –∫–∞–Ω–∞–¥—Ü–µ–≤) –æ—Ç ca-fr (—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –¥–ª—è –∫–∞–Ω–∞–¥—Ü–µ–≤)
                const hasLanguage = (lang.prepositional && text.includes(lang.prepositional)) ||
                                   (lang.genitive && text.includes(lang.genitive)) ||
                                   (lang.name && text.includes(lang.name));
                
                if (hasAudience && hasLanguage) {
                    return langCode;
                }
            }
            
            // –ï—Å–ª–∏ —Å–º–µ—à–∞–Ω–Ω—ã–π —è–∑—ã–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
            // (–¥–ª—è —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç —Ñ–æ—Ä–º—ã —è–∑—ã–∫–∞)
            for (const langCode of mixedLangs) {
                const lang = LANGUAGES[langCode];
                if (!lang) continue;
                
                if (lang.segmentAudience && text.includes(lang.segmentAudience)) {
                    return langCode;
                }
                if (lang.segment && text.includes(lang.segment)) {
                    return langCode;
                }
            }
            
            // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ã—á–Ω—ã–µ —è–∑—ã–∫–∏
            for (const [langCode, lang] of Object.entries(LANGUAGES)) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–º–µ—à–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏ (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã)
                if (mixedLangs.includes(langCode)) continue;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã —è–∑—ã–∫–∞
                // –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: —Å–Ω–∞—á–∞–ª–∞ –±–æ–ª–µ–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ/–¥–ª–∏–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                if (lang.segmentAudience && text.includes(lang.segmentAudience)) {
                    return langCode;
                }
                if (lang.segment && text.includes(lang.segment)) {
                    return langCode;
                }
                if (lang.genitive && text.includes(lang.genitive)) {
                    return langCode;
                }
                if (lang.prepositional && text.includes(lang.prepositional)) {
                    return langCode;
                }
                if (lang.adjective && text.includes(lang.adjective)) {
                    return langCode;
                }
                if (lang.name && text.includes(lang.name)) {
                    return langCode;
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–∑—ã–∫–∞)
                if (lang.privacyPolicy && lang.privacyPolicy !== 'Privacy Policy' && text.includes(lang.privacyPolicy)) {
                    return langCode;
                }
            }
            return null;
        }
        
        // –ù–∞–π—Ç–∏ –í–°–ï —è–∑—ã–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞)
        function detectAllLanguagesInText(text) {
            const foundLangs = new Set();
            const mixedLangs = ['at', 'ca-en', 'ca-fr', 'ch-de', 'ch-fr', 'nz'];
            
            for (const [langCode, lang] of Object.entries(LANGUAGES)) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–º–µ—à–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏ - –æ–Ω–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
                if (mixedLangs.includes(langCode)) continue;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã —è–∑—ã–∫–∞
                if ((lang.segmentAudience && text.includes(lang.segmentAudience)) ||
                    (lang.segment && text.includes(lang.segment)) ||
                    (lang.genitive && text.includes(lang.genitive)) ||
                    (lang.prepositional && text.includes(lang.prepositional)) ||
                    (lang.adjective && text.includes(lang.adjective)) ||
                    (lang.name && text.includes(lang.name))) {
                    foundLangs.add(langCode);
                }
            }
            
            return [...foundLangs];
        }

        /**
         * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ (–ø–µ—Ä–≤—ã–π –±–ª–æ–∫)
         */
        function detectLanguageFromText() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –±–ª–æ–∫–∞
            const blocks = getTabBlocks(currentTab);
            if (blocks.length > 0 && blocks[0].content) {
                const detected = detectLanguageInText(blocks[0].content);
                return detected || 'en';
            }
            return 'en';
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –≤–∫–ª–∞–¥–æ–∫
         */
        function initTabSelector() {
            const dropdown = document.getElementById('tab-dropdown');
            const btn = document.getElementById('tab-btn');
            const btnText = document.getElementById('tab-btn-text');
            const menu = document.getElementById('tab-menu');
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è inline-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
            let pendingDeleteTabId = null;
            
            // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –º–µ–Ω—é –≤–∫–ª–∞–¥–æ–∫
            function renderTabMenu() {
                const allTabs = getAllTabs();
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏ –ø–æ order
                const sortedTabs = Object.values(allTabs).sort((a, b) => (a.order || 0) - (b.order || 0));
                
                let html = '<div class="py-2">';
                
                // –í—Å–µ –≤–∫–ª–∞–¥–∫–∏
                sortedTabs.forEach(tab => {
                    const isSelected = currentTab === tab.id;
                    const isPendingDelete = pendingDeleteTabId === tab.id;
                    const isProjectOwner = activeProject && activeProject.ownerTab === tab.id;
                    
                    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∫—Ä—É–∂–æ–∫)
                    const projectIndicator = isProjectOwner ? `<span class="project-indicator" style="animation-delay: ${getSyncedAnimationDelay()}"></span>` : '';
                    
                    html += `
                        <div class="tab-option py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors flex items-center gap-4 group ${isSelected ? 'bg-gray-50' : ''}" data-value="${tab.id}">
                            <span class="tab-name flex-1 truncate max-w-[250px] pl-4" data-tab-id="${tab.id}">${projectIndicator}${escapeHtml(tab.name).toUpperCase()}</span>
                            ${isAdminMode ? `
                            <div class="tab-actions flex items-center gap-1 shrink-0 pr-4 ${isPendingDelete ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity">
                                <button class="tab-rename-btn p-1 hover:bg-gray-200 rounded" data-tab-id="${tab.id}" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button class="tab-delete-btn p-1 hover:bg-red-100 rounded ${isPendingDelete ? 'hidden' : ''}" data-tab-id="${tab.id}" title="–£–¥–∞–ª–∏—Ç—å">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                                <button class="tab-confirm-delete-btn p-1 hover:bg-red-200 rounded bg-red-100 ${isPendingDelete ? '' : 'hidden'}" data-tab-id="${tab.id}" title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
                if (isAdminMode) {
                    html += `
                        <div class="border-t border-gray-200 my-1"></div>
                        <div class="add-tab-option px-4 py-2 text-sm text-claude-accent hover:bg-gray-100 cursor-pointer transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span>–î–æ–±–∞–≤–∏—Ç—å</span>
                        </div>
                        <div class="edit-tab-option px-4 py-2 text-sm ${isEditMode ? 'text-claude-accent edit-active' : 'text-gray-500 hover:bg-gray-100'} cursor-pointer transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <span>${isEditMode ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'}</span>
                            ${isEditMode ? SVG_ICONS.check : ''}
                        </div>
                        <div class="export-tab-option px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 cursor-pointer transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
                        </div>
                        <div class="import-tab-option px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 cursor-pointer transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            <span>–ò–º–ø–æ—Ä—Ç</span>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                menu.innerHTML = html;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
                menu.querySelectorAll('.tab-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–∞–º –¥–µ–π—Å—Ç–≤–∏–π - –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∫–ª–∞–¥–∫—É
                        if (e.target.closest('.tab-actions')) return;
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å pending delete –∏ –∫–ª–∏–∫–Ω—É–ª–∏ –≤ –¥—Ä—É–≥–æ–µ –º–µ—Å—Ç–æ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                        if (pendingDeleteTabId) {
                            pendingDeleteTabId = null;
                            renderTabMenu();
                            return;
                        }
                        
                        const newTab = option.dataset.value;
                        if (currentTab === newTab) {
                            closeMenu();
                            return;
                        }
                        
                        switchToTab(newTab);
                        closeMenu();
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è (inline)
                menu.querySelectorAll('.tab-rename-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tabId = btn.dataset.tabId;
                        const tabOption = btn.closest('.tab-option');
                        const span = tabOption.querySelector('.tab-name');
                        if (!span) return;
                        
                        const originalName = getAllTabs()[tabId]?.name || '';
                        const spanStyle = getComputedStyle(span);
                        const paddingLeft = spanStyle.paddingLeft;
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ span, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
                        span.style.color = 'transparent';
                        
                        // –°–æ–∑–¥–∞—ë–º input –≤–Ω—É—Ç—Ä–∏ span
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'tab-name-input';
                        input.style.cssText = `
                            position: absolute;
                            left: ${paddingLeft};
                            top: 0;
                            width: calc(100% - ${paddingLeft});
                            height: 100%;
                            padding: 0 4px;
                            margin: 0;
                            border: 1px solid var(--claude-primary);
                            border-radius: 4px;
                            outline: none;
                            background: transparent;
                            font-size: inherit;
                            font-family: inherit;
                            color: var(--text-primary);
                            box-sizing: border-box;
                        `;
                        input.value = originalName;
                        input.dataset.tabId = tabId;
                        input.dataset.original = originalName;
                        
                        // –î–µ–ª–∞–µ–º span relative –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è input
                        span.style.position = 'relative';
                        span.appendChild(input);
                        input.focus();
                        input.select();
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è input
                        const cleanup = () => {
                            span.style.color = '';
                            span.style.position = '';
                            if (input.parentNode) input.remove();
                        };
                        
                        const saveRename = () => {
                            const newName = input.value.trim();
                            cleanup();
                            if (newName && newName !== originalName) {
                                renameTab(tabId, newName);
                                updateSelectedUI();
                            }
                            renderTabMenu();
                        };
                        
                        input.addEventListener('blur', saveRename);
                        input.addEventListener('keydown', (ev) => {
                            if (ev.key === 'Enter') {
                                ev.preventDefault();
                                input.blur();
                            } else if (ev.key === 'Escape') {
                                ev.preventDefault();
                                cleanup();
                                renderTabMenu();
                            }
                        });
                        input.addEventListener('click', (ev) => ev.stopPropagation());
                        
                        pendingDeleteTabId = null;
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (–ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
                menu.querySelectorAll('.tab-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tabId = btn.dataset.tabId;
                        pendingDeleteTabId = tabId;
                        renderTabMenu();
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
                menu.querySelectorAll('.tab-confirm-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tabId = btn.dataset.tabId;
                        
                        if (deleteTab(tabId)) {
                            pendingDeleteTabId = null;
                            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
                            if (currentTab === tabId) {
                                const allTabs = getAllTabs();
                                const firstTab = Object.values(allTabs).sort((a, b) => (a.order || 0) - (b.order || 0))[0];
                                switchToTab(firstTab?.id || DEFAULT_TAB);
                            }
                            renderTabMenu();
                            updateSelectedUI();
                        }
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                menu.querySelector('.add-tab-option')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeMenu();
                    showAddTabModal();
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                menu.querySelector('.edit-tab-option')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    isEditMode = !isEditMode;
                    toggleEditToolbar(isEditMode);
                    closeMenu();
                    if (workflowMode) {
                        renderWorkflow();
                        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –Ω–∞ –±–ª–æ–∫–∞—Ö –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ edit mode
                        if (isEditMode) {
                            setTimeout(() => scrollToBlocks(), 50);
                        }
                    } else {
                        loadPrompts();
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
                menu.querySelector('.export-tab-option')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeMenu();
                    exportConfig();
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–º–ø–æ—Ä—Ç–∞
                menu.querySelector('.import-tab-option')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeMenu();
                    importConfig();
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ UI
            function updateSelectedUI() {
                const allTabs = getAllTabs();
                const tab = allTabs[currentTab];
                const name = tab ? tab.name.toUpperCase() : 'DEFAULT';
                // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–º–∞–∫—Å 20 —Å–∏–º–≤–æ–ª–æ–≤)
                const maxLen = 20;
                const displayName = name.length > maxLen ? name.slice(0, maxLen - 1) + '‚Ä¶' : name;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –ø—Ä–æ–µ–∫—Ç–∞
                const isProjectOwner = activeProject && activeProject.ownerTab === currentTab;
                const projectIndicator = isProjectOwner ? `<span class="project-indicator" style="animation-delay: ${getSyncedAnimationDelay()}"></span>` : '';
                
                btnText.innerHTML = projectIndicator + escapeHtml(displayName);
                btnText.title = name; // –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ tooltip
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–Ω—é
            function toggleMenu() {
                const isOpen = !menu.classList.contains('hidden');
                if (isOpen) {
                    closeMenu();
                } else {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —è–∑—ã–∫–∞ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
                    const langMenu = document.getElementById('language-menu');
                    const langDropdown = document.getElementById('language-dropdown');
                    if (langMenu && !langMenu.classList.contains('hidden')) {
                        langMenu.classList.add('hidden');
                        langDropdown?.classList.remove('open');
                    }
                    
                    pendingDeleteTabId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    renderTabMenu();
                    menu.classList.remove('hidden');
                    dropdown.classList.add('open');
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
            function closeMenu() {
                menu.classList.add('hidden');
                dropdown.classList.remove('open');
                pendingDeleteTabId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            function switchToTab(newTab) {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                if (!newTab) {
                    
                    return;
                }
                
                const oldTab = currentTab;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
                if (oldTab && oldTab !== newTab) {
                    tabHistories[oldTab] = {
                        undoStack: [...undoStack],
                        redoStack: [...redoStack]
                    };
                }
                
                currentTab = newTab;
                localStorage.setItem(STORAGE_KEYS.CURRENT_TAB, newTab);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                isEditMode = false;
                toggleEditToolbar(false);
                
                // –û—á–∏—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ (–±–ª–æ–∫–∏ —Å –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –Ω–∞ –Ω–æ–≤–æ–π)
                selectedNodes.clear();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateSelectedUI();
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
                if (tabHistories[newTab]) {
                    undoStack = [...tabHistories[newTab].undoStack];
                    redoStack = [...tabHistories[newTab].redoStack];
                } else {
                    // –ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ - —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é
                    undoStack = [];
                    redoStack = [];
                }
                updateUndoRedoButtons();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º workflow –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
                loadWorkflowState();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã
                loadPrompts();
                
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –Ω–∞ –±–ª–æ–∫–∞—Ö –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ workflow
                const container = getWorkflowContainer();
                if (container && workflowMode) {
                    setTimeout(() => scrollToBlocks(), 50);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —è–∑—ã–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                setTimeout(() => {
                    if (window.detectAndUpdateLanguageFromTab) {
                        window.detectAndUpdateLanguageFromTab();
                    }
                }, 50);
                
                // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–∏ –ø—É—Å—Ç–∞ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
                if (undoStack.length === 0) {
                    setTimeout(() => {
                        const initialState = captureCurrentTabState();
                        undoStack.push(initialState);
                        tabHistories[newTab] = {
                            undoStack: [...undoStack],
                            redoStack: [...redoStack]
                        };
                        updateUndoRedoButtons();
                    }, 100);
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
            updateSelectedUI();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            if (!btn._tabSelectorInitialized) {
                btn._tabSelectorInitialized = true;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    toggleMenu();
                });
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ shift+click
                btn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–µ–Ω—é
                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target)) {
                        closeMenu();
                    }
                });
            }
            
            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
            window.updateTabSelectorUI = updateSelectedUI;
            window.switchToTab = switchToTab;
        }
        
        // --- –ü–ê–ù–ï–õ–¨ –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
        
        let activeTextarea = null; // –¢–µ–∫—É—â–µ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ textarea –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SVG –∏–∫–æ–Ω–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        function getInstructionIconSvg(iconType) {
            const icons = {
                info: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                edit: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>`,
                paperclip: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>`,
                warning: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`,
                refresh: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>`
            };
            return icons[iconType] || icons.info;
        }
        
        function toggleEditToolbar(show) {
            const toolbar = document.getElementById('edit-toolbar');
            if (toolbar) {
                if (show) {
                    toolbar.classList.remove('hidden');
                } else {
                    toolbar.classList.add('hidden');
                }
            }
        }
        
        function showPromptTools() {
            document.getElementById('prompt-tools')?.classList.remove('hidden');
        }
        
        // –í—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ textarea —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π undo
        function insertTextIntoTextarea(textarea, text, triggerBlur = false) {
            if (!textarea) return;
            
            textarea.focus();
            
            const success = document.execCommand('insertText', false, text);
            
            if (!success) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;
                
                textarea.value = value.substring(0, start) + text + value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + text.length;
            }
            
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            if (triggerBlur) {
                textarea.dispatchEvent(new Event('blur', { bubbles: true }));
            }
        }
        
        function insertTextAtCursor(text) {
            if (!activeTextarea) return;
            insertTextIntoTextarea(activeTextarea, text);
        }
        
        // –í—Å—Ç–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —è–∑—ã–∫–∞ –≤ textarea –±–ª–æ–∫–∞
        function insertLanguageFormAtCursor(textarea) {
            const langData = LANGUAGES[currentLanguage];
            if (!langData) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º—ã
            showLanguageFormMenu(textarea, langData);
        }
        
        // –ù–∞–∑–≤–∞–Ω–∏—è —Ñ–æ—Ä–º —è–∑—ã–∫–∞ –¥–ª—è –º–µ–Ω—é (–≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –º–æ–¥–∞–ª–∫–∏)
        
        // –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º—ã —è–∑—ã–∫–∞ –¥–ª—è –±–ª–æ–∫–∞
        function showLanguageFormMenu(textarea, langData) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é –µ—Å–ª–∏ –µ—Å—Ç—å
            document.querySelectorAll('.workflow-lang-menu').forEach(m => m.remove());
            
            const isDark = document.body.classList.contains('dark');
            
            const menu = document.createElement('div');
            menu.className = 'workflow-lang-menu' + (isDark ? ' dark-menu' : '');
            menu.style.cssText = 'position: fixed; z-index: 10000; padding: 4px 0; max-height: 300px; overflow-y: auto; min-width: 200px;';
            
            for (const [key, label] of Object.entries(LANG_FORM_LABELS_GLOBAL)) {
                const value = langData[key];
                if (value) {
                    const option = document.createElement('div');
                    option.className = 'workflow-lang-option';
                    option.style.cssText = 'padding: 8px 16px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; gap: 12px;';
                    option.innerHTML = `
                        <span style="color: var(--claude-primary); font-weight: 500;">${value}</span>
                        <span class="workflow-lang-label" style="font-size: 11px;">${label}</span>
                    `;
                    option.addEventListener('click', () => {
                        insertTextIntoTextarea(textarea, value, true);
                        menu.remove();
                    });
                    menu.appendChild(option);
                }
            }
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é –≤–æ–∑–ª–µ –∫–Ω–æ–ø–∫–∏ –Ø–∑—ã–∫ –≤ –º–æ–¥–∞–ª–∫–µ
            const langBtn = document.getElementById('modal-lang-btn');
            if (langBtn) {
                const rect = langBtn.getBoundingClientRect();
                menu.style.left = rect.left + 'px';
                menu.style.top = (rect.bottom + 4) + 'px';
            } else {
                // Fallback - –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –≤–æ–∑–ª–µ textarea
                const rect = textarea.getBoundingClientRect();
                menu.style.left = rect.left + 'px';
                menu.style.top = (rect.top + 30) + 'px';
            }
            
            document.body.appendChild(menu);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }
        
        // --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø –í–ö–õ–ê–î–û–ö ---
        
        // showAddTabModal, hideAddTabModal ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ tabs.js
        
        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —è–∑—ã–∫–∞
         */
        function initLanguageSelector() {
            const dropdown = document.getElementById('language-dropdown');
            const btn = document.getElementById('language-btn');
            const btnText = document.getElementById('language-btn-text');
            const menu = document.getElementById('language-menu');
            const options = document.querySelectorAll('.language-option');
            
            // –ú–∞–ø–ø–∏–Ω–≥ –∑–Ω–∞—á–µ–Ω–∏–π –∫ —Ç–µ–∫—Å—Ç–∞–º
            const langTexts = {
                'at': 'AT –ê–≤—Å—Ç—Ä–∏—è/–ù–µ–º–µ—Ü–∫–∏–π',
                'bg': 'BG –ë–æ–ª–≥–∞—Ä—Å–∫–∏–π',
                'ca-en': 'CA-EN –ö–∞–Ω–∞–¥–∞/–ê–Ω–≥–ª–∏–π—Å–∫–∏–π',
                'ca-fr': 'CA-FR –ö–∞–Ω–∞–¥–∞/–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π',
                'ch-de': 'CH-DE –®–≤–µ–π—Ü–∞—Ä–∏—è/–ù–µ–º–µ—Ü–∫–∏–π',
                'ch-fr': 'CH-FR –®–≤–µ–π—Ü–∞—Ä–∏—è/–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π',
                'cz': 'CZ –ß–µ—à—Å–∫–∏–π',
                'de': 'DE –ù–µ–º–µ—Ü–∫–∏–π',
                'dk': 'DK –î–∞—Ç—Å–∫–∏–π',
                'en': 'EN –ê–Ω–≥–ª–∏–π—Å–∫–∏–π',
                'es': 'ES –ò—Å–ø–∞–Ω—Å–∫–∏–π',
                'fi': 'FI –§–∏–Ω—Å–∫–∏–π',
                'fr': 'FR –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π',
                'gr': 'GR –ì—Ä–µ—á–µ—Å–∫–∏–π',
                'hr': 'HR –•–æ—Ä–≤–∞—Ç—Å–∫–∏–π',
                'hu': 'HU –í–µ–Ω–≥–µ—Ä—Å–∫–∏–π',
                'it': 'IT –ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π',
                'nl': 'NL –ì–æ–ª–ª–∞–Ω–¥—Å–∫–∏–π',
                'no': 'NO –ù–æ—Ä–≤–µ–∂—Å–∫–∏–π',
                'nz': 'NZ –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è/–ê–Ω–≥–ª–∏–π—Å–∫–∏–π',
                'pl': 'PL –ü–æ–ª—å—Å–∫–∏–π',
                'pt': 'PT –ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π',
                'ro': 'RO –†—É–º—ã–Ω—Å–∫–∏–π',
                'se': 'SE –®–≤–µ–¥—Å–∫–∏–π',
                'sk': 'SK –°–ª–æ–≤–∞—Ü–∫–∏–π',
                'sl': 'SL –°–ª–æ–≤–µ–Ω—Å–∫–∏–π'
            };
            
            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ UI
            function updateSelectedUI(langCode) {
                btnText.textContent = langTexts[langCode] || langTexts['en'];
                options.forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.value === langCode);
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–Ω—é
            function toggleMenu() {
                const isOpen = !menu.classList.contains('hidden');
                if (isOpen) {
                    menu.classList.add('hidden');
                    dropdown.classList.remove('open');
                } else {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –≤–∫–ª–∞–¥–æ–∫ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
                    const tabMenu = document.getElementById('tab-menu');
                    const tabDropdown = document.getElementById('tab-dropdown');
                    if (tabMenu && !tabMenu.classList.contains('hidden')) {
                        tabMenu.classList.add('hidden');
                        tabDropdown?.classList.remove('open');
                    }
                    
                    menu.classList.remove('hidden');
                    dropdown.classList.add('open');
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
            function closeMenu() {
                menu.classList.add('hidden');
                dropdown.classList.remove('open');
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ (—Ä–µ–∞–ª—å–Ω—ã–π —è–∑—ã–∫ –≤ —Ç–µ–∫—Å—Ç–µ)
            const textLang = detectLanguageFromText();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —è–∑—ã–∫ –≤ localStorage
            const savedLang = localStorage.getItem(STORAGE_KEYS.LANGUAGE);
            
            if (savedLang && LANGUAGES[savedLang]) {
                // –ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —è–∑—ã–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                currentLanguage = savedLang;
                updateSelectedUI(savedLang);
            } else {
                // –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑ —Ç–µ–∫—Å—Ç–∞
                currentLanguage = textLang;
                updateSelectedUI(textLang);
                localStorage.setItem(STORAGE_KEYS.LANGUAGE, textLang);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                toggleMenu();
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ shift+click
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –æ–ø—Ü–∏—é
            options.forEach(option => {
                option.addEventListener('click', () => {
                    const newLang = option.dataset.value;
                    
                    if (currentLanguage === newLang) {
                        closeMenu();
                        return;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —è–∑—ã–∫ –î–û –Ω–∞—á–∞–ª–∞ –∑–∞–º–µ–Ω—ã
                    const oldLang = currentLanguage;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateSelectedUI(newLang);
                    closeMenu();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫–∏
                    const items = getTabItems(currentTab);
                    let changed = false;
                    
                    items.forEach(item => {
                        if (item.type === 'block' && item.content) {
                            const blockLang = detectLanguageInText(item.content) || oldLang;
                            if (blockLang !== newLang) {
                                item.content = replaceLanguage(item.content, blockLang, newLang);
                                changed = true;
                            }
                        }
                    });
                    
                    if (changed) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const allTabs = getAllTabs();
                        allTabs[currentTab].items = items;
                        saveAllTabs(allTabs);
                        
                        // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞–µ–º workflow
                        renderWorkflow();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º currentLanguage –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã
                    currentLanguage = newLang;
                    localStorage.setItem(STORAGE_KEYS.LANGUAGE, newLang);
                    
                    showLanguageToast(LANGUAGES[newLang].name);
                });
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–µ–Ω—é
            let isDraggingScrollbar = false;
            
            document.addEventListener('click', (e) => {
                if (isDraggingScrollbar) {
                    isDraggingScrollbar = false;
                    return;
                }
                if (!dropdown.contains(e.target)) {
                    closeMenu();
                }
            });
            
            // –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –º–µ–Ω—é
            const scrollbar = document.getElementById('lang-scrollbar');
            const menuInner = document.getElementById('language-menu-inner');
            const thumb = scrollbar.querySelector('.lang-menu-scrollbar-thumb');
            
            function updateMenuScrollbar() {
                const scrollHeight = menuInner.scrollHeight;
                const clientHeight = menuInner.clientHeight;
                const trackHeight = scrollbar.clientHeight;
                
                if (scrollHeight <= clientHeight) {
                    scrollbar.style.opacity = '0';
                    return;
                }
                scrollbar.style.opacity = '1';
                
                const thumbHeight = Math.max(20, (clientHeight / scrollHeight) * trackHeight);
                const maxScroll = scrollHeight - clientHeight;
                const scrollPercent = menuInner.scrollTop / maxScroll;
                const thumbTop = scrollPercent * (trackHeight - thumbHeight);
                
                thumb.style.height = thumbHeight + 'px';
                thumb.style.top = thumbTop + 'px';
            }
            
            menuInner.addEventListener('scroll', updateMenuScrollbar);
            
            // Drag functionality –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞
            let isDragging = false;
            let startY = 0;
            let startScrollTop = 0;
            
            thumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                isDraggingScrollbar = true;
                startY = e.clientY;
                startScrollTop = menuInner.scrollTop;
                thumb.classList.add('dragging');
                e.preventDefault();
                e.stopPropagation();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaY = e.clientY - startY;
                const trackHeight = scrollbar.clientHeight;
                const thumbHeight = thumb.clientHeight;
                const scrollHeight = menuInner.scrollHeight;
                const clientHeight = menuInner.clientHeight;
                const maxScroll = scrollHeight - clientHeight;
                
                const scrollRatio = maxScroll / (trackHeight - thumbHeight);
                menuInner.scrollTop = startScrollTop + deltaY * scrollRatio;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    thumb.classList.remove('dragging');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã click –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
                    setTimeout(() => {
                        isDraggingScrollbar = false;
                    }, 10);
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é
            const origToggle = toggleMenu;
            toggleMenu = function() {
                const wasHidden = menu.classList.contains('hidden');
                origToggle();
                if (wasHidden) {
                    setTimeout(updateMenuScrollbar, 10);
                }
            };
            
            // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –∏–∑ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
            function detectAndUpdateLanguageFromTab() {
                const blocks = getTabBlocks(currentTab);
                
                if (blocks.length === 0) {
                    // –ù–µ—Ç –±–ª–æ–∫–æ–≤ - —Å—Ç–∞–≤–∏–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    currentLanguage = 'en';
                    updateSelectedUI('en');
                    localStorage.setItem(STORAGE_KEYS.LANGUAGE, 'en');
                    return;
                }
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã —è–∑—ã–∫–æ–≤ –∏–∑ LANGUAGES
                const allLanguageForms = new Set();
                for (const lang of Object.values(LANGUAGES)) {
                    if (lang.name) allLanguageForms.add(lang.name);
                    if (lang.genitive) allLanguageForms.add(lang.genitive);
                    if (lang.prepositional) allLanguageForms.add(lang.prepositional);
                    if (lang.adjective) allLanguageForms.add(lang.adjective);
                    if (lang.segmentAudience) allLanguageForms.add(lang.segmentAudience);
                    if (lang.segment) allLanguageForms.add(lang.segment);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–∑—ã–∫ –≤ –∫–∞–∂–¥–æ–º –±–ª–æ–∫–µ
                const blockLanguages = [];
                const problematicBlocks = [];
                
                for (const block of blocks) {
                    if (!block.content) continue;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –±–ª–æ–∫–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã —è–∑—ã–∫–æ–≤
                    const contentLower = block.content.toLowerCase();
                    const hasLanguageForms = [...allLanguageForms].some(form => 
                        contentLower.includes(form.toLowerCase())
                    );
                    
                    if (!hasLanguageForms) {
                        // –ë–ª–æ–∫ –±–µ–∑ —è–∑—ã–∫–æ–≤—ã—Ö —Ñ–æ—Ä–º - –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                        continue;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —è–∑—ã–∫–æ–≤ –í–ù–£–¢–†–ò –±–ª–æ–∫–∞
                    const allLangsInBlock = detectAllLanguagesInText(block.content);
                    if (allLangsInBlock.length > 1) {
                        // –í –æ–¥–Ω–æ–º –±–ª–æ–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤ - —ç—Ç–æ –æ—à–∏–±–∫–∞
                        problematicBlocks.push(block.title || `–ë–ª–æ–∫ ${block.number}`);
                        continue;
                    }
                    
                    const lang = detectLanguageInText(block.content);
                    if (lang) {
                        blockLanguages.push({ block, lang });
                    } else {
                        // –ï—Å—Ç—å —Ñ–æ—Ä–º—ã —è–∑—ã–∫–æ–≤, –Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —è–∑—ã–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω - —ç—Ç–æ –æ—à–∏–±–∫–∞
                        problematicBlocks.push(block.title || `–ë–ª–æ–∫ ${block.number}`);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —è–∑—ã–∫–æ–≤
                const uniqueLangs = [...new Set(blockLanguages.map(b => b.lang))];
                
                if (uniqueLangs.length === 0 && problematicBlocks.length === 0) {
                    // –ù–µ—Ç –±–ª–æ–∫–æ–≤ —Å —è–∑—ã–∫–æ–≤—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏ - —Å—Ç–∞–≤–∏–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    currentLanguage = 'en';
                    updateSelectedUI('en');
                    localStorage.setItem(STORAGE_KEYS.LANGUAGE, 'en');
                    return;
                }
                
                if (uniqueLangs.length === 0 && problematicBlocks.length > 0) {
                    // –ï—Å—Ç—å —Ñ–æ—Ä–º—ã, –Ω–æ —è–∑—ã–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ
                    showToast(`–û—à–∏–±–∫–∞ —è–∑—ã–∫–∞ –≤: ${problematicBlocks.join(', ')}`, 4000);
                    currentLanguage = 'en';
                    updateSelectedUI('en');
                    return;
                }
                
                if (uniqueLangs.length > 1) {
                    // –†–∞–∑–Ω—ã–µ —è–∑—ã–∫–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –±–ª–æ–∫–∞—Ö
                    const mainLang = uniqueLangs[0];
                    const conflictBlocks = blockLanguages
                        .filter(b => b.lang !== mainLang)
                        .map(b => b.block.title || `–ë–ª–æ–∫ ${b.block.number}`);
                    
                    showToast(`–ö–æ–Ω—Ñ–ª–∏–∫—Ç —è–∑—ã–∫–æ–≤ –≤: ${conflictBlocks.join(', ')}`, 4000);
                }
                
                if (problematicBlocks.length > 0) {
                    showToast(`–û—à–∏–±–∫–∞ —è–∑—ã–∫–∞ –≤: ${problematicBlocks.join(', ')}`, 4000);
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π —è–∑—ã–∫
                const detectedLang = uniqueLangs[0];
                currentLanguage = detectedLang;
                updateSelectedUI(detectedLang);
                localStorage.setItem(STORAGE_KEYS.LANGUAGE, detectedLang);
            }
            
            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏
            window.detectAndUpdateLanguageFromTab = detectAndUpdateLanguageFromTab;
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞
         */
        function showLanguageToast(langName) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                –Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω: ${langName}
            `;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
                toast.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä
                `;
            }, 2500);
        }



        
        
        // blockScripts, collapsedBlocks ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ blocks.js
        // loadCollapsedBlocks, saveCollapsedBlocks, isBlockCollapsed ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ blocks.js
        
        function toggleBlockCollapsed(blockId) {
            if (collapsedBlocks[blockId]) {
                delete collapsedBlocks[blockId];
            } else {
                collapsedBlocks[blockId] = true;
            }
            saveCollapsedBlocks();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç—É –Ω–æ–¥—É –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞
            const node = document.querySelector(`.workflow-node[data-block-id="${blockId}"]`);
            if (node) {
                const isNowCollapsed = !!collapsedBlocks[blockId];
                node.classList.toggle('collapsed', isNowCollapsed);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏
                const btn = node.querySelector('.workflow-collapse-btn');
                if (btn) {
                    btn.innerHTML = isNowCollapsed ? SVG_ICONS.chevronDown : SVG_ICONS.chevronUp;
                }
                
                // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–æ–π —Ñ–∞–π–ª–æ–≤ –≤ —Ö–µ–¥–µ—Ä–µ
                const header = node.querySelector('.workflow-node-header');
                const existingFilesBtn = header?.querySelector('.collapsed-files-btn');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º hasAttachments —É –±–ª–æ–∫–∞
                const allTabs = getAllTabs();
                const items = allTabs[currentTab]?.items || [];
                const block = items.find(item => item.type === 'block' && item.id === blockId);
                const hasAttachments = block?.hasAttachments;
                
                if (isNowCollapsed && hasAttachments && !existingFilesBtn) {
                    // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∏ –µ—Å—Ç—å hasAttachments ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                    const filesCount = blockAttachments[blockId]?.length || 0;
                    const filesBtn = document.createElement('button');
                    filesBtn.className = 'collapsed-files-btn';
                    filesBtn.dataset.blockId = blockId;
                    filesBtn.title = filesCount > 0 ? '–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã' : '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã';
                    filesBtn.innerHTML = filesCount > 0 
                        ? `<span class="files-count">${filesCount}</span>` 
                        : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>`;
                    
                    filesBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (blockAttachments[blockId] && blockAttachments[blockId].length > 0) {
                            clearBlockAttachments(blockId);
                        } else {
                            attachFilesToBlock(blockId);
                        }
                    });
                    filesBtn.addEventListener('mousedown', (e) => e.stopPropagation());
                    
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ collapse (–∏–ª–∏ –≤ –Ω–∞—á–∞–ª–æ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç)
                    const collapseBtn = header.querySelector('.workflow-collapse-btn');
                    if (collapseBtn) {
                        collapseBtn.after(filesBtn);
                    } else {
                        header.prepend(filesBtn);
                    }
                } else if (!isNowCollapsed && existingFilesBtn) {
                    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º ‚Äî —É–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                    existingFilesBtn.remove();
                }
                
                // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ collapsed –±–ª–æ–∫–∞ –ø–æ –Ω–µ—á—ë—Ç–Ω–æ–π —Å–µ—Ç–∫–µ
                if (isNowCollapsed) {
                    // –£–±–∏—Ä–∞–µ–º inline height —á—Ç–æ–±—ã CSS –º–æ–≥ —Ä–∞–±–æ—Ç–∞—Ç—å
                    node.style.height = '';
                    // –î–∞—ë–º DOM –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                    requestAnimationFrame(() => {
                        alignCollapsedToOddGrid(node, blockId);
                        renderConnections();
                    });
                } else {
                    // –ü—Ä–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
                    const size = workflowSizes[blockId];
                    node.style.width = (size && size.width) ? size.width + 'px' : NODE_DEFAULT_WIDTH + 'px';
                    if (size && size.height) {
                        node.style.height = size.height + 'px';
                    }
                    renderConnections();
                }
            }
        }
        
        // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ collapsed –±–ª–æ–∫–∞ –ø–æ —á—ë—Ç–Ω–æ–π —Å–µ—Ç–∫–µ (–¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è)
        function alignCollapsedToOddGrid(node, blockId) {
            const gridSize = 40;
            const title = node.querySelector('.workflow-node-title');
            if (!title) return;
            
            // –£–±–∏—Ä–∞–µ–º inline height –∏ width –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è
            node.style.height = '';
            node.style.width = '';
            
            // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
            const measure = document.createElement('span');
            measure.style.cssText = 'position: absolute; visibility: hidden; white-space: nowrap; font-weight: 600; font-size: 26px;';
            measure.textContent = title.textContent;
            document.body.appendChild(measure);
            const titleWidth = measure.offsetWidth;
            document.body.removeChild(measure);
            
            // –ò–∑–º–µ—Ä—è–µ–º —à–∏—Ä–∏–Ω—É badges
            const badgesContainer = node.querySelector('.script-badges');
            let badgesWidth = 0;
            if (badgesContainer && badgesContainer.children.length > 0) {
                badgesWidth = badgesContainer.offsetWidth + 14; // + gap –º–µ–∂–¥—É title –∏ badges
            }
            
            // –ò–∑–º–µ—Ä—è–µ–º —à–∏—Ä–∏–Ω—É –∫–Ω–æ–ø–∫–∏ —Ñ–∞–π–ª–æ–≤
            const filesBtn = node.querySelector('.collapsed-files-btn');
            let filesBtnWidth = 0;
            if (filesBtn) {
                filesBtnWidth = 40 + 14; // 40px –∫–Ω–æ–ø–∫–∞ + 14px gap
            }
            
            // padding —Ö–µ–¥–µ—Ä–∞ 22px * 2 = 44px
            const headerPadding = 44;
            const contentWidth = titleWidth + badgesWidth + filesBtnWidth + headerPadding;
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ß–Å–¢–ù–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤
            let steps = Math.ceil(contentWidth / gridSize);
            if (steps < 2) steps = 2;
            // –î–µ–ª–∞–µ–º —á—ë—Ç–Ω—ã–º - –µ—Å–ª–∏ –Ω–µ—á—ë—Ç–Ω–æ–µ, –¥–æ–±–∞–≤–ª—è–µ–º 1
            if (steps % 2 !== 0) steps += 1;
            const alignedWidth = steps * gridSize;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É
            node.style.width = alignedWidth + 'px';
            
            // –¢–∞–∫–∂–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ —Å–µ—Ç–∫–µ
            const currentX = parseFloat(node.style.left) || 0;
            const alignedX = Math.round(currentX / gridSize) * gridSize;
            node.style.left = alignedX + 'px';
            workflowPositions[blockId] = { 
                x: alignedX, 
                y: parseFloat(node.style.top) || 0 
            };
            
            saveWorkflowState(true);
        }
        
        // isBlockCollapsed ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ blocks.js
        // loadBlockScripts, saveBlockScripts, hasBlockScript, getBlockScripts ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ blocks.js
        
        function toggleBlockScript(blockId, scriptKey) {
            if (!blockScripts[blockId]) blockScripts[blockId] = [];
            const idx = blockScripts[blockId].indexOf(scriptKey);
            if (idx >= 0) {
                blockScripts[blockId].splice(idx, 1);
            } else {
                blockScripts[blockId].push(scriptKey);
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —á—Ç–æ–±—ã C –±—ã–ª –ø–µ—Ä–µ–¥ W (convert –ø–µ—Ä–µ–¥ count)
                blockScripts[blockId].sort((a, b) => a === 'convert' ? -1 : 1);
            }
            if (blockScripts[blockId].length === 0) delete blockScripts[blockId];
            saveBlockScripts();
            updateBlockScriptBadges(blockId);
        }
        
        // hasBlockScript, getBlockScripts ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ blocks.js
        
        function updateBlockScriptBadges(blockId) {
            const node = document.querySelector(`.workflow-node[data-block-id="${blockId}"]`);
            if (!node) return;
            
            const badgesContainer = node.querySelector('.script-badges');
            if (!badgesContainer) return;
            
            const scripts = getBlockScripts(blockId);
            const automation = getBlockAutomationFlags(blockId);
            
            // –°–æ–±–∏—Ä–∞–µ–º HTML –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤
            let badgesHtml = scripts.map(s => 
                `<span class="script-badge" data-script="${s}" title="${EMBEDDED_SCRIPTS[s]?.label || s}">${EMBEDDED_SCRIPTS[s]?.badge || s[0].toUpperCase()}</span>`
            ).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º automation badges
            if (automation.newProject) {
                badgesHtml += `<span class="automation-badge" data-automation="newProject" title="–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç">P</span>`;
            }
            if (automation.newChat) {
                badgesHtml += `<span class="automation-badge" data-automation="newChat" title="–ù–æ–≤—ã–π —á–∞—Ç">N</span>`;
            }
            
            badgesContainer.innerHTML = badgesHtml;
            
            // –ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤
            badgesContainer.querySelectorAll('.script-badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBlockScript(blockId, badge.dataset.script);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è automation
            badgesContainer.querySelectorAll('.automation-badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBlockAutomation(blockId, badge.dataset.automation);
                });
            });
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –µ—Å–ª–∏ –±–ª–æ–∫ —Å–≤—ë—Ä–Ω—É—Ç
            if (isBlockCollapsed(blockId)) {
                alignCollapsedToOddGrid(node, blockId);
                renderConnections();
            }
        }
        
        // blockAutomation ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ blocks.js
        // loadBlockAutomation, saveBlockAutomation, hasBlockAutomation, getBlockAutomationFlags ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ blocks.js
        
        function toggleBlockAutomation(blockId, flag) {
            if (!blockAutomation[blockId]) blockAutomation[blockId] = {};
            
            if (blockAutomation[blockId][flag]) {
                delete blockAutomation[blockId][flag];
            } else {
                blockAutomation[blockId][flag] = true;
            }
            
            // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ –≤—Å–µ —Ñ–ª–∞–≥–∏ —Å–Ω—è—Ç—ã
            if (Object.keys(blockAutomation[blockId]).length === 0) {
                delete blockAutomation[blockId];
            }
            
            saveBlockAutomation();
            updateBlockAutomationBadges(blockId);
        }
        
        // hasBlockAutomation, getBlockAutomationFlags ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ blocks.js
        
        function updateBlockAutomationBadges(blockId) {
            const node = document.querySelector(`.workflow-node[data-block-id="${blockId}"]`);
            if (!node) return;
            
            const badgesContainer = node.querySelector('.script-badges');
            if (!badgesContainer) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã
            const scripts = getBlockScripts(blockId);
            const automation = getBlockAutomationFlags(blockId);
            
            // –°–æ–±–∏—Ä–∞–µ–º HTML –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤
            let badgesHtml = scripts.map(s => 
                `<span class="script-badge" data-script="${s}" title="${EMBEDDED_SCRIPTS[s]?.label || s}">${EMBEDDED_SCRIPTS[s]?.badge || s[0].toUpperCase()}</span>`
            ).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º automation badges
            if (automation.newProject) {
                badgesHtml += `<span class="automation-badge" data-automation="newProject" title="–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç">P</span>`;
            }
            if (automation.newChat) {
                badgesHtml += `<span class="automation-badge" data-automation="newChat" title="–ù–æ–≤—ã–π —á–∞—Ç">N</span>`;
            }
            
            badgesContainer.innerHTML = badgesHtml;
            
            // –ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤
            badgesContainer.querySelectorAll('.script-badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBlockScript(blockId, badge.dataset.script);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è automation
            badgesContainer.querySelectorAll('.automation-badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBlockAutomation(blockId, badge.dataset.automation);
                });
            });
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –µ—Å–ª–∏ –±–ª–æ–∫ —Å–≤—ë—Ä–Ω—É—Ç
            if (isBlockCollapsed(blockId)) {
                alignCollapsedToOddGrid(node, blockId);
                renderConnections();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        loadBlockScripts();
        loadCollapsedBlocks();
        loadBlockAutomation();
        
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Å—Å–∏–≤—ã –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–∫–ª–∞–¥–æ–∫
        function convertToTabStructure(id, name, order, blocks) {
            const items = [];
            
            blocks.forEach(b => {
                // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID –µ—Å–ª–∏ –µ—Å—Ç—å)
                const block = {
                    type: 'block',
                    id: b.id || generateItemId(),
                    title: b.title,
                    content: b.content || '',
                    instruction: b.instruction ? b.instruction : (b.note ? { type: "info", text: b.note } : null)
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º hasAttachments –µ—Å–ª–∏ –µ—Å—Ç—å
                if (b.hasAttachments) {
                    block.hasAttachments = true;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º scripts –≤ blockScripts –µ—Å–ª–∏ –µ—Å—Ç—å
                if (b.scripts && b.scripts.length > 0) {
                    b.scripts.forEach(scriptKey => {
                        if (!hasBlockScript(block.id, scriptKey)) {
                            toggleBlockScript(block.id, scriptKey);
                        }
                    });
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º collapsed –µ—Å–ª–∏ –µ—Å—Ç—å
                if (b.collapsed) {
                    collapsedBlocks[block.id] = true;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º automation –µ—Å–ª–∏ –µ—Å—Ç—å
                if (b.automation) {
                    blockAutomation[block.id] = { ...b.automation };
                }
                
                items.push(block);
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º collapsed –∏ automation –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
            saveCollapsedBlocks();
            saveBlockAutomation();
            
            return {
                id,
                name,
                order,
                items
            };
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (–∑–∞–≥—Ä—É–∑–∫–∞ —Å GitHub)
        async function initializeDefaultTabs() {
            // –î–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (localStorage.getItem(STORAGE_KEYS.TABS)) {
                return;
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å GitHub
            if (typeof initializeRemotePrompts === 'function') {
                try {
                    const result = await initializeRemotePrompts();
                    if (result.success) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É "–ü—Ä–æ–º–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
                        if (typeof showPromptsReleaseNotes === 'function' && result.tabs) {
                            showPromptsReleaseNotes(result.tabs, [], result.releaseNotes);
                        }
                        return;
                    }
                } catch (e) {
                    console.error('[Init] Failed to load remote prompts:', e);
                }
            }
            
            // Fallback: —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –≤–∫–ª–∞–¥–∫—É
            const defaultTabs = {
                'default': {
                    name: 'DEFAULT',
                    order: 1,
                    items: [{
                        id: 'item_fallback_1',
                        number: '1',
                        title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å',
                        content: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.'
                    }]
                }
            };
            
            saveAllTabs(defaultTabs, true);
        }
        


        // --- –û–ü–ï–†–ê–¶–ò–ò –° LOCAL STORAGE ---

        /**
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª—é—á localStorage –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
         */
        function getCurrentStorageKey() {
            return STORAGE_KEYS.promptsData(currentTab);
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–º–ø—Ç–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
         * @param {string} number - –ù–æ–º–µ—Ä —Å–µ–∫—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ (–æ—Ç 1 –¥–æ 10).
         * @param {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
         */
        function saveToLocalStorage(key, content) {
            // –ù–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ undo –≤–æ –≤—Ä–µ–º—è undo/redo –æ–ø–µ—Ä–∞—Ü–∏–π
            if (isUndoRedoAction) return;
            
            try {
                const storageKey = getCurrentStorageKey();
                const storedData = JSON.parse(localStorage.getItem(storageKey) || '{}');
                storedData[key] = content;
                localStorage.setItem(storageKey, JSON.stringify(storedData));
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Ä—Å–∏—é –¥–∞–Ω–Ω—ã—Ö
                localStorage.setItem(STORAGE_KEYS.DATA_VERSION, CURRENT_DATA_VERSION.toString());
                autoSaveToUndo();
            } catch (e) {
                
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–º–ø—Ç—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
         * @returns {Object} –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–ª–∏ –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç.
         */
        function loadFromLocalStorage() {
            try {
                const storageKey = getCurrentStorageKey();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –¥–∞–Ω–Ω—ã—Ö
                const savedVersion = parseInt(localStorage.getItem(STORAGE_KEYS.DATA_VERSION) || '0');
                if (savedVersion < CURRENT_DATA_VERSION) {
                    // –í–µ—Ä—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞ - –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                    localStorage.removeItem(STORAGE_KEYS.LANGUAGE);
                    localStorage.setItem(STORAGE_KEYS.DATA_VERSION, CURRENT_DATA_VERSION.toString());
                    return {};
                }
                return JSON.parse(localStorage.getItem(storageKey) || '{}');
            } catch (e) {
                
                return {};
            }
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
         */
        async function checkAppVersionAndReset() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ Tauri
                const currentAppVersion = await getAppVersion();
                
                const savedAppVersion = localStorage.getItem(STORAGE_KEYS.APP_VERSION) || '0.3.0';
                
                // –°–±—Ä–æ—Å –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (–ª—é–±–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: –º–∞–∂–æ—Ä, –º–∏–Ω–æ—Ä –∏–ª–∏ –ø–∞—Ç—á)
                const needsReset = currentAppVersion !== savedAppVersion;
                
                if (needsReset && savedAppVersion !== '0.3.0') {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–æ–∫
                    localStorage.removeItem(STORAGE_KEYS.TABS);
                    // –û—á–∏—Å—Ç–∫–∞ legacy –∫–ª—é—á–µ–π (v3.x)
                    localStorage.removeItem('ai-prompts-manager-data');
                    localStorage.removeItem('ai-prompts-manager-data-task4');
                    // –ù–ï —Ç—Ä–æ–≥–∞–µ–º: STORAGE_KEYS.SETTINGS (—Ç–µ–º–∞, –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ), —è–∑—ã–∫
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
                if (currentAppVersion !== '0.3.0') {
                    localStorage.setItem(STORAGE_KEYS.APP_VERSION, currentAppVersion);
                }
                
            } catch (e) {
                
            }
        }


        // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ò ---

        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–º–ø—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É—è –∞–∫—Ç–∏–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º (—Ç–æ–ª—å–∫–æ LocalStorage).
         * @param {string} key - ID –±–ª–æ–∫–∞ –∏–ª–∏ –Ω–æ–º–µ—Ä —Å–µ–∫—Ü–∏–∏ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏).
         * @param {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
         */
        const savePrompt = debounce((key, content) => {
            saveToLocalStorage(key, content);
        }, 800); 

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ LocalStorage).
         */
        async function initializePersistence() {
            await checkAppVersionAndReset(); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –∏ —Å–±—Ä–æ—Å –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        }

        /**
         * –°–æ–∑–¥–∞–µ—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å.
         * @param {string} text - –¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ.
         * @param {boolean} isTop - –ï—Å–ª–∏ true, —É–º–µ–Ω—å—à–∞–µ—Ç –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø.
         * @returns {HTMLDivElement} –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–∫–∏.
         */
        
        /**
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
         */
        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–º–ø—Ç—ã, —Ä–µ–Ω–¥–µ—Ä–∏—Ç UI –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
         */
        function loadPrompts(preserveScroll = null) {
            const loadingOverlay = document.getElementById('loading-overlay');
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ edit mode —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª
            const shouldPreserveScroll = preserveScroll !== null ? preserveScroll : isEditMode;

            // –°–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
            loadingOverlay.classList.add('hidden');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º workflow
            loadWorkflowState();
            renderWorkflow(shouldPreserveScroll);
        }
        
        // --- UI –£–¢–ò–õ–ò–¢–´ –ò –†–ï–ù–î–ï–†–ò–ù–ì ---

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
         * @param {HTMLElement} scrollable - —ç–ª–µ–º–µ–Ω—Ç —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º
         * @param {HTMLElement} scrollbar - —ç–ª–µ–º–µ–Ω—Ç —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞
         */
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–æ–≤
        let activeScrollbarData = null;

        function initCustomScrollbar(scrollable, scrollbar) {
            const thumb = scrollbar.querySelector('.custom-scrollbar-thumb') || scrollbar.querySelector('.main-scrollbar-thumb');
            
            function updateThumb() {
                const scrollHeight = scrollable.scrollHeight;
                const clientHeight = scrollable.clientHeight;
                const trackHeight = scrollbar.clientHeight;
                
                if (scrollHeight <= clientHeight) {
                    scrollbar.style.opacity = '0';
                    scrollbar.style.pointerEvents = 'none';
                    return;
                } else {
                    scrollbar.style.opacity = '1';
                    scrollbar.style.pointerEvents = 'auto';
                }
                
                const thumbHeight = Math.max(30, (clientHeight / scrollHeight) * trackHeight);
                const maxScroll = scrollHeight - clientHeight;
                const scrollPercent = scrollable.scrollTop / maxScroll;
                const thumbTop = scrollPercent * (trackHeight - thumbHeight);
                
                thumb.style.height = thumbHeight + 'px';
                thumb.style.top = thumbTop + 'px';
            }
            
            scrollable.addEventListener('scroll', updateThumb);
            
            const resizeObserver = new ResizeObserver(updateThumb);
            resizeObserver.observe(scrollable);
            
            thumb.addEventListener('mouseenter', () => {
                scrollbar.classList.add('active');
            });
            thumb.addEventListener('mouseleave', () => {
                if (!activeScrollbarData || !activeScrollbarData.isDragging || activeScrollbarData.scrollbar !== scrollbar) {
                    scrollbar.classList.remove('active');
                }
            });
            
            thumb.addEventListener('mousedown', (e) => {
                activeScrollbarData = {
                    isDragging: true,
                    scrollable,
                    scrollbar,
                    thumb,
                    startY: e.clientY,
                    startScrollTop: scrollable.scrollTop
                };
                thumb.classList.add('dragging');
                scrollbar.classList.add('active');
                e.preventDefault();
            });
            
            scrollbar.addEventListener('click', (e) => {
                if (e.target === thumb) return;
                
                const rect = scrollbar.getBoundingClientRect();
                const clickY = e.clientY - rect.top;
                const trackHeight = scrollbar.clientHeight;
                const scrollHeight = scrollable.scrollHeight;
                const clientHeight = scrollable.clientHeight;
                const scrollPercent = clickY / trackHeight;
                
                scrollable.scrollTop = scrollPercent * (scrollHeight - clientHeight);
            });
            
            setTimeout(updateThumb, 100);
        }

        // removeBlockInstruction, addBlockInstruction ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ blocks.js
        
        // –î–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –ø–∞–Ω–µ–ª—å —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±–ª–æ–∫–∞
        function toggleAttachmentsPanel(blockId, show) {
            const allTabs = getAllTabs();
            const items = allTabs[currentTab]?.items || [];
            
            // –ò—â–µ–º –±–ª–æ–∫ –ø–æ id
            const block = items.find(item => item.type === 'block' && item.id === blockId);
            if (!block) return;
            
            autoSaveToUndo();
            
            if (show) {
                block.hasAttachments = true;
            } else {
                delete block.hasAttachments;
                // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                delete blockAttachments[blockId];
            }
            
            saveAllTabs(allTabs);
            renderWorkflow(true);
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é
        window.toggleAttachmentsPanel = toggleAttachmentsPanel;
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É –±–ª–æ–∫–∞ –ø–∞–Ω–µ–ª—å —Ñ–∞–π–ª–æ–≤
        function hasBlockAttachmentsPanel(blockId) {
            const allTabs = getAllTabs();
            const items = allTabs[currentTab]?.items || [];
            const block = items.find(item => item.type === 'block' && item.id === blockId);
            return block?.hasAttachments || false;
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é
        window.hasBlockAttachmentsPanel = hasBlockAttachmentsPanel;

        /**
         * –°–æ–∑–¥–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ–º–ø—Ç–∞.
         * @param {Object} section - –û–±—ä–µ–∫—Ç —Å–µ–∫—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞.
         * @returns {HTMLDivElement} –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–º–ø—Ç–∞.
         */

        // ============================================
        // –ö–û–ù–°–¢–†–£–ö–¢–û–† –ü–û–õ–ï–ô –í–í–û–î–ê
        // ============================================
        
        let currentConstructorBlockNumber = null;
        
        function showInputConstructorModal(blockNumber) {
            currentConstructorBlockNumber = blockNumber;
            closeAllModals();
            
            const blocks = getTabBlocks(currentTab);
            const block = blocks.find(b => b.number === blockNumber);
            const instruction = block?.instruction;
            
            // –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É
            const currentIcon = instruction?.icon || 'info';
            document.querySelectorAll('#constructor-icon-selector .icon-option').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.icon === currentIcon);
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            const instructionTextInput = document.getElementById('constructor-instruction-text');
            instructionTextInput.value = instruction?.text || '';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
            const fieldsContainer = document.getElementById('constructor-fields');
            fieldsContainer.innerHTML = '';
            
            if (instruction?.fields && instruction.fields.length > 0) {
                instruction.fields.forEach((field, index) => {
                    addConstructorFieldElement(field, index);
                });
            }
            // –ï—Å–ª–∏ –ø–æ–ª–µ–π –Ω–µ—Ç - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç—ã–º
            updateAddFieldButton();
            
            document.getElementById('input-constructor-modal').classList.add('open');
            instructionTextInput.focus();
        }
        
        function hideInputConstructorModal() {
            document.getElementById('input-constructor-modal').classList.remove('open');
            currentConstructorBlockNumber = null;
        }
        
        function addConstructorFieldElement(fieldData = {}, index = null) {
            const container = document.getElementById('constructor-fields');
            if (index === null) {
                index = container.children.length;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 4 –ø–æ–ª—è
            if (index >= 4) {
                return;
            }
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'constructor-field bg-gray-50 rounded-lg p-3 border border-gray-200';
            fieldDiv.dataset.fieldIndex = index;
            
            // –ü–µ—Ä–≤–æ–µ –ø–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
            const optionalCheckbox = index === 0 ? '' : `
                    <label class="flex items-center gap-2 text-xs text-gray-600 cursor-pointer">
                        <input type="checkbox" class="field-optional rounded border-gray-300 text-claude-accent " ${fieldData.optional ? 'checked' : ''}>
                        <span>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ (–º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å)</span>
                    </label>`;
            
            fieldDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-medium text-gray-500">–ü–æ–ª–µ ${index + 1}</span>
                    <button type="button" class="remove-field-btn text-gray-400 hover:text-red-500 transition-colors" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="space-y-2">
                    <input type="text" class="field-label w-full px-3 py-1.5 text-sm border border-gray-200 rounded focus:outline-none" 
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ)" value="${escapeHtml(fieldData.label || '')}">
                    <input type="text" class="field-placeholder w-full px-3 py-1.5 text-sm border border-gray-200 rounded focus:outline-none" 
                           placeholder="example" value="${escapeHtml(fieldData.placeholder || '')}">
                    <input type="text" class="field-prefix w-full px-3 py-1.5 text-sm border border-gray-200 rounded focus:outline-none" 
                           placeholder="–§—Ä–∞–∑–∞ –ø–µ—Ä–µ–¥ –∑–∞–º–µ–Ω—è–µ–º—ã–º —Å–ª–æ–≤–æ–º" value="${escapeHtml(fieldData.prefix || '')}">
                    ${optionalCheckbox}
                </div>
            `;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—è
            fieldDiv.querySelector('.remove-field-btn').addEventListener('click', () => {
                fieldDiv.remove();
                reindexConstructorFields();
                updateAddFieldButton();
            });
            
            container.appendChild(fieldDiv);
            updateAddFieldButton();
        }
        
        function updateAddFieldButton() {
            const container = document.getElementById('constructor-fields');
            const addBtn = document.getElementById('add-constructor-field-btn');
            if (container.children.length >= 4) {
                addBtn.classList.add('hidden');
            } else {
                addBtn.classList.remove('hidden');
            }
        }
        
        function reindexConstructorFields() {
            const container = document.getElementById('constructor-fields');
            Array.from(container.children).forEach((field, index) => {
                field.dataset.fieldIndex = index;
                field.querySelector('.text-xs.font-medium').textContent = `–ü–æ–ª–µ ${index + 1}`;
                
                // –ü–µ—Ä–≤–æ–µ –ø–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
                const optionalCheckbox = field.querySelector('.field-optional');
                const optionalLabel = optionalCheckbox?.closest('label');
                
                if (index === 0 && optionalLabel) {
                    optionalLabel.remove();
                } else if (index > 0 && !optionalCheckbox) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    const spaceDiv = field.querySelector('.space-y-2');
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-2 text-xs text-gray-600 cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" class="field-optional rounded border-gray-300 text-claude-accent ">
                        <span>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ (–º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å)</span>
                    `;
                    spaceDiv.appendChild(label);
                }
            });
        }
        
        function saveConstructorFields() {
            if (!currentConstructorBlockNumber) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–∫–æ–Ω–∫—É
            const selectedIcon = document.querySelector('#constructor-icon-selector .icon-option.selected')?.dataset.icon || 'info';
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            const instructionText = document.getElementById('constructor-instruction-text').value.trim();
            if (!instructionText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–Ω–æ—Å–∫–∏');
                return;
            }
            
            const container = document.getElementById('constructor-fields');
            const fields = [];
            
            container.querySelectorAll('.constructor-field').forEach((fieldEl, idx) => {
                const label = fieldEl.querySelector('.field-label').value.trim();
                const placeholder = fieldEl.querySelector('.field-placeholder').value.trim();
                const prefix = fieldEl.querySelector('.field-prefix').value;
                const optionalCheckbox = fieldEl.querySelector('.field-optional');
                // –ü–µ—Ä–≤–æ–µ –ø–æ–ª–µ (idx=0) –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
                const optional = idx === 0 ? false : (optionalCheckbox?.checked || false);
                
                if (label || prefix) {
                    fields.push({ label, placeholder, prefix, optional });
                }
            });
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—è - input, –∏–Ω–∞—á–µ - info
            const type = fields.length > 0 ? 'input' : 'info';
            
            const updatedInstruction = {
                type: type,
                icon: selectedIcon,
                text: instructionText,
                fields: fields
            };
            
            updateBlockInstruction(currentTab, currentConstructorBlockNumber, updatedInstruction);
            hideInputConstructorModal();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (workflowMode) {
                renderWorkflow();
            } else {
                loadPrompts();
            }
        }
        
        // ============================================
        // –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (RUNTIME)
        // ============================================
        
        let currentDynamicInputBlock = null;
        
        function showDynamicInputModal(blockNumber) {
            currentDynamicInputBlock = blockNumber;
            closeAllModals();
            
            // –í–ê–ñ–ù–û: –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ù–ê–ü–†–Ø–ú–£–Æ –∏–∑ localStorage, –∞ –Ω–µ –∏–∑ –∫—ç—à–∞
            // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ undo/redo
            const tabs = getAllTabs();
            const tabData = tabs[currentTab];
            if (!tabData?.items) return;
            
            const blockIndex = parseInt(blockNumber) - 1;
            const block = tabData.items[blockIndex];
            
            if (!block) return;
            
            const instruction = block?.instruction;
            
            if (!instruction?.fields || instruction.fields.length === 0) {
                // –ï—Å–ª–∏ –ø–æ–ª–µ–π –Ω–µ—Ç - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                return;
            }
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('dynamic-modal-title').textContent = instruction.text || '–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–ª—è
            const fieldsContainer = document.getElementById('dynamic-modal-fields');
            fieldsContainer.innerHTML = '';
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞
            // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º block.content –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö localStorage,
            // –∞ –Ω–µ –∏–∑ DOM (textarea –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ undo)
            const content = block.content || '';
            
            instruction.fields.forEach((field, index) => {
                const fieldWrapper = document.createElement('div');
                fieldWrapper.className = 'dynamic-field';
                fieldWrapper.dataset.fieldIndex = index;
                
                // suffix = prefix —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª—è, –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (–¥–≤–æ–π–Ω–æ–π –ø–µ—Ä–µ–Ω–æ—Å)
                const nextField = instruction.fields[index + 1];
                const suffix = nextField?.prefix || '';
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                let currentValue = '';
                let foundInText = false;
                
                if (field.prefix) {
                    // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤–≤–µ–¥—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
                    const blockId = block?.id || blockNumber;
                    const storageKey = `field-value-${currentTab}-${blockId}-${index}`;
                    const savedValue = localStorage.getItem(storageKey);
                    const spacer = field.prefix.endsWith(' ') ? '' : ' ';
                    const placeholder = field.placeholder || 'example';
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–∂–¥—É prefix –∏ suffix (–∏–ª–∏ –¥–æ –¥–≤–æ–π–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞)
                    const extractValueFromText = () => {
                        const prefixPos = content.indexOf(field.prefix);
                        if (prefixPos === -1) return null;
                        
                        const afterPrefix = content.substring(prefixPos + field.prefix.length);
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü –∑–Ω–∞—á–µ–Ω–∏—è: suffix, –¥–≤–æ–π–Ω–æ–π –ø–µ—Ä–µ–Ω–æ—Å, –∏–ª–∏ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞
                        let endPos = afterPrefix.length;
                        if (suffix) {
                            const suffixPos = afterPrefix.indexOf(suffix);
                            if (suffixPos !== -1) endPos = suffixPos;
                        }
                        // –¢–∞–∫–∂–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–Ω–æ—Å–æ–º (–Ω–æ–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ)
                        const doubleNewline = afterPrefix.indexOf('\n\n');
                        if (doubleNewline !== -1 && doubleNewline < endPos) {
                            endPos = doubleNewline;
                        }
                        
                        const rawValue = afterPrefix.substring(0, endPos).trim();
                        return rawValue || null;
                    };
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤ —Ç–µ–∫—Å—Ç–µ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö)
                    const checkInText = (val) => {
                        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã/–ø–µ—Ä–µ–Ω–æ—Å—ã)
                        const normalize = (s) => s.replace(/\s+/g, ' ').trim();
                        const normalizedVal = normalize(val);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
                        const spacers = [spacer, '\n', '\r\n', ''];
                        for (const sp of spacers) {
                            const patterns = [
                                field.prefix + sp + '"' + val + '"',
                                field.prefix + sp + "'" + val + "'",
                                field.prefix + sp + val
                            ];
                            if (patterns.some(p => content.includes(p))) return true;
                        }
                        
                        // –î–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö: –∏–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ
                        const extracted = extractValueFromText();
                        if (extracted && normalize(extracted) === normalizedVal) {
                            return true;
                        }
                        
                        return false;
                    };
                    
                    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ç–æ –Ω–∞–ª–∏—á–∏–µ prefix –≤ —Ç–µ–∫—Å—Ç–µ (–¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π)
                    const prefixExistsInText = content.includes(field.prefix);
                    
                    if (savedValue && checkInText(savedValue)) {
                        // –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ
                        currentValue = savedValue;
                        foundInText = true;
                    } else if (checkInText(placeholder)) {
                        // Placeholder –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—Å—Ç–µ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–ª–∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞)
                        currentValue = placeholder;
                        foundInText = true;
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º localStorage –µ—Å–ª–∏ —Ç–∞–º –±—ã–ª–æ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        if (savedValue) {
                            localStorage.removeItem(storageKey);
                        }
                    } else if (prefixExistsInText) {
                        // prefix —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ, –Ω–æ —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö)
                        const extracted = extractValueFromText();
                        if (extracted) {
                            currentValue = extracted;
                            foundInText = true;
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            localStorage.setItem(storageKey, extracted);
                        } else if (!field.optional) {
                            // –î–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                            currentValue = placeholder;
                            foundInText = false;
                        }
                    } else {
                        // –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ - –ø–æ–ª–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ (–¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö)
                        // –∏–ª–∏ —Ç–µ–∫—Å—Ç –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω –≤—Ä—É—á–Ω—É—é
                        currentValue = placeholder;
                        foundInText = false; // –î–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π —ç—Ç–æ –∑–Ω–∞—á–∏—Ç "—Å–∫—Ä—ã—Ç–æ"
                        localStorage.removeItem(storageKey);
                    }
                }
                
                const isHidden = field.optional && !foundInText;
                
                if (field.optional) {
                    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ —Å –∫–Ω–æ–ø–∫–æ–π –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è ‚Äî textarea —Å –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
                    fieldWrapper.innerHTML = `
                        <div class="optional-field-toggle ${isHidden ? '' : 'hidden'} mb-2">
                            <button type="button" class="show-optional-field flex items-center gap-1 text-sm text-gray-500 hover:text-claude-accent transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                <span>–î–æ–±–∞–≤–∏—Ç—å ${field.label.toLowerCase()}</span>
                            </button>
                        </div>
                        <div class="optional-field-content ${isHidden ? 'hidden' : ''} mb-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${escapeHtml(field.label)}</label>
                            <div class="flex gap-2 items-center">
                                <textarea class="dynamic-input flex-1 min-w-0 px-4 border-2 border-gray-200 rounded-lg focus:outline-none text-gray-700 transition-colors resize-none scrollbar-thin leading-5"
                                       style="min-height: 42px; padding-top: 9px; padding-bottom: 7px;"
                                       rows="1"
                                       data-prefix="${escapeHtml(field.prefix || '')}"
                                       data-suffix="${escapeHtml(suffix)}"
                                       data-optional="true"
                                       data-found="${foundInText}"
                                       data-original-value="${escapeHtml(currentValue)}"
                                       data-field-index="${index}"
                                       data-placeholder="${escapeHtml(field.placeholder || 'example')}"
                                       placeholder="${escapeHtml(field.placeholder || 'example')}">${escapeHtml(currentValue)}</textarea>
                                <button type="button" class="hide-optional-field flex-shrink-0 text-gray-400 hover:text-red-500 transition-colors" title="–£–±—Ä–∞—Ç—å">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è + –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
                    setTimeout(() => {
                        const showBtn = fieldWrapper.querySelector('.show-optional-field');
                        const hideBtn = fieldWrapper.querySelector('.hide-optional-field');
                        const toggle = fieldWrapper.querySelector('.optional-field-toggle');
                        const content = fieldWrapper.querySelector('.optional-field-content');
                        const textarea = fieldWrapper.querySelector('textarea');
                        
                        // –ê–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea
                        if (textarea) {
                            const autoResize = () => {
                                textarea.style.height = 'auto';
                                const maxHeight = 200;
                                textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
                                textarea.style.overflowY = textarea.scrollHeight > maxHeight ? 'auto' : 'hidden';
                            };
                            textarea.addEventListener('input', autoResize);
                            autoResize();
                        }
                        
                        showBtn?.addEventListener('click', () => {
                            toggle.classList.add('hidden');
                            content.classList.remove('hidden');
                            textarea?.focus();
                        });
                        
                        hideBtn?.addEventListener('click', () => {
                            toggle.classList.remove('hidden');
                            content.classList.add('hidden');
                            if (textarea) textarea.value = '';
                        });
                    }, 0);
                } else {
                    // –û–±—ã—á–Ω–æ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ ‚Äî –≤—Å–µ–≥–¥–∞ textarea —Å –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
                    fieldWrapper.innerHTML = `
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${escapeHtml(field.label)}</label>
                            <textarea class="dynamic-input w-full px-4 border-2 border-gray-200 rounded-lg focus:outline-none text-gray-700 transition-colors resize-none scrollbar-thin leading-5"
                                   style="min-height: 42px; padding-top: 9px; padding-bottom: 7px;"
                                   rows="1"
                                   data-prefix="${escapeHtml(field.prefix || '')}"
                                   data-suffix="${escapeHtml(suffix)}"
                                   data-found="${foundInText}"
                                   data-original-value="${escapeHtml(currentValue)}"
                                   data-field-index="${index}"
                                   data-placeholder="${escapeHtml(field.placeholder || 'example')}"
                                   placeholder="${escapeHtml(field.placeholder || 'example')}">${escapeHtml(currentValue)}</textarea>
                        </div>
                    `;
                    
                    // –ê–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea
                    setTimeout(() => {
                        const textarea = fieldWrapper.querySelector('textarea');
                        if (textarea) {
                            const autoResize = () => {
                                textarea.style.height = 'auto';
                                const maxHeight = 200; // –õ–∏–º–∏—Ç –≤—ã—Å–æ—Ç—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                                textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
                                textarea.style.overflowY = textarea.scrollHeight > maxHeight ? 'auto' : 'hidden';
                            };
                            textarea.addEventListener('input', autoResize);
                            autoResize(); // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞
                        }
                    }, 0);
                }
                
                fieldsContainer.appendChild(fieldWrapper);
            });
            
            document.getElementById('dynamic-input-modal').classList.add('open');
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
            setTimeout(() => {
                fieldsContainer.querySelector('.dynamic-input:not([data-optional="true"])')?.focus();
            }, 100);
        }
        
        function hideDynamicInputModal() {
            document.getElementById('dynamic-input-modal').classList.remove('open');
            currentDynamicInputBlock = null;
        }
        
        function applyDynamicInput() {
            if (!currentDynamicInputBlock) return;
            
            // –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ü–ï–†–ï–î –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –±–µ–∑ debounce)
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ undo –≤–µ—Ä–Ω—ë—Ç –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–æ–¥–∞–ª–∫–∏
            const stateBefore = captureCurrentTabState();
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º, –∏–≥–Ω–æ—Ä–∏—Ä—É—è debounce
            if (undoStack.length === 0 || 
                JSON.stringify(undoStack[undoStack.length - 1].tabData) !== JSON.stringify(stateBefore.tabData) ||
                JSON.stringify(undoStack[undoStack.length - 1].fieldValues) !== JSON.stringify(stateBefore.fieldValues)) {
                undoStack.push(stateBefore);
                if (undoStack.length > MAX_HISTORY_SIZE) {
                    undoStack.shift();
                }
                redoStack = [];
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
                tabHistories[currentTab] = {
                    undoStack: [...undoStack],
                    redoStack: [...redoStack]
                };
                updateUndoRedoButtons();
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –±–ª–æ–∫ –∏–∑ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö localStorage
            const tabs = getAllTabs();
            const tabData = tabs[currentTab];
            if (!tabData?.items) return;
            
            const blockIndex = parseInt(currentDynamicInputBlock) - 1;
            const block = tabData.items[blockIndex];
            if (!block) return;
            
            // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º content –∏–∑ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö localStorage, –Ω–µ –∏–∑ DOM
            let content = block.content || '';
            let changed = false;
            
            const fieldsContainer = document.getElementById('dynamic-modal-fields');
            
            fieldsContainer.querySelectorAll('.dynamic-input').forEach((input) => {
                const prefix = input.dataset.prefix;
                const originalValue = input.dataset.originalValue || '';
                const fieldIndex = input.dataset.fieldIndex;
                const placeholder = input.dataset.placeholder || input.placeholder || 'example';
                let newValue = input.value.trim();
                if (!newValue) {
                    newValue = placeholder;
                }
                const isOptional = input.dataset.optional === 'true';
                const isHidden = input.closest('.optional-field-content')?.classList.contains('hidden');
                
                if (!prefix) return;
                
                // –ü–æ–ª—É—á–∞–µ–º ID –±–ª–æ–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const blockId = block?.id || currentDynamicInputBlock;
                const storageKey = `field-value-${currentTab}-${blockId}-${fieldIndex}`;
                
                if (isOptional && isHidden) {
                    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ —Å–∫—Ä—ã—Ç–æ ‚Äî —É–¥–∞–ª—è–µ–º –∏–∑ —Ç–µ–∫—Å—Ç–∞
                    if (originalValue) {
                        const spacer = prefix.endsWith(' ') ? '' : ' ';
                        const spacers = [spacer, '\n', '\r\n', ''];
                        // –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å –ø—Ä–æ–±–µ–ª–æ–º/–ø–µ—Ä–µ–Ω–æ—Å–æ–º –ø–µ—Ä–µ–¥ –Ω–∏–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                        const patterns = [];
                        for (const sp of spacers) {
                            patterns.push(
                                ' ' + prefix + sp + '"' + originalValue + '"',
                                ' ' + prefix + sp + "'" + originalValue + "'",
                                ' ' + prefix + sp + originalValue,
                                '\n' + prefix + sp + '"' + originalValue + '"',
                                '\n' + prefix + sp + "'" + originalValue + "'",
                                '\n' + prefix + sp + originalValue,
                                // –ë–µ–∑ –ø—Ä–æ–±–µ–ª–∞ –ø–µ—Ä–µ–¥ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏)
                                prefix + sp + '"' + originalValue + '"',
                                prefix + sp + "'" + originalValue + "'",
                                prefix + sp + originalValue
                            );
                        }
                        for (const pattern of patterns) {
                            if (content.includes(pattern)) {
                                content = content.replace(pattern, '');
                                // –£–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å
                                content = content.replace(/  +/g, ' ');
                                changed = true;
                                break;
                            }
                        }
                    }
                    localStorage.removeItem(storageKey);
                } else if (isOptional && !isHidden && input.dataset.found === 'false') {
                    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –±—ã–ª–æ —Å–∫—Ä—ã—Ç–æ (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ), —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑–∞–Ω–æ - –í–°–¢–ê–í–õ–Ø–ï–ú –≤ —Ç–µ–∫—Å—Ç
                    if (newValue) {
                        const spacer = prefix.endsWith(' ') ? '' : ' ';
                        const insertText = ' ' + prefix + spacer + newValue;
                        
                        // –ò—â–µ–º –º–µ—Å—Ç–æ –≤—Å—Ç–∞–≤–∫–∏ - –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–æ–π –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ
                        const firstLineEnd = content.indexOf('\n');
                        const firstLine = firstLineEnd > 0 ? content.substring(0, firstLineEnd) : content;
                        const dotIndex = firstLine.indexOf('.');
                        
                        if (dotIndex > 0) {
                            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —Ç–æ—á–∫–æ–π
                            content = content.substring(0, dotIndex) + insertText + content.substring(dotIndex);
                            changed = true;
                        } else if (firstLineEnd > 0) {
                            // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                            content = firstLine + insertText + content.substring(firstLineEnd);
                            changed = true;
                        } else {
                            // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                            content = content + insertText;
                            changed = true;
                        }
                        localStorage.setItem(storageKey, newValue);
                    }
                } else if (originalValue && newValue !== originalValue) {
                    // –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Äî –∑–∞–º–µ–Ω—è–µ–º
                    // –ò—â–µ–º —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ (–ø—Ä–æ–±–µ–ª, –ø–µ—Ä–µ–Ω–æ—Å, –Ω–∏—á–µ–≥–æ)
                    const spacer = prefix.endsWith(' ') ? '' : ' ';
                    const spacers = [spacer, '\n', '\r\n', ''];
                    const suffix = input.dataset.suffix || '';
                    let found = false;
                    
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                    const patterns = [];
                    for (const sp of spacers) {
                        patterns.push(
                            { search: prefix + sp + '"' + originalValue + '"', replace: prefix + sp + '"' + newValue + '"' },
                            { search: prefix + sp + "'" + originalValue + "'", replace: prefix + sp + "'" + newValue + "'" },
                            { search: prefix + sp + originalValue, replace: prefix + sp + newValue }
                        );
                    }
                    for (const p of patterns) {
                        if (content.includes(p.search)) {
                            content = content.replace(p.search, p.replace);
                            changed = true;
                            found = true;
                            break;
                        }
                    }
                    
                    // Fallback: –∑–∞–º–µ–Ω–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–æ—Ç prefix –¥–æ suffix –∏–ª–∏ –¥–≤–æ–π–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞)
                    if (!found && content.includes(prefix)) {
                        const prefixPos = content.indexOf(prefix);
                        const afterPrefix = content.substring(prefixPos + prefix.length);
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü —Å—Ç–∞—Ä–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                        let endPos = afterPrefix.length;
                        if (suffix) {
                            const suffixPos = afterPrefix.indexOf(suffix);
                            if (suffixPos !== -1) endPos = suffixPos;
                        }
                        const doubleNewline = afterPrefix.indexOf('\n\n');
                        if (doubleNewline !== -1 && doubleNewline < endPos) {
                            endPos = doubleNewline;
                        }
                        
                        // –ó–∞–º–µ–Ω—è–µ–º: prefix + —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (—Å–æ—Ö—Ä–∞–Ω—è–µ–º) + –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        const oldPart = content.substring(prefixPos, prefixPos + prefix.length + endPos);
                        const firstChar = afterPrefix[0];
                        const separator = (firstChar === '\n' || firstChar === ' ') ? firstChar : '\n';
                        const newPart = prefix + separator + newValue;
                        
                        content = content.replace(oldPart, newPart);
                        changed = true;
                    }
                    
                    localStorage.setItem(storageKey, newValue);
                } else if (!originalValue && newValue) {
                    // –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî –∏—â–µ–º placeholder –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                    const placeholderVal = input.dataset.placeholder || input.placeholder || 'example';
                    const spacer = prefix.endsWith(' ') ? '' : ' ';
                    const spacers = [spacer, '\n', '\r\n', ''];
                    const suffix = input.dataset.suffix || '';
                    let found = false;
                    
                    const patterns = [];
                    for (const sp of spacers) {
                        patterns.push(
                            { search: prefix + sp + '"' + placeholderVal + '"', replace: prefix + sp + '"' + newValue + '"' },
                            { search: prefix + sp + "'" + placeholderVal + "'", replace: prefix + sp + "'" + newValue + "'" },
                            { search: prefix + sp + placeholderVal, replace: prefix + sp + newValue }
                        );
                    }
                    for (const p of patterns) {
                        if (content.includes(p.search)) {
                            content = content.replace(p.search, p.replace);
                            changed = true;
                            found = true;
                            break;
                        }
                    }
                    
                    // Fallback: –∑–∞–º–µ–Ω–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ placeholder
                    if (!found && content.includes(prefix)) {
                        const prefixPos = content.indexOf(prefix);
                        const afterPrefix = content.substring(prefixPos + prefix.length);
                        
                        let endPos = afterPrefix.length;
                        if (suffix) {
                            const suffixPos = afterPrefix.indexOf(suffix);
                            if (suffixPos !== -1) endPos = suffixPos;
                        }
                        const doubleNewline = afterPrefix.indexOf('\n\n');
                        if (doubleNewline !== -1 && doubleNewline < endPos) {
                            endPos = doubleNewline;
                        }
                        
                        const oldPart = content.substring(prefixPos, prefixPos + prefix.length + endPos);
                        const firstChar = afterPrefix[0];
                        const separator = (firstChar === '\n' || firstChar === ' ') ? firstChar : '\n';
                        const newPart = prefix + separator + newValue;
                        
                        content = content.replace(oldPart, newPart);
                        changed = true;
                    }
                    
                    localStorage.setItem(storageKey, newValue);
                } else {
                    // –ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                    localStorage.setItem(storageKey, newValue);
                }
            });
            
            if (changed) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ tabs –Ω–∞–ø—Ä—è–º—É—é
                block.content = content;
                saveAllTabs(tabs);
                
                // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞–µ–º workflow —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é
                renderWorkflow();
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ undo —Å—Ç–µ–∫
                // (–±–µ–∑ debounce, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–ª undo)
                setTimeout(() => {
                    const stateAfter = captureCurrentTabState();
                    if (undoStack.length === 0 || JSON.stringify(undoStack[undoStack.length - 1]) !== JSON.stringify(stateAfter)) {
                        undoStack.push(stateAfter);
                        if (undoStack.length > MAX_HISTORY_SIZE) {
                            undoStack.shift();
                        }
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
                        tabHistories[currentTab] = {
                            undoStack: [...undoStack],
                            redoStack: [...redoStack]
                        };
                        updateUndoRedoButtons();
                    }
                }, 50);
            }
            
            hideDynamicInputModal();
        }
        
        function updateEditModeToggle() {
            const onBtn = document.getElementById('edit-mode-on');
            const offBtn = document.getElementById('edit-mode-off');
            if (isAdminMode) {
                onBtn?.classList.add('active');
                offBtn?.classList.remove('active');
            } else {
                onBtn?.classList.remove('active');
                offBtn?.classList.add('active');
            }
        }
        
        // --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –ò–ú–ü–û–†–¢–ê ---
        let importConfirmResolve = null;
        
        function showImportConfirm(message) {
            return new Promise((resolve) => {
                importConfirmResolve = resolve;
                const modal = document.getElementById('import-confirm-modal');
                const messageEl = document.getElementById('import-confirm-message');
                if (messageEl) messageEl.textContent = message;
                if (modal) modal.classList.add('open');
            });
        }
        
        function hideImportConfirm(result) {
            const modal = document.getElementById('import-confirm-modal');
            if (modal) modal.classList.remove('open');
            if (importConfirmResolve) {
                importConfirmResolve(result);
                importConfirmResolve = null;
            }
        }
        
        // --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ù–ê–°–¢–†–û–ï–ö ---
        function showSettingsModal() {
            closeAllModals();
            const modal = document.getElementById('settings-modal');
            const settings = getSettings();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            updateAutoUpdateButtons(settings.autoUpdate);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç–µ–º—É
            updateThemeButtons(settings.theme);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            updateEditModeToggle();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é
            const versionSpan = document.getElementById('settings-version');
            if (versionSpan && window.__TAURI__) {
                window.__TAURI__.core.invoke('plugin:app|version').then(v => {
                    versionSpan.textContent = v;
                }).catch(() => {
                    versionSpan.textContent = '0.3.0';
                });
            }
            
            modal?.classList.add('open');
        }
        
        const hideSettingsModal = () => hideModal('settings-modal');
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ URL –≤ webview Claude (–≤ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ Claude)
        async function openUrlInClaude(url) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å Claude –µ—Å–ª–∏ —Å–∫—Ä—ã—Ç–∞ (–Ω–µ –∂–¥—ë–º –∞–Ω–∏–º–∞—Ü–∏—é)
                if (!isClaudeVisible && window.__TAURI__?.core?.invoke) {
                    window.__TAURI__.core.invoke('toggle_claude').then(() => updateClaudeState());
                }
                // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ä–∞–∑—É ‚Äî webview —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                await navigateClaude(activeClaudeTab, url);
            } catch (e) {
                
                showToast('‚ùå –û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏', 2000);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –ª–æ–≥–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
        async function showArchiveLogModal() {
            closeAllModals();
            const modal = document.getElementById('archive-log-modal');
            const tbody = document.getElementById('archive-log-tbody');
            const searchInput = document.getElementById('archive-log-search');
            
            if (searchInput) searchInput.value = '';
            
            try {
                const log = await window.__TAURI__.core.invoke('get_archive_log');
                
                if (log.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="archive-log-empty">–õ–æ–≥ –ø—É—Å—Ç</td></tr>';
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                    tbody.innerHTML = log.reverse().map(entry => `
                        <tr class="archive-log-row">
                            <td class="archive-log-cell archive-log-timestamp">${entry.timestamp}</td>
                            <td class="archive-log-cell archive-log-filename">${escapeHtml(entry.filename)}</td>
                            <td class="archive-log-cell">
                                <button onclick="openUrlInClaude('${escapeHtml(entry.claude_url)}')" class="archive-log-link">
                                    –û—Ç–∫—Ä—ã—Ç—å –≤ Claude
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                
                tbody.innerHTML = '<tr><td colspan="3" class="archive-log-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–∞</td></tr>';
            }
            
            modal?.classList.add('open');
        }
        
        const hideArchiveLogModal = () => hideModal('archive-log-modal');
        
        // Generic —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è toggle –∫–Ω–æ–ø–æ–∫
        function updateToggleButtons(btnClass, activeId) {
            document.querySelectorAll(`.${btnClass}`).forEach(btn => btn.classList.remove('active'));
            document.getElementById(activeId)?.classList.add('active');
        }
        
        function updateAutoUpdateButtons(enabled) {
            updateToggleButtons('auto-update-btn', enabled ? 'auto-update-on' : 'auto-update-off');
        }
        
        function updateThemeButtons(activeTheme) {
            updateToggleButtons('theme-btn', `theme-${activeTheme}`);
        }
        
        function setTheme(theme) {
            const settings = getSettings();
            settings.theme = theme;
            saveSettings(settings);
            updateThemeButtons(theme);
            applyTheme(theme);
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ–Ω–∞ –æ–∫–Ω–∞ —Å —Ç–µ–º–æ–π (–¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –±–µ–ª—ã—Ö –ø–æ–ª–æ—Å –ø—Ä–∏ resize)
        async function syncWindowBackground() {
            try {
                const isDark = document.body.classList.contains('dark');
                await window.__TAURI__.core.invoke('set_window_background', { dark: isDark });
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω–µ Tauri
            }
        }
        
        function applyTheme(theme) {
            const body = document.body;
            
            if (theme === 'dark') {
                body.classList.add('dark');
            } else if (theme === 'light') {
                body.classList.remove('dark');
            } else {
                // Auto - —Å–ª–µ–¥—É–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º–µ
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    body.classList.add('dark');
                } else {
                    body.classList.remove('dark');
                }
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ñ–æ–Ω –æ–∫–Ω–∞
            syncWindowBackground();
        }
        
        // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
        function initThemeListener() {
            const settings = getSettings();
            applyTheme(settings.theme);
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã –¥–ª—è auto —Ä–µ–∂–∏–º–∞
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const currentSettings = getSettings();
                if (currentSettings.theme === 'auto') {
                    if (e.matches) {
                        document.body.classList.add('dark');
                    } else {
                        document.body.classList.remove('dark');
                    }
                    syncWindowBackground();
                }
            });
        }
        
        function toggleAutoUpdate(enabled) {
            const settings = getSettings();
            settings.autoUpdate = enabled;
            saveSettings(settings);
        }
        
        async function importConfig() {
            const input = document.getElementById('import-file-input');
            input.click();
        }
        
        async function handleImportFile(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            let importedCount = 0;
            let lastTabId = null;
            const tabs = getAllTabs();
            const conflicts = [];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
            const allImportedTabs = {};
            const allImportedWorkflows = {}; // tabId -> workflow data
            
            for (const file of files) {
                try {
                    const text = await file.text();
                    const config = JSON.parse(text);
                    
                    if (config.tab) {
                        const tabId = config.tab.id || `imported-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        config.tab.id = tabId;
                        allImportedTabs[tabId] = config.tab;
                        if (tabs[tabId]) {
                            conflicts.push(tabs[tabId].name);
                        }
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º workflow state –µ—Å–ª–∏ –µ—Å—Ç—å (–≤–µ—Ä—Å–∏—è 2+)
                        if (config.workflow) {
                            allImportedWorkflows[tabId] = config.workflow;
                        }
                    } else if (config.tabs) {
                        Object.entries(config.tabs).forEach(([id, tab]) => {
                            allImportedTabs[id] = tab;
                            if (tabs[id]) {
                                conflicts.push(tabs[id].name);
                            }
                        });
                    }
                } catch (e) {
                    
                }
            }
            
            if (Object.keys(allImportedTabs).length === 0) {
                showToast('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∫–ª–∞–¥–æ–∫ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                event.target.value = '';
                return;
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
            if (conflicts.length > 0) {
                const uniqueConflicts = [...new Set(conflicts)];
                const choice = await showImportConfirm(`–°–ª–µ–¥—É—é—â–∏–µ –≤–∫–ª–∞–¥–∫–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã: ${uniqueConflicts.join(', ')}`);
                if (!choice) {
                    event.target.value = '';
                    return;
                }
            }
            
            // –°–ª–∏–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
            const mergedTabs = { ...tabs, ...allImportedTabs };
            saveAllTabs(mergedTabs, true); // skipUndo - –∏–º–ø–æ—Ä—Ç –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º scripts, collapsed –∏ automation –∏–∑ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤
            Object.values(allImportedTabs).forEach(tab => {
                if (tab.items) {
                    tab.items.forEach(item => {
                        if (item.type === 'block') {
                            // –ò–º–ø–æ—Ä—Ç scripts
                            if (item.scripts && item.scripts.length > 0) {
                                item.scripts.forEach(scriptKey => {
                                    if (!hasBlockScript(item.id, scriptKey)) {
                                        toggleBlockScript(item.id, scriptKey);
                                    }
                                });
                            }
                            // –ò–º–ø–æ—Ä—Ç collapsed
                            if (item.collapsed) {
                                collapsedBlocks[item.id] = true;
                            }
                            // –ò–º–ø–æ—Ä—Ç automation
                            if (item.automation && Object.keys(item.automation).length > 0) {
                                blockAutomation[item.id] = { ...item.automation };
                            }
                        }
                    });
                }
            });
            saveCollapsedBlocks();
            saveBlockAutomation();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º workflow state –¥–ª—è –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫
            Object.entries(allImportedWorkflows).forEach(([tabId, workflow]) => {
                const workflowData = {
                    positions: workflow.positions || {},
                    sizes: workflow.sizes || {},
                    connections: workflow.connections || []
                };
                localStorage.setItem(`workflow-${tabId}`, JSON.stringify(workflowData));
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é
            const firstImported = Object.keys(allImportedTabs)[0];
            switchToTab(firstImported || DEFAULT_TAB);
            
            const count = Object.keys(allImportedTabs).length;
            showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤–∫–ª–∞–¥–æ–∫: ${count}`);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
            event.target.value = '';
        }

        /**
         * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç
         * –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–µ–º–∞, –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è
         */
        async function confirmReset() {
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞ (—á—Ç–æ–±—ã beforeunload –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª)
                isResetting = true;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                stopGenerationMonitor();
                
                // –û—á–∏—â–∞–µ–º JS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Claude
                isClaudeVisible = false;
                existingTabs = [1];
                tabUrls = {};
                generatingTabs = {};
                
                // –û—á–∏—â–∞–µ–º JS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ workflow
                workflowPositions = {};
                workflowConnections = [];
                workflowSizes = {};
                
                // –û—á–∏—â–∞–µ–º JS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–ª–æ–∫–æ–≤
                collapsedBlocks = {};
                blockScripts = {};
                blockAutomation = {};
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º
                const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–ª—é—á–∏ localStorage (–≤–∫–ª—é—á–∞—è —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)
                localStorage.removeItem(STORAGE_KEYS.LANGUAGE);
                localStorage.removeItem(STORAGE_KEYS.CURRENT_TAB);
                localStorage.removeItem(STORAGE_KEYS.TABS);
                localStorage.removeItem('claude-ai-prompts-data-v2');
                localStorage.removeItem('claude-ai-prompts-language-v2');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–æ–≤
                localStorage.removeItem(STORAGE_KEYS.COLLAPSED_BLOCKS);
                localStorage.removeItem(STORAGE_KEYS.BLOCK_SCRIPTS);
                localStorage.removeItem(STORAGE_KEYS.BLOCK_AUTOMATION);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º Claude —á–∞—Ç—ã (–Ω–æ –Ω–µ auto_send - —ç—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
                localStorage.removeItem('claudeSettings');
                
                // –û—á–∏—â–∞–µ–º –≤–µ—Å—å localStorage —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (–∫—Ä–æ–º–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.startsWith('claude-ai-prompts') || 
                        key.startsWith('ai-prompts-manager') ||
                        key.startsWith('workflow-') ||
                        key.startsWith('field-value-') ||
                        key.startsWith('collapsed-') ||
                        key.startsWith('block-') ||
                        key.startsWith('remote-prompts')
                    )) {
                        // –ù–µ —É–¥–∞–ª—è–µ–º –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                        if (!key.includes('settings')) {
                            keysToRemove.push(key);
                        }
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (savedSettings) {
                    localStorage.setItem(STORAGE_KEYS.SETTINGS, savedSettings);
                }
                
                // –í—ã–∑—ã–≤–∞–µ–º Rust-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±—Ä–æ—Å–∞
                if (window.__TAURI__ && window.__TAURI__.core) {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º Claude (–∑–∞–∫—Ä—ã–≤–∞–µ–º webviews)
                    await window.__TAURI__.core.invoke('reset_claude_state');
                    // –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    await window.__TAURI__.core.invoke('reset_app_data');
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                location.reload();
            } catch (e) {
                
                // –í—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                location.reload();
            }
        }

        // ============================================
        // WORKFLOW SYSTEM
        // ============================================
        
        // Workflow –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã window.AppState.workflow.*
        // workflowMode, workflowConnections, workflowPositions, workflowSizes, workflowZoom
        // blockAttachments ‚Äî –≤—ã–Ω–µ—Å–µ–Ω –≤ blocks.js
        
        // Resize state ‚Äî —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã window.AppState.interaction.*
        // isResizingNode, resizeNode, resizeDirection, selectedNodes, isDraggingNode
        // dragOffsets, clipboard, isCreatingConnection, connectionStart, tempLineEl
        
        // resizeStart —Ö—Ä–∞–Ω–∏—Ç x, y, width, height, left, top –≤ –æ–±—ä–µ–∫—Ç–µ AppState.interaction.resizeStart
        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞—ë–º –≥–µ—Ç—Ç–µ—Ä—ã/—Å–µ—Ç—Ç–µ—Ä—ã –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        Object.defineProperty(window, 'resizeStartX', {
            get() { return window.AppState.interaction.resizeStart.x; },
            set(v) { window.AppState.interaction.resizeStart.x = v; }
        });
        Object.defineProperty(window, 'resizeStartY', {
            get() { return window.AppState.interaction.resizeStart.y; },
            set(v) { window.AppState.interaction.resizeStart.y = v; }
        });
        Object.defineProperty(window, 'resizeStartWidth', {
            get() { return window.AppState.interaction.resizeStart.width; },
            set(v) { window.AppState.interaction.resizeStart.width = v; }
        });
        Object.defineProperty(window, 'resizeStartHeight', {
            get() { return window.AppState.interaction.resizeStart.height; },
            set(v) { window.AppState.interaction.resizeStart.height = v; }
        });
        Object.defineProperty(window, 'resizeStartLeft', {
            get() { return window.AppState.interaction.resizeStart.left; },
            set(v) { window.AppState.interaction.resizeStart.left = v; }
        });
        Object.defineProperty(window, 'resizeStartTop', {
            get() { return window.AppState.interaction.resizeStart.top; },
            set(v) { window.AppState.interaction.resizeStart.top = v; }
        });
        
        // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –Ω–æ–¥
        // clearNodeSelection ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ js/workflow-interactions.js
        
        // initWorkflow ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ js/workflow-render.js
        
        // updateGridOverlay, clearGridOverlay ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/workflow-grid.js
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –°–ï–ö–¶–ò–Ø 12: WORKFLOW –†–ï–ñ–ò–ú (Canvas, drag & drop, connections)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // renderWorkflow, autoPositionNodes ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/workflow-render.js
        
        // adjustWorkflowScale, calculateContentBounds, calculateViewModeZoom, setupWorkflowZoom, scrollToBlocks ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/workflow-zoom.js
        
        // createWorkflowNode ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ js/workflow-render.js

        // createWorkflowInstruction ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ js/workflow-render.js

        // setupNodeEvents ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ js/workflow-render.js
        // Drag & Resize handlers ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/workflow-interactions.js:
        // onNodeDrag, onNodeDragEnd, onNodeResize, onNodeResizeEnd, resetDragResizeState
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // –°–±—Ä–æ—Å –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –æ–∫–Ω–∞
        window.addEventListener('blur', resetDragResizeState);
        
        // –°–±—Ä–æ—Å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && (isResizingNode || isDraggingNode)) {
                resetDragResizeState();
            }
        });
        
        // –°–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ—Ä—Ç–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π)
        function setupPortEvents(port) {
            const node = port.closest('.workflow-node');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –±–æ–∫–æ–≤–æ–π –ø–æ—Ä—Ç collapsed –±–ª–æ–∫–∞
            if (port.dataset.side === 'left' || port.dataset.side === 'right') {
                port.addEventListener('mouseenter', () => {
                    if (node && node.classList.contains('collapsed')) {
                        node.classList.add('hide-buttons');
                    }
                });
                
                port.addEventListener('mouseleave', () => {
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    if (!isCreatingConnection && node && node.classList.contains('collapsed')) {
                        node.classList.remove('hide-buttons');
                    }
                });
            }
            
            port.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                if (e.button !== 0) return;
                // –¢–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                if (!isEditMode) return;
                
                const side = port.dataset.side;
                const blockId = port.dataset.blockId;
                
                // –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏ —Å –ª—é–±–æ–≥–æ –ø–æ—Ä—Ç–∞
                isCreatingConnection = true;
                connectionStart = {blockId: blockId, side: side};
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É –≤—Å–µ—Ö collapsed –±–ª–æ–∫–æ–≤ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                document.querySelectorAll('.workflow-node.collapsed').forEach(n => {
                    n.classList.add('hide-buttons');
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Ä—Ç—ã
                getWorkflowContainer()?.classList.add('connecting');
                
                // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é (path –¥–ª—è Bezier)
                const svg = getWorkflowSvg();
                if (!svg) {
                    
                    return;
                }
                tempLineEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tempLineEl.setAttribute('stroke', '#ec7441');
                tempLineEl.setAttribute('stroke-width', '4');
                tempLineEl.setAttribute('stroke-dasharray', '8,8');
                tempLineEl.setAttribute('fill', 'none');
                const startPos = getPortPosition(blockId, side);
                tempLineEl.dataset.startX = startPos.x;
                tempLineEl.dataset.startY = startPos.y;
                tempLineEl.dataset.startSide = side;
                tempLineEl.setAttribute('d', `M ${startPos.x} ${startPos.y} L ${startPos.x} ${startPos.y}`);
                svg.appendChild(tempLineEl);
                
                document.addEventListener('mousemove', onConnectionDrag);
                document.addEventListener('mouseup', onConnectionEnd);
            });
            
            port.addEventListener('mouseup', (e) => {
                if (!isCreatingConnection || !connectionStart) return;
                if (!isEditMode) return;
                
                const side = port.dataset.side;
                const blockId = port.dataset.blockId;
                
                // –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–≤—è–∑—å –µ—Å–ª–∏ —ç—Ç–æ –¥—Ä—É–≥–æ–π –±–ª–æ–∫
                if (connectionStart.blockId !== blockId) {
                    addConnection(connectionStart.blockId, connectionStart.side, blockId, side);
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á—Ç–æ–±—ã onConnectionEnd –Ω–µ —Å–æ–∑–¥–∞–ª –¥—É–±–ª–∏–∫–∞—Ç
                    connectionStart = null;
                }
            });
        }
        
        // findNearestPort, onConnectionDrag, onConnectionEnd, getPortPosition, addConnection, wouldCreateCycle, removeConnection, renderConnections ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/connections.js
        
        // saveWorkflowState, loadWorkflowState ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/workflow-state.js
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–¥—É

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Workflow Edit Modal Functions ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/workflow-render.js:
        // editWorkflowNode, showBlockEditModal, hideWorkflowEditModal,
        // saveWorkflowEdit, saveBlockContent, deleteWorkflowBlock
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // === –ü–†–ò–ö–†–ï–ü–õ–ï–ù–ò–ï –§–ê–ô–õ–û–í –ö –ë–õ–û–ö–ê–ú ===
        
        // –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±–ª–æ–∫–∞
        async function attachFilesToBlock(blockId) {
            try {
                const result = await window.__TAURI__.dialog.open({
                    multiple: true,
                    title: '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è'
                });
                
                if (!result) return;
                
                // result –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º
                const paths = Array.isArray(result) ? result : [result];
                
                if (!blockAttachments[blockId]) {
                    blockAttachments[blockId] = [];
                }
                
                paths.forEach(path => {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø—É—Ç–∏
                    const name = path.split(/[/\\]/).pop();
                    blockAttachments[blockId].push({ path, name });
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                updateBlockAttachmentsUI(blockId);
                
                showToast(`–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${paths.length}`);
            } catch (e) {
                
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–æ–≤');
            }
        }
        
        // –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ –±–ª–æ–∫–∞
        function removeAttachmentFromBlock(blockId, fileIndex) {
            if (blockAttachments[blockId]) {
                blockAttachments[blockId].splice(fileIndex, 1);
                if (blockAttachments[blockId].length === 0) {
                    delete blockAttachments[blockId];
                }
                updateBlockAttachmentsUI(blockId);
            }
        }
        
        // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –±–ª–æ–∫–∞
        function clearBlockAttachments(blockId) {
            delete blockAttachments[blockId];
            updateBlockAttachmentsUI(blockId);
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å UI —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
        function updateBlockAttachmentsUI(blockId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –æ–±—ã—á–Ω–æ–º –±–ª–æ–∫–µ
            const filesList = document.querySelector(`.workflow-attached-files[data-block-id="${blockId}"]`);
            if (filesList) {
                filesList.innerHTML = '';
                
                if (blockAttachments[blockId] && blockAttachments[blockId].length > 0) {
                    blockAttachments[blockId].forEach((file, fileIndex) => {
                        const fileChip = document.createElement('div');
                        fileChip.className = 'workflow-file-chip';
                        fileChip.innerHTML = `
                            <span class="file-name">${escapeHtml(file.name)}</span>
                            <button class="file-remove" data-block-id="${blockId}" data-file-index="${fileIndex}" title="–£–¥–∞–ª–∏—Ç—å">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        `;
                        filesList.appendChild(fileChip);
                    });
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∞–π–ª–æ–≤ –≤ collapsed –±–ª–æ–∫–µ
            const collapsedFilesBtn = document.querySelector(`.collapsed-files-btn[data-block-id="${blockId}"]`);
            if (collapsedFilesBtn) {
                const filesCount = blockAttachments[blockId]?.length || 0;
                collapsedFilesBtn.innerHTML = filesCount > 0 
                    ? `<span class="files-count">${filesCount}</span>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>`;
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Claude Automation Utilities ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/claude-api.js:
        // evalInClaude, navigateClaude, generateProjectName, waitForPageLoad,
        // createNewProject, attachScriptsToMessage, attachFilesToMessage
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Main Function: Send Node to Claude ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/claude-api.js:
        // sendNodeToClaude, sendTextToClaude
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // updateWorkflowChatButtons ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ js/claude-ui.js
        
        // –í—ã–±–æ—Ä —á–∞—Ç–∞ –¥–ª—è –Ω–æ–¥—ã
        function selectChatForNode(index) {
            const chat = prompt('–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ —á–∞—Ç—É (1, 2, 3 –∏–ª–∏ –ø—É—Å—Ç–æ –¥–ª—è –æ—Ç–≤—è–∑–∫–∏):');
            if (chat === null) return;
            
            const items = getTabItems(currentTab);
            const blocks = items.filter(item => item.type === 'block');
            
            if (blocks && blocks[index]) {
                if (chat === '' || chat === '0') {
                    delete blocks[index].chatTab;
                } else if (['1', '2', '3'].includes(chat)) {
                    blocks[index].chatTab = parseInt(chat);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                const allTabs = getAllTabs();
                allTabs[currentTab].items = items;
                saveAllTabs(allTabs);
                
                renderWorkflow();
            }
        }


        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –°–ï–ö–¶–ò–Ø 13: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø CLAUDE (Tabbed Split View)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Claude –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã window.AppState.claude.*
        // isClaudeVisible, activeClaudeTab, existingTabs, generatingTabs, tabUrls, panelRatio, isResetting
        
        // Resizer –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –∞–ª–∏–∞—Å—ã window.AppState.resizer.*
        // resizer, isResizing, startX, startRatio, windowWidth, lastAppliedRatio, updateScheduled
        
        // createResizer, updateResizer ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/claude-ui.js
        
        // saveClaudeSettings, updateAllTabUrls, loadClaudeSettings ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/claude-state.js
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Claude API —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/claude-api.js:
        // toggleClaude, switchClaudeTab, injectGenerationMonitor, checkAllGenerationStatus,
        // startGenerationMonitor, stopGenerationMonitor, newChatInTab, waitForClaudeInput,
        // closeClaudeTab, restoreClaudeState, initClaudeHandlers, addNewChatTab
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // updateClaudeState, updateClaudeUI ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ js/claude-ui.js
        // showToast ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ js/toast.js

        // --- –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï ---
        let lastUpdateCheck = null; // –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        async function checkForUpdates(showModal = false) {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 
            await delay(300);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
            const currentVersion = await getAppVersion();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Tauri –¥–ª—è updater
            if (window.__TAURI__?.updater) {
                try {
                    const { check } = window.__TAURI__.updater;
                    const update = await check();
                    
                    if (update?.available) {
                        lastUpdateCheck = { available: true, version: update.version, body: update.body || '' };
                        if (showModal) {
                            showUpdateModalAvailable(update.version, update.body);
                        }
                        return lastUpdateCheck;
                    } else {
                        lastUpdateCheck = { available: false, version: currentVersion };
                        if (showModal) {
                            showUpdateModalLatest(currentVersion);
                        }
                        return lastUpdateCheck;
                    }
                } catch (e) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ —É–¥–∞–ª–∞—Å—å
                }
            }
            
            // Fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
            lastUpdateCheck = { available: false, version: currentVersion };
            if (showModal) {
                showUpdateModalLatest(currentVersion);
            }
            return lastUpdateCheck;
        }

        function showUpdateModalAvailable(newVersion, releaseNotes = '') {
            closeAllModals();
            const modal = document.getElementById('update-modal');
            const availableState = document.getElementById('update-available-state');
            const latestState = document.getElementById('update-latest-state');
            const versionSpan = document.getElementById('update-version');
            const installBtn = document.getElementById('install-update-btn');
            const notesContainer = document.getElementById('update-notes');
            const notesContent = document.getElementById('update-notes-content');
            
            if (versionSpan) versionSpan.textContent = newVersion;
            if (installBtn) {
                installBtn.disabled = false;
                installBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å';
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–∞—Ç—á–Ω–æ—É—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            if (notesContainer && notesContent) {
                if (releaseNotes && releaseNotes.trim()) {
                    // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ markdown-–ø–æ–¥–æ–±–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                    let formattedNotes = releaseNotes
                        .replace(/^### (.+)$/gm, '<strong class="block mt-2 mb-1">$1</strong>')
                        .replace(/^- (.+)$/gm, '<div class="flex gap-2"><span class="text-claude-accent">‚Ä¢</span><span>$1</span></div>')
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/`(.+?)`/g, '<code class="bg-gray-200 px-1 rounded text-xs">$1</code>')
                        .replace(/\n\n/g, '<br><br>')
                        .replace(/\n/g, '');
                    notesContent.innerHTML = formattedNotes;
                    notesContainer.classList.remove('hidden');
                } else {
                    notesContainer.classList.add('hidden');
                }
            }
            
            if (availableState) availableState.classList.remove('hidden');
            if (latestState) latestState.classList.add('hidden');
            if (modal) modal.classList.add('open');
        }

        function showUpdateModalLatest(currentVersion) {
            closeAllModals();
            const modal = document.getElementById('update-modal');
            const availableState = document.getElementById('update-available-state');
            const latestState = document.getElementById('update-latest-state');
            const versionSpan = document.getElementById('current-version');
            
            if (versionSpan) versionSpan.textContent = currentVersion;
            if (availableState) availableState.classList.add('hidden');
            if (latestState) latestState.classList.remove('hidden');
            if (modal) modal.classList.add('open');
        }

        function hideUpdateModal() {
            const modal = document.getElementById('update-modal');
            if (modal) modal.classList.remove('open');
        }

        async function installUpdate() {
            if (!window.__TAURI__ || !window.__TAURI__.updater) return;
            
            const btn = document.getElementById('install-update-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            }
            
            try {
                const { check } = window.__TAURI__.updater;
                const update = await check();
                
                if (update?.available) {
                    await update.downloadAndInstall();
                    // –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                    const { relaunch } = window.__TAURI__.process;
                    await relaunch();
                }
            } catch (e) {
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –°–ï–ö–¶–ò–Ø 14: –ö–û–ù–¢–ï–ö–°–¢–ù–´–ï –ú–ï–ù–Æ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        /**
         * –°–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
         */
        function hideContextMenu() {
            const menu = document.querySelector('.custom-context-menu');
            if (menu) menu.remove();
        }
        
        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
         * @param {number} x - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X
         * @param {number} y - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y
         * @param {Array<{label?: string, icon?: string, action?: Function, separator?: boolean, disabled?: boolean, submenu?: Array}>} items - –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é
         */
        function showContextMenu(x, y, items) {
            hideContextMenu();
            
            const menu = document.createElement('div');
            menu.className = 'custom-context-menu';
            
            items.forEach(item => {
                if (item.separator) {
                    const sep = document.createElement('div');
                    sep.className = 'context-menu-separator';
                    menu.appendChild(sep);
                    return;
                }
                
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item' + (item.disabled ? ' disabled' : '') + (item.submenu ? ' has-submenu' : '');
                
                if (item.icon) {
                    menuItem.innerHTML = item.icon;
                }
                
                const text = document.createElement('span');
                text.textContent = item.label;
                menuItem.appendChild(text);
                
                // –ü–æ–¥–º–µ–Ω—é
                if (item.submenu) {
                    const arrow = document.createElement('span');
                    arrow.className = 'submenu-arrow';
                    arrow.textContent = '‚ñ∂';
                    menuItem.appendChild(arrow);
                    
                    const submenu = document.createElement('div');
                    submenu.className = 'context-submenu';
                    
                    item.submenu.forEach(subItem => {
                        const subMenuItem = document.createElement('div');
                        subMenuItem.className = 'context-menu-item' + (subItem.checked ? ' checked' : '');
                        
                        if (subItem.checked) {
                            const check = document.createElement('span');
                            check.className = 'submenu-check';
                            check.textContent = '‚úì';
                            subMenuItem.appendChild(check);
                        }
                        
                        const subText = document.createElement('span');
                        subText.textContent = subItem.label;
                        subMenuItem.appendChild(subText);
                        
                        if (subItem.action) {
                            subMenuItem.addEventListener('click', (e) => {
                                e.stopPropagation();
                                hideContextMenu();
                                subItem.action();
                            });
                        }
                        
                        submenu.appendChild(subMenuItem);
                    });
                    
                    menuItem.appendChild(submenu);
                } else if (!item.disabled && item.action) {
                    menuItem.addEventListener('click', () => {
                        hideContextMenu();
                        item.action();
                    });
                }
                
                menu.appendChild(menuItem);
            });
            
            document.body.appendChild(menu);
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
            const rect = menu.getBoundingClientRect();
            if (x + rect.width > window.innerWidth) {
                x = window.innerWidth - rect.width - 10;
            }
            if (y + rect.height > window.innerHeight) {
                y = window.innerHeight - rect.height - 10;
            }
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        
        // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –º–µ–Ω—é (–∏—Å–ø–æ–ª—å–∑—É–µ–º SVG_ICONS)
        const CONTEXT_ICONS = {
            create: SVG_ICONS.plus,
            paste: SVG_ICONS.paste,
            copy: SVG_ICONS.copy,
            rename: SVG_ICONS.rename,
            edit: SVG_ICONS.edit,
            script: SVG_ICONS.script,
            automation: SVG_ICONS.automation,
            attachment: SVG_ICONS.plus, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª—é—Å –¥–ª—è —Ñ–∞–π–ª–æ–≤
            delete: SVG_ICONS.trash
        };
        
        // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ inline
        function renameBlockInline(blockId) {
            const node = document.querySelector(`.workflow-node[data-block-id="${blockId}"]`);
            if (!node) return;
            
            const titleElement = node.querySelector('.workflow-node-title');
            if (!titleElement) return;
            
            const currentTitle = titleElement.textContent;
            
            // –°–æ–∑–¥–∞—ë–º input –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'workflow-title-edit-input';
            input.draggable = false;
            input.style.cssText = `
                width: 100%;
                background: transparent;
                border: none;
                border-bottom: 2px solid rgba(255,255,255,0.8);
                outline: none;
                font-size: 26px;
                font-weight: 600;
                color: white;
                padding: 0;
                cursor: text !important;
                caret-color: white;
                user-select: text;
                -webkit-user-select: text;
            `;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º drag –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å input
            ['mousedown', 'mousemove', 'mouseup'].forEach(evt => {
                input.addEventListener(evt, e => e.stopPropagation());
            });
            ['dragstart', 'drag', 'dragover', 'drop'].forEach(evt => {
                input.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); });
            });
            // –ë–ª–æ–∫–∏—Ä—É–µ–º selectstart –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ
            const header = node.querySelector('.workflow-node-header');
            if (header) {
                header.onselectstart = null;
            }
            
            // –ó–∞–º–µ–Ω—è–µ–º title –Ω–∞ input
            titleElement.style.display = 'none';
            titleElement.parentNode.insertBefore(input, titleElement.nextSibling);
            input.focus();
            input.select();
            
            let saved = false;
            const saveTitle = () => {
                if (saved || !input.parentNode) return; // –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–æ
                saved = true;
                const newTitle = input.value.trim() || currentTitle;
                titleElement.textContent = newTitle;
                titleElement.style.display = '';
                input.remove();
                
                // –£–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                document.removeEventListener('mousedown', handleGlobalClick, true);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –¥–∞–Ω–Ω—ã–µ
                const tabs = getAllTabs();
                if (tabs[currentTab]) {
                    const item = tabs[currentTab].items.find(i => i.id === blockId);
                    if (item) {
                        item.title = newTitle;
                        saveAllTabs(tabs);
                    }
                }
            };
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∏–∫–∞ –≤–Ω–µ input
            const handleGlobalClick = (e) => {
                if (!input.contains(e.target)) {
                    saveTitle();
                }
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –Ω–∞ —Ç–µ–∫—É—â–∏–π –∫–ª–∏–∫
            setTimeout(() => {
                document.addEventListener('mousedown', handleGlobalClick, true);
            }, 10);
            
            input.addEventListener('blur', saveTitle);
            input.addEventListener('keydown', (e) => {
                e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ö–æ—Ç–∫–µ–∏
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTitle();
                }
                if (e.key === 'Escape') {
                    input.value = currentTitle;
                    saveTitle();
                }
            });
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫–∏ –≤ –±—É—Ñ–µ—Ä (–¥–ª—è –ü–ö–ú –∏ Ctrl+C)
        function copyBlocksToClipboard(blockIds) {
            const blocks = getTabBlocks(currentTab);
            
            let minX = Infinity, minY = Infinity;
            blockIds.forEach(id => {
                const pos = workflowPositions[id];
                if (pos) {
                    minX = Math.min(minX, pos.x);
                    minY = Math.min(minY, pos.y);
                }
            });
            
            // –°–æ–∑–¥–∞—ë–º Set –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            const blockIdSet = new Set(blockIds);
            
            // –ö–æ–ø–∏—Ä—É–µ–º –±–ª–æ–∫–∏
            clipboard = [];
            blockIds.forEach(id => {
                const block = blocks.find(b => b.id === id);
                const pos = workflowPositions[id] || {x: 0, y: 0};
                const size = workflowSizes[id];
                if (block) {
                    // –ß–∏—Ç–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â
                    const collapsed = isBlockCollapsed(id);
                    const scripts = getBlockScripts(id);
                    const automation = getBlockAutomationFlags(id);
                    
                    clipboard.push({
                        origId: id,  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                        title: block.title,
                        content: block.content,
                        instruction: block.instruction,
                        collapsed: collapsed || undefined,
                        scripts: scripts && scripts.length > 0 ? [...scripts] : undefined,
                        automation: automation && Object.keys(automation).length > 0 ? {...automation} : undefined,
                        hasAttachments: block.hasAttachments,
                        relX: pos.x - minX,
                        relY: pos.y - minY,
                        origX: pos.x,
                        origY: pos.y,
                        width: size?.width,
                        height: size?.height
                    });
                }
            });
            
            
            // –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏
            window.clipboardConnections = workflowConnections.filter(conn => 
                blockIdSet.has(conn.from) && blockIdSet.has(conn.to)
            ).map(conn => ({
                from: conn.from,
                to: conn.to,
                fromSide: conn.fromSide,
                toSide: conn.toSide
            }));
            
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        async function copyTextToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (err) {
                
            }
        }
        
        // –í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ –≤ textarea
        async function pasteTextFromClipboard(textarea) {
            try {
                const text = await navigator.clipboard.readText();
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const before = textarea.value.substring(0, start);
                const after = textarea.value.substring(end);
                textarea.value = before + text + after;
                textarea.selectionStart = textarea.selectionEnd = start + text.length;
                textarea.focus();
                
                // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                textarea.dispatchEvent(new Event('input', { bubbles: true }));
                textarea.dispatchEvent(new Event('change', { bubbles: true }));
            } catch (err) {
                
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –°–ï–ö–¶–ò–Ø 15: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        document.addEventListener('DOMContentLoaded', () => {
            // –ì–ª–æ–±–∞–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º autocomplete –¥–ª—è –≤—Å–µ—Ö input –∏ textarea
            document.querySelectorAll('input, textarea').forEach(el => {
                el.setAttribute('autocomplete', 'off');
            });
            // –¢–∞–∫–∂–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) {
                            if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA') {
                                node.setAttribute('autocomplete', 'off');
                            }
                            node.querySelectorAll?.('input, textarea').forEach(el => {
                                el.setAttribute('autocomplete', 'off');
                            });
                        }
                    });
                });
            });
            observer.observe(document.body, { childList: true, subtree: true });
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // –ó–ê–©–ò–¢–ê –í–´–î–ï–õ–ï–ù–ò–Ø –¢–ï–ö–°–¢–ê
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ mouseup –≤–Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            document.addEventListener('mousedown', (e) => {
                const target = e.target;
                const isTextElement = target.tagName === 'TEXTAREA' || 
                                      target.tagName === 'INPUT' ||
                                      target.isContentEditable ||
                                      target.closest('textarea, input, [contenteditable="true"]');
                if (isTextElement) {
                    isTextSelecting = true;
                    window.isTextSelecting = true;
                }
            }, true);
            
            document.addEventListener('mouseup', () => {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É—Å–ø–µ–ª–∏ –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
                setTimeout(() => {
                    isTextSelecting = false;
                    window.isTextSelecting = false;
                }, 10);
            }, true);
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
            document.addEventListener('click', (e) => {
                if (e.target.closest('.modal-content')) {
                    e.stopPropagation();
                }
            });
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // –†–ê–ù–ù–Ø–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø TAURI EVENT LISTENERS
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π –î–û —Ç—è–∂—ë–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            // —á—Ç–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫ —Å–æ–±—ã—Ç–∏–π –æ—Ç Rust backend
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ Claude
            let downloadListenersRegistered = false;
            let downloadListenersRetryCount = 0;
            const MAX_DOWNLOAD_LISTENER_RETRIES = 50; // 50 * 50ms = 2.5 —Å–µ–∫ –º–∞–∫—Å–∏–º—É–º
            
            function setupDownloadListeners() {
                if (downloadListenersRegistered) return;
                if (!window.__TAURI__?.event?.listen) {
                    downloadListenersRetryCount++;
                    if (downloadListenersRetryCount < MAX_DOWNLOAD_LISTENER_RETRIES) {
                        // –ë—ã—Å—Ç—Ä—ã–π —Ä–µ—Ç—Ä–∞–π (50–º—Å) –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                        setTimeout(setupDownloadListeners, 50);
                    } else {
                        console.warn('[APM] Tauri event API not available after retries');
                    }
                    return;
                }
                downloadListenersRegistered = true;
                
                window.__TAURI__.event.listen('download-started', (event) => {
                    showToast(`‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞: ${event.payload}`, 2000);
                });
                
                window.__TAURI__.event.listen('download-finished', async (event) => {
                    const { filename, tab, url, file_path } = event.payload;
                    showToast(`‚úÖ –°–∫–∞—á–∞–Ω: ${filename}`, 3000);
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
                    // –ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –¥–æ –¥–µ—Ñ–∏—Å–∞, –∏–ª–∏ –≤—Å—ë –Ω–∞–∑–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –¥–µ—Ñ–∏—Å–∞ –Ω–µ—Ç
                    const tabs = getAllTabs();
                    const currentTabData = tabs[currentTab];
                    const tabName = currentTabData?.name || '';
                    
                    const dashIndex = tabName.indexOf('-');
                    const prefix = dashIndex > 0 ? tabName.slice(0, dashIndex) : tabName;
                    
                    // –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ–µ–∫—Ç–∞ + zip —Ñ–∞–π–ª + –∏–º—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ –≤–∫–ª–∞–¥–∫–∏
                    try {
                        if (isCurrentTabProjectOwner() && 
                            filename.toLowerCase().endsWith('.zip') && 
                            prefix && filename.startsWith(prefix)) {
                            await finishProject();
                        }
                    } catch (e) {
                        console.error('Auto-finish project error:', e);
                    }
                    
                    // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ ‚Äî –Ω–µ –ª–æ–≥–∏—Ä—É–µ–º –≤ archive log
                    if (!prefix || !filename.startsWith(prefix)) return;
                    
                    try {
                        await window.__TAURI__.core.invoke('add_archive_log_entry', {
                            tab: tab,
                            filename: filename,
                            claudeUrl: url
                        });
                    } catch (e) {
                        
                    }
                });
                
                window.__TAURI__.event.listen('download-failed', (event) => {
                    showToast(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${event.payload}`, 3000);
                });
            }
            // –í—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É ‚Äî —Ä–µ—Ç—Ä–∞–π —Å –±—ã—Å—Ç—Ä—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –≤–Ω—É—Ç—Ä–∏
            setupDownloadListeners();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è workflow
            initWorkflow();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø—Ä–æ–µ–∫—Ç—É
            if (typeof restoreProjectState === 'function') {
                restoreProjectState();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ URL –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
            if (typeof initProjectUrlTracking === 'function') {
                initProjectUrlTracking();
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è undo (per-tab)
            setTimeout(() => {
                const initialState = captureCurrentTabState();
                undoStack.push(initialState);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
                tabHistories[currentTab] = {
                    undoStack: [...undoStack],
                    redoStack: [...redoStack]
                };
                isAppInitialized = true; // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                updateUndoRedoButtons();
            }, 500);
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)
            setInterval(() => {
                if (workflowMode && !isResetting) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ textarea
                    document.querySelectorAll('.workflow-node-textarea').forEach(textarea => {
                        const blockId = textarea.dataset.blockId;
                        if (blockId) {
                            saveBlockContent(blockId, textarea.value);
                        }
                    });
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º workflow state
                    saveWorkflowState(true); // skipUndo —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                }
            }, TIMEOUTS.AUTOSAVE);
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ü–ö–ú - –±–ª–æ–∫–∏—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –º–µ–Ω—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ
            document.addEventListener('contextmenu', (e) => {
                // –í—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –º–µ–Ω—é
                e.preventDefault();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–µ–Ω—é –ø—Ä–∏ –ª—é–±–æ–º –∫–ª–∏–∫–µ
                hideContextMenu();
                
                const target = e.target;
                
                // 1. –ü–ö–ú –Ω–∞ —Ö–æ–ª—Å—Ç–µ (–ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ) –≤ edit mode
                const workflowContainer = target.closest('#workflow-container');
                const workflowCanvas = target.closest('#workflow-canvas');
                const isOnNode = target.closest('.workflow-node');
                
                if (workflowMode && isEditMode && workflowCanvas && !isOnNode) {
                    showContextMenu(e.clientX, e.clientY, [
                        {
                            label: '–°–æ–∑–¥–∞—Ç—å –±–ª–æ–∫',
                            icon: CONTEXT_ICONS.create,
                            action: () => {
                                // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –±–ª–æ–∫ –≤ –ø–æ–∑–∏—Ü–∏–∏ –∫–ª–∏–∫–∞
                                const container = getWorkflowContainer();
                                const canvas = getWorkflowCanvas();
                                const scale = workflowZoom || 1;
                                
                                const containerRect = container.getBoundingClientRect();
                                const clickX = (e.clientX - containerRect.left + container.scrollLeft) / scale;
                                const clickY = (e.clientY - containerRect.top + container.scrollTop) / scale;
                                
                                // Snap to grid
                                const gridSize = 40;
                                const newX = Math.round(clickX / gridSize) * gridSize;
                                const newY = Math.round(clickY / gridSize) * gridSize;
                                
                                const newId = generateItemId();
                                const blocks = getTabBlocks(currentTab);
                                const newNumber = blocks.length > 0 ? Math.max(...blocks.map(b => b.number)) + 1 : 1;
                                
                                const tabs = getAllTabs();
                                if (tabs[currentTab]) {
                                    tabs[currentTab].items.push({
                                        id: newId,
                                        type: 'block',
                                        title: `–ë–ª–æ–∫ ${newNumber}`,
                                        content: ''
                                    });
                                    saveAllTabs(tabs);
                                }
                                
                                workflowPositions[newId] = { x: newX, y: newY };
                                renderWorkflow(true);
                                saveWorkflowState(true);
                            }
                        },
                        {
                            label: '–í—Å—Ç–∞–≤–∏—Ç—å',
                            icon: CONTEXT_ICONS.paste,
                            disabled: clipboard.length === 0,
                            action: () => {
                                if (clipboard.length === 0) return;
                                
                                // –í—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏ –≤ –ø–æ–∑–∏—Ü–∏—é –∫–ª–∏–∫–∞
                                const container = getWorkflowContainer();
                                const scale = workflowZoom || 1;
                                
                                const containerRect = container.getBoundingClientRect();
                                const baseX = Math.round(((e.clientX - containerRect.left + container.scrollLeft) / scale) / 40) * 40;
                                const baseY = Math.round(((e.clientY - containerRect.top + container.scrollTop) / scale) / 40) * 40;
                                
                                clearNodeSelection();
                                
                                const tabs = getAllTabs();
                                const newBlockIds = [];
                                const idMapping = {};  // origId -> newId
                                
                                clipboard.forEach(item => {
                                    const newId = generateItemId();
                                    if (item.origId) {
                                        idMapping[item.origId] = newId;
                                    }
                                    
                                    if (tabs[currentTab]) {
                                        const newBlock = {
                                            id: newId,
                                            type: 'block',
                                            title: item.title,
                                            content: item.content,
                                            instruction: item.instruction
                                        };
                                        if (item.hasAttachments) newBlock.hasAttachments = true;
                                        tabs[currentTab].items.push(newBlock);
                                    }
                                    
                                    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                                    if (item.collapsed) {
                                        collapsedBlocks[newId] = true;
                                    }
                                    if (item.scripts && item.scripts.length > 0) {
                                        item.scripts.forEach(scriptKey => {
                                            toggleBlockScript(newId, scriptKey);
                                        });
                                    }
                                    if (item.automation && Object.keys(item.automation).length > 0) {
                                        blockAutomation[newId] = {...item.automation};
                                    }
                                    
                                    workflowPositions[newId] = {
                                        x: baseX + item.relX,
                                        y: baseY + item.relY
                                    };
                                    
                                    if (item.width || item.height) {
                                        workflowSizes[newId] = {
                                            width: item.width,
                                            height: item.height
                                        };
                                    }
                                    
                                    newBlockIds.push(newId);
                                });
                                
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                                saveCollapsedBlocks();
                                saveBlockScripts();
                                saveBlockAutomation();
                                
                                // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º–∏ ID
                                if (window.clipboardConnections && window.clipboardConnections.length > 0) {
                                    window.clipboardConnections.forEach(conn => {
                                        const newFrom = idMapping[conn.from];
                                        const newTo = idMapping[conn.to];
                                        if (newFrom && newTo) {
                                            workflowConnections.push({
                                                from: newFrom,
                                                to: newTo,
                                                fromSide: conn.fromSide,
                                                toSide: conn.toSide
                                            });
                                        }
                                    });
                                }
                                
                                saveAllTabs(tabs);
                                renderWorkflow(true);
                                saveWorkflowState(true);
                                
                                newBlockIds.forEach(id => {
                                    selectedNodes.add(id);
                                    const node = document.querySelector(`.workflow-node[data-block-id="${id}"]`);
                                    node?.classList.add('selected');
                                });
                            }
                        }
                    ]);
                    return;
                }
                
                // 2. –ü–ö–ú –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–µ –±–ª–æ–∫–∞ –≤ edit mode
                const nodeHeader = target.closest('.workflow-node-header');
                const node = target.closest('.workflow-node');
                
                if (workflowMode && isEditMode && nodeHeader && node) {
                    const blockId = node.dataset.blockId;
                    const index = parseInt(node.dataset.index);
                    
                    // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ –≤—ã–¥–µ–ª–µ–Ω–æ
                    if (selectedNodes.size > 1 && selectedNodes.has(blockId)) {
                        showContextMenu(e.clientX, e.clientY, [
                            {
                                label: `–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å (${selectedNodes.size})`,
                                icon: CONTEXT_ICONS.copy,
                                action: () => copyBlocksToClipboard([...selectedNodes])
                            }
                        ]);
                    } else {
                        // –û–¥–∏–Ω –±–ª–æ–∫
                        // –ï—Å–ª–∏ —ç—Ç–æ—Ç –±–ª–æ–∫ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω, –≤—ã–¥–µ–ª—è–µ–º –µ–≥–æ
                        if (!selectedNodes.has(blockId)) {
                            clearNodeSelection();
                            node.classList.add('selected');
                            selectedNodes.add(blockId);
                        }
                        
                        showContextMenu(e.clientX, e.clientY, [
                            {
                                label: '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å',
                                icon: CONTEXT_ICONS.rename,
                                action: () => renameBlockInline(blockId)
                            },
                            {
                                label: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
                                icon: CONTEXT_ICONS.copy,
                                action: () => copyBlocksToClipboard([blockId])
                            },
                            {
                                label: '–°–∫—Ä–∏–ø—Ç',
                                icon: CONTEXT_ICONS.script,
                                submenu: [
                                    {
                                        label: EMBEDDED_SCRIPTS.convert.label,
                                        checked: hasBlockScript(blockId, 'convert'),
                                        action: () => toggleBlockScript(blockId, 'convert')
                                    },
                                    {
                                        label: EMBEDDED_SCRIPTS.count.label,
                                        checked: hasBlockScript(blockId, 'count'),
                                        action: () => toggleBlockScript(blockId, 'count')
                                    }
                                ]
                            },
                            {
                                label: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è',
                                icon: CONTEXT_ICONS.automation,
                                submenu: [
                                    {
                                        label: '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',
                                        checked: hasBlockAutomation(blockId, 'newProject'),
                                        action: () => toggleBlockAutomation(blockId, 'newProject')
                                    },
                                    {
                                        label: '–ù–æ–≤—ã–π —á–∞—Ç',
                                        checked: hasBlockAutomation(blockId, 'newChat'),
                                        action: () => toggleBlockAutomation(blockId, 'newChat')
                                    }
                                ]
                            },
                            {
                                label: '–§–∞–π–ª—ã',
                                icon: CONTEXT_ICONS.attachment,
                                checked: hasBlockAttachmentsPanel(blockId),
                                action: () => toggleAttachmentsPanel(blockId, !hasBlockAttachmentsPanel(blockId))
                            },
                            {
                                label: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                                icon: CONTEXT_ICONS.edit,
                                action: () => editWorkflowNode(index)
                            },
                            { separator: true },
                            {
                                label: '–£–¥–∞–ª–∏—Ç—å',
                                icon: CONTEXT_ICONS.delete,
                                action: () => deleteWorkflowBlock(index)
                            }
                        ]);
                    }
                    return;
                }
                
                // 3. –ü–ö–ú –Ω–∞ textarea –±–ª–æ–∫–∞ –≤ edit mode –∏–ª–∏ –≤ –º–æ–¥–∞–ª–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const nodeTextarea = target.closest('.workflow-node-textarea');
                const workflowEditModal = target.closest('#workflow-edit-modal');
                const modalTextarea = workflowEditModal?.querySelector('textarea');
                const modalInput = workflowEditModal?.querySelector('input[type="text"]');
                const editableField = nodeTextarea || (target.closest('textarea') || target.closest('input[type="text"]'));
                
                if (workflowMode && isEditMode && editableField && (nodeTextarea || workflowEditModal)) {
                    const selectedText = editableField.value.substring(editableField.selectionStart, editableField.selectionEnd);
                    
                    showContextMenu(e.clientX, e.clientY, [
                        {
                            label: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
                            icon: CONTEXT_ICONS.copy,
                            disabled: !selectedText,
                            action: () => selectedText && copyTextToClipboard(selectedText)
                        },
                        {
                            label: '–í—Å—Ç–∞–≤–∏—Ç—å',
                            icon: CONTEXT_ICONS.paste,
                            action: () => pasteTextFromClipboard(editableField)
                        }
                    ]);
                    return;
                }
                
                // –í–µ–∑–¥–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ - –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –º–µ–Ω—é —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ
            document.addEventListener('click', () => {
                hideContextMenu();
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
            document.addEventListener('scroll', () => {
                hideContextMenu();
            }, true);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Ctrl+Z / Ctrl+Y –∏ –¥—Ä—É–≥–∏—Ö –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
            document.addEventListener('keydown', (e) => {
                // F5 - –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                if (e.key === 'F5') {
                    e.preventDefault();
                    location.reload();
                    return;
                }
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ input/textarea
                const activeElement = document.activeElement;
                const isInInput = activeElement && 
                    (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');
                
                // Ctrl+Z / Ctrl+Y - undo/redo (–Ω–µ –≤ input)
                if (!isInInput && e.ctrlKey) {
                    if (e.code === 'KeyZ') {
                        e.preventDefault();
                        undo();
                        return;
                    }
                    if (e.code === 'KeyY') {
                        e.preventDefault();
                        redo();
                        return;
                    }
                }
                
                // Workflow shortcuts (—Ç–æ–ª—å–∫–æ –≤ edit mode –∏ –Ω–µ –≤ input)
                if (workflowMode && isEditMode && !isInInput) {
                    
                    // Del/Backspace - —É–¥–∞–ª–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏
                    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedNodes.size > 0) {
                        e.preventDefault();
                        
                        // –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫
                        selectedNodes.forEach(blockId => {
                            workflowConnections = workflowConnections.filter(
                                c => c.from !== blockId && c.to !== blockId
                            );
                            delete workflowPositions[blockId];
                            delete workflowSizes[blockId];
                            delete collapsedBlocks[blockId];
                            delete blockScripts[blockId];
                            removeItemFromTab(currentTab, blockId);
                        });
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        saveCollapsedBlocks();
                        saveBlockScripts();
                        
                        selectedNodes.clear();
                        renderWorkflow(true);
                        saveWorkflowState(true); // skipUndo - removeItemFromTab —É–∂–µ –∑–∞–ø–∏—Å–∞–ª
                        return;
                    }
                    
                    // Escape - —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    if (e.key === 'Escape' && selectedNodes.size > 0) {
                        e.preventDefault();
                        clearNodeSelection();
                        return;
                    }
                    
                    // Ctrl+A - –≤—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ –±–ª–æ–∫–∏
                    if (e.ctrlKey && e.code === 'KeyA') {
                        e.preventDefault();
                        selectedNodes.clear();
                        document.querySelectorAll('.workflow-node').forEach(node => {
                            node.classList.add('selected');
                            const blockId = node.dataset.blockId;
                            if (blockId) selectedNodes.add(blockId);
                        });
                        return;
                    }
                    
                    // Ctrl+C - –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏
                    if (e.ctrlKey && e.code === 'KeyC') {
                        if (selectedNodes.size === 0) {
                            return;
                        }
                        e.preventDefault();
                        copyBlocksToClipboard([...selectedNodes]);
                        return;
                    }
                    
                    // Ctrl+V - –≤—Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫–∏
                    if (e.ctrlKey && e.code === 'KeyV') {
                        if (clipboard.length === 0) {
                            return;
                        }
                        e.preventDefault();
                        
                        // –ù–∞—Ö–æ–¥–∏–º –±–∞–∑–æ–≤—É—é —Ç–æ—á–∫—É –≥—Ä—É–ø–ø—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π origX, origY)
                        let minOrigX = Infinity, minOrigY = Infinity;
                        clipboard.forEach(item => {
                            if (item.origX !== undefined) minOrigX = Math.min(minOrigX, item.origX);
                            if (item.origY !== undefined) minOrigY = Math.min(minOrigY, item.origY);
                        });
                        
                        // –ï—Å–ª–∏ origX/origY –Ω–µ –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
                        if (minOrigX === Infinity) minOrigX = 120;
                        if (minOrigY === Infinity) minOrigY = 80;
                        
                        // –ë–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ = –±–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞ –≥—Ä—É–ø–ø—ã + —Å–º–µ—â–µ–Ω–∏–µ
                        const offsetX = 80;
                        const offsetY = 80;
                        const baseX = minOrigX + offsetX;
                        const baseY = minOrigY + offsetY;
                        
                        clearNodeSelection();
                        
                        const tabs = getAllTabs();
                        const newBlockIds = [];
                        const idMapping = {};  // origId -> newId
                        
                        clipboard.forEach(item => {
                            const newId = generateItemId();
                            if (item.origId) {
                                idMapping[item.origId] = newId;
                            }
                            
                            if (tabs[currentTab]) {
                                const newBlock = {
                                    id: newId,
                                    type: 'block',
                                    title: item.title,
                                    content: item.content,
                                    instruction: item.instruction
                                };
                                if (item.hasAttachments) newBlock.hasAttachments = true;
                                tabs[currentTab].items.push(newBlock);
                            }
                            
                            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                            if (item.collapsed) {
                                collapsedBlocks[newId] = true;
                            }
                            if (item.scripts && item.scripts.length > 0) {
                                item.scripts.forEach(scriptKey => {
                                    toggleBlockScript(newId, scriptKey);
                                });
                            }
                            if (item.automation && Object.keys(item.automation).length > 0) {
                                blockAutomation[newId] = {...item.automation};
                            }
                            
                            // –ü–æ–∑–∏—Ü–∏—è = –±–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞ + –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã
                            workflowPositions[newId] = {
                                x: baseX + item.relX,
                                y: baseY + item.relY
                            };
                            
                            if (item.width || item.height) {
                                workflowSizes[newId] = {
                                    width: item.width,
                                    height: item.height
                                };
                            }
                            
                            newBlockIds.push(newId);
                        });
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                        saveCollapsedBlocks();
                        saveBlockScripts();
                        saveBlockAutomation();
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º–∏ ID
                        if (window.clipboardConnections && window.clipboardConnections.length > 0) {
                            window.clipboardConnections.forEach(conn => {
                                const newFrom = idMapping[conn.from];
                                const newTo = idMapping[conn.to];
                                if (newFrom && newTo) {
                                    workflowConnections.push({
                                        from: newFrom,
                                        to: newTo,
                                        fromSide: conn.fromSide,
                                        toSide: conn.toSide
                                    });
                                }
                            });
                        }
                        
                        saveAllTabs(tabs);
                        renderWorkflow(true);
                        saveWorkflowState(true); // skipUndo - saveAllTabs —É–∂–µ –∑–∞–ø–∏—Å–∞–ª–∞
                        
                        newBlockIds.forEach(id => {
                            selectedNodes.add(id);
                            const node = document.querySelector(`.workflow-node[data-block-id="${id}"]`);
                            node?.classList.add('selected');
                        });
                        return;
                    }
                    
                    // –°—Ç—Ä–µ–ª–∫–∏ - –¥–≤–∏–≥–∞—Ç—å –±–ª–æ–∫–∏
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key) && selectedNodes.size > 0) {
                        e.preventDefault();
                        const gridSize = 40;
                        
                        selectedNodes.forEach(blockId => {
                            const pos = workflowPositions[blockId];
                            if (pos) {
                                switch (e.key) {
                                    case 'ArrowUp': pos.y = Math.max(gridSize, pos.y - gridSize); break;
                                    case 'ArrowDown': pos.y += gridSize; break;
                                    case 'ArrowLeft': pos.x = Math.max(0, pos.x - gridSize); break;
                                    case 'ArrowRight': pos.x += gridSize; break;
                                }
                                const node = document.querySelector(`.workflow-node[data-block-id="${blockId}"]`);
                                if (node) {
                                    node.style.left = pos.x + 'px';
                                    node.style.top = pos.y + 'px';
                                }
                            }
                        });
                        
                        renderConnections();
                        saveWorkflowState();
                        return;
                    }
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
            window.addEventListener('beforeunload', async () => {
                // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å–ª–∏ –∏–¥—ë—Ç —Å–±—Ä–æ—Å
                if (isResetting) return;
                
                if (isClaudeVisible) {
                    await saveClaudeSettings();
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º workflow
                if (workflowMode) {
                    saveWorkflowState();
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', () => {
                if (workflowMode) {
                    adjustWorkflowScale();
                }
            });
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è drag —Å–∫—Ä–æ–ª–ª–±–∞—Ä–æ–≤ (–æ–¥–∏–Ω —Ä–∞–∑)
            document.addEventListener('mousemove', (e) => {
                if (!activeScrollbarData || !activeScrollbarData.isDragging) return;
                
                const { scrollable, scrollbar, thumb, startY, startScrollTop } = activeScrollbarData;
                const deltaY = e.clientY - startY;
                const scrollHeight = scrollable.scrollHeight;
                const clientHeight = scrollable.clientHeight;
                const trackHeight = scrollbar.clientHeight;
                const thumbHeight = Math.max(30, (clientHeight / scrollHeight) * trackHeight);
                const maxThumbTop = trackHeight - thumbHeight;
                const scrollRatio = (scrollHeight - clientHeight) / maxThumbTop;
                
                scrollable.scrollTop = startScrollTop + deltaY * scrollRatio;
            });
            
            document.addEventListener('mouseup', () => {
                if (activeScrollbarData && activeScrollbarData.isDragging) {
                    activeScrollbarData.isDragging = false;
                    activeScrollbarData.thumb.classList.remove('dragging');
                    activeScrollbarData.scrollbar.classList.remove('active');
                }
            });

            // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            (async () => {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
                initThemeListener();
                
                await initializePersistence(); // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –∏ —Å–±—Ä–æ—Å –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                await initializeDefaultTabs(); // –ü–æ—Ç–æ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                
                // –ï—Å–ª–∏ currentTab –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
                const allTabs = getAllTabs();
                const tabIds = Object.keys(allTabs);
                if (!currentTab || !allTabs[currentTab]) {
                    if (tabIds.length > 0) {
                        const firstTab = Object.values(allTabs).sort((a, b) => (a.order || 0) - (b.order || 0))[0];
                        currentTab = firstTab.id;
                        localStorage.setItem(STORAGE_KEYS.CURRENT_TAB, currentTab);
                    }
                }
                
                loadPrompts(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–æ–∫
                initTabSelector();
                initLanguageSelector();
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –≤–∫–ª–∞–¥–æ–∫
                document.getElementById('confirm-add-tab-btn')?.addEventListener('click', () => {
                    const name = document.getElementById('new-tab-name')?.value?.trim();
                    const errorEl = document.getElementById('add-tab-error');
                    if (!name) {
                        errorEl?.classList.remove('hidden');
                        return;
                    }
                    errorEl?.classList.add('hidden');
                    const newTabId = createNewTab(name);
                    hideAddTabModal();
                    window.switchToTab?.(newTabId);
                    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
                    if (isAdminMode) {
                        isEditMode = true;
                        toggleEditToolbar(true);
                        if (workflowMode) {
                            renderWorkflow();
                        } else {
                            loadPrompts();
                        }
                    }
                });
                
                // Enter –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
                document.getElementById('new-tab-name')?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') document.getElementById('confirm-add-tab-btn')?.click();
                });
            })();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ Undo/Redo
            getUndoBtn()?.addEventListener('click', undo);
            getRedoBtn()?.addEventListener('click', redo);
            
            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–µ–Ω—é —è–∑—ã–∫–æ–≤—ã—Ö —Ñ–æ—Ä–º –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
            function updateLangMenu() {
                const langMenu = document.getElementById('lang-insert-menu');
                if (!langMenu) return;
                
                const lang = LANGUAGES[currentLanguage];
                if (!lang) return;
                
                let html = '<div class="py-1">';
                
                for (const [key, label] of Object.entries(LANG_FORM_LABELS_GLOBAL)) {
                    const value = lang[key];
                    if (value) {
                        html += `<div class="lang-insert-option px-3 py-2 text-xs hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex justify-between items-center" data-form="${key}">
                            <span class="text-claude-accent font-medium">${value}</span>
                            <span class="text-gray-400 text-[10px]">${label}</span>
                        </div>`;
                    }
                }
                
                html += '</div>';
                langMenu.innerHTML = html;
                
                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                langMenu.querySelectorAll('.lang-insert-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const form = option.dataset.form;
                        const value = LANGUAGES[currentLanguage][form];
                        if (value) {
                            insertTextAtCursor(value);
                        }
                        langMenu.classList.add('hidden');
                    });
                });
            }
            
            // –ö–Ω–æ–ø–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —è–∑—ã–∫–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
            const langBtn = document.getElementById('insert-lang-btn');
            const langMenu = document.getElementById('lang-insert-menu');
            if (langBtn && langMenu) {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ—Ç–µ—Ä—é —Ñ–æ–∫—É—Å–∞ —Å textarea
                langBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                });
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ—Ç–µ—Ä—é —Ñ–æ–∫—É—Å–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –º–µ–Ω—é
                langMenu.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                });
                langBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    updateLangMenu(); // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
                    langMenu.classList.toggle('hidden');
                });
            }
            
            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
            const addBlockBtn = document.getElementById('add-block-btn');
            if (addBlockBtn) {
                addBlockBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –±–ª–æ–∫
                    const newId = generateItemId();
                    const blocks = getTabBlocks(currentTab);
                    const newNumber = blocks.length > 0 ? Math.max(...blocks.map(b => b.number)) + 1 : 1;
                    
                    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ (—Å–ø—Ä–∞–≤–∞ –æ—Ç –≤–µ—Ä—Ö–Ω–∏—Ö –±–ª–æ–∫–æ–≤)
                    let newX = 40, newY = 40;
                    if (blocks.length > 0) {
                        // –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º Y (–≤–µ—Ä—Ö–Ω–∏–π —Ä—è–¥)
                        let minY = Infinity;
                        let maxXAtMinY = 0;
                        let widthAtMaxX = 700;
                        
                        blocks.forEach(block => {
                            const pos = workflowPositions[block.id];
                            const size = workflowSizes[block.id];
                            if (pos) {
                                if (pos.y < minY) {
                                    minY = pos.y;
                                    maxXAtMinY = pos.x;
                                    widthAtMaxX = size?.width || 700;
                                } else if (pos.y === minY && pos.x > maxXAtMinY) {
                                    maxXAtMinY = pos.x;
                                    widthAtMaxX = size?.width || 700;
                                }
                            }
                        });
                        
                        newX = maxXAtMinY + widthAtMaxX + 80;
                        newY = minY;
                        
                        // –ï—Å–ª–∏ —É—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –≤–∏–¥–∏–º–æ—Å—Ç–∏, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ä—è–¥
                        if (newX > 4000) {
                            newX = 40;
                            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Y + –≤—ã—Å–æ—Ç—É
                            let maxYBottom = 0;
                            blocks.forEach(block => {
                                const pos = workflowPositions[block.id];
                                const size = workflowSizes[block.id];
                                if (pos) {
                                    const bottom = pos.y + (size?.height || 400);
                                    maxYBottom = Math.max(maxYBottom, bottom);
                                }
                            });
                            newY = maxYBottom + 80;
                        }
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –¥–∞–Ω–Ω—ã–µ
                    const tabs = getAllTabs();
                    if (tabs[currentTab]) {
                        tabs[currentTab].items.push({
                            id: newId,
                            type: 'block',
                            title: `–ë–ª–æ–∫ ${newNumber}`,
                            content: ''
                        });
                        saveAllTabs(tabs);
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
                    workflowPositions[newId] = { x: newX, y: newY };
                    
                    // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–∫—Ä–æ–ª–ª–∞
                    renderWorkflow(true);
                    saveWorkflowState(true); // skipUndo - saveAllTabs —É–∂–µ –∑–∞–ø–∏—Å–∞–ª–∞
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –Ω–∏—Ö
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#insert-lang-btn') && !e.target.closest('#lang-insert-menu')) {
                    document.getElementById('lang-insert-menu')?.classList.add('hidden');
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            document.getElementById('add-constructor-field-btn')?.addEventListener('click', () => {
                addConstructorFieldElement();
            });
            
            document.getElementById('save-constructor-btn')?.addEventListener('click', () => {
                saveConstructorFields();
            });
            
            // –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
            document.querySelectorAll('#constructor-icon-selector .icon-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#constructor-icon-selector .icon-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
            document.getElementById('input-constructor-modal')?.addEventListener('mousedown', (e) => {
                if (e.target.id === 'input-constructor-modal') {
                    hideInputConstructorModal();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –º–æ–¥–∞–ª–∫–∏ –≤–≤–æ–¥–∞
            document.getElementById('apply-dynamic-input-btn')?.addEventListener('click', () => {
                applyDynamicInput();
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
            document.getElementById('dynamic-input-modal')?.addEventListener('mousedown', (e) => {
                if (e.target.id === 'dynamic-input-modal') {
                    hideDynamicInputModal();
                }
            });
            
            // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('exit-edit-mode-btn')?.addEventListener('click', () => {
                isEditMode = false;
                toggleEditToolbar(false);
                if (workflowMode) {
                    renderWorkflow();
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –Ω–∞ –±–ª–æ–∫–∞—Ö –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ edit mode
                    setTimeout(() => scrollToBlocks(), 50);
                } else {
                    loadPrompts();
                }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Claude –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
            initClaudeHandlers();
            
            // –°–æ–∑–¥–∞—ë–º –≥–ª–∞–≤–Ω—ã–π –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä
            const scrollContainer = document.getElementById('scroll-container');
            const mainScrollbar = document.createElement('div');
            mainScrollbar.className = 'main-scrollbar';
            mainScrollbar.innerHTML = '<div class="main-scrollbar-thumb"></div>';
            document.body.appendChild(mainScrollbar);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞
            initCustomScrollbar(scrollContainer, mainScrollbar);
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–µ—Ä—Ö" —Å–∫—Ä–æ–ª–ª–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∞ –Ω–µ –æ–∫–Ω–æ
            document.getElementById('scroll-top-btn').addEventListener('click', () => {
                if (workflowMode) {
                    getWorkflowContainer().scrollTo({top: 0, behavior: 'smooth'});
                } else {
                    document.getElementById('scroll-container').scrollTo({top: 0, behavior: 'smooth'});
                }
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ UI
            document.getElementById('refresh-btn').addEventListener('click', () => {
                location.reload();
            });
            
            // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    showResetModal();
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞
            document.getElementById('confirm-reset-btn')?.addEventListener('click', confirmReset);
            document.getElementById('cancel-reset-btn')?.addEventListener('click', hideResetModal);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ cancel –∫–Ω–æ–ø–æ–∫ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.getElementById('cancel-edit-mode-btn')?.addEventListener('click', hideEditModeConfirmModal);
            document.getElementById('cancel-constructor-btn')?.addEventListener('click', hideInputConstructorModal);
            document.getElementById('cancel-dynamic-input-btn')?.addEventListener('click', hideDynamicInputModal);
            document.getElementById('settings-close-btn')?.addEventListener('click', hideSettingsModal);
            document.getElementById('close-archive-log-btn')?.addEventListener('click', hideArchiveLogModal);
            document.getElementById('cancel-add-tab-btn')?.addEventListener('click', hideAddTabModal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–±—Ä–æ—Å–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
            document.getElementById('reset-modal').addEventListener('click', (event) => {
                if (event.target.id === 'reset-modal') {
                    hideResetModal();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞
            document.getElementById('import-confirm-btn')?.addEventListener('click', () => hideImportConfirm(true));
            document.getElementById('import-cancel-btn')?.addEventListener('click', () => hideImportConfirm(false));
            document.getElementById('import-confirm-modal')?.addEventListener('click', (event) => {
                if (event.target.id === 'import-confirm-modal') {
                    hideImportConfirm(false);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            document.getElementById('alert-ok-btn')?.addEventListener('click', hideAlert);
            document.getElementById('alert-modal')?.addEventListener('click', (event) => {
                if (event.target.id === 'alert-modal') {
                    hideAlert();
                }
            });
            
            // –ò–∫–æ–Ω–∫–∞ –≤ —Ö–µ–¥–µ—Ä–µ - —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (–∫–ª–∏–∫ —É–±—Ä–∞–Ω)
            // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–µ–ø–µ—Ä—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const updateModal = document.getElementById('update-modal');
            const installBtn = document.getElementById('install-update-btn');
            const laterBtn = document.getElementById('update-later-btn');
            const okBtn = document.getElementById('update-ok-btn');
            
            if (installBtn) {
                installBtn.addEventListener('click', installUpdate);
            }
            if (laterBtn) {
                laterBtn.addEventListener('click', hideUpdateModal);
            }
            if (okBtn) {
                okBtn.addEventListener('click', hideUpdateModal);
            }
            if (updateModal) {
                updateModal.addEventListener('click', (event) => {
                    if (event.target.id === 'update-modal') {
                        hideUpdateModal();
                    }
                });
            }
            
            // –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            // –ü–æ—Ä—è–¥–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞, –ø–æ—Ç–æ–º –ø—Ä–æ–º–ø—Ç—ã
            setTimeout(async () => {
                const settings = getSettings();
                
                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
                if (settings.autoUpdate) {
                    try {
                        const result = await checkForUpdates(false);
                        if (result?.available) {
                            showUpdateModalAvailable(result.version, result.body);
                            return; // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–ø—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
                        }
                    } catch (e) {
                        console.warn('[Init] App update check failed:', e);
                    }
                }
                
                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–æ–≤ (–≤—Å–µ–≥–¥–∞)
                if (typeof autoCheckPromptsUpdates === 'function') {
                    try {
                        await autoCheckPromptsUpdates();
                    } catch (e) {
                        console.warn('[Init] Prompts update check failed:', e);
                    }
                }
            }, 1000);
            
            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ù–ê–°–¢–†–û–ï–ö ---
            
            // –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('settings-btn')?.addEventListener('click', showSettingsModal);
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            // –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            document.getElementById('auto-update-off')?.addEventListener('click', () => {
                toggleAutoUpdate(false);
                updateAutoUpdateButtons(false);
            });
            document.getElementById('auto-update-on')?.addEventListener('click', () => {
                toggleAutoUpdate(true);
                updateAutoUpdateButtons(true);
            });
            
            // –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
            document.getElementById('manual-update-check-btn')?.addEventListener('click', async () => {
                const btn = document.getElementById('manual-update-check-btn');
                btn.classList.add('checking');
                try {
                    await checkForUpdates(true); // true = –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                } finally {
                    btn.classList.remove('checking');
                }
            });
            
            // –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–æ–≤
            document.getElementById('manual-prompts-check-btn')?.addEventListener('click', async () => {
                const btn = document.getElementById('manual-prompts-check-btn');
                btn.classList.add('checking');
                try {
                    await checkForPromptsUpdate(true); // true = –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                } finally {
                    btn.classList.remove('checking');
                }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
            if (typeof initPromptsUpdateHandlers === 'function') {
                initPromptsUpdateHandlers();
            }
            
            // –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã
            document.getElementById('theme-light')?.addEventListener('click', () => setTheme('light'));
            document.getElementById('theme-auto')?.addEventListener('click', () => setTheme('auto'));
            document.getElementById('theme-dark')?.addEventListener('click', () => setTheme('dark'));
            
            // –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞)
            document.getElementById('import-file-input')?.addEventListener('change', handleImportFile);
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('edit-mode-off')?.addEventListener('click', () => {
                if (isAdminMode) {
                    isAdminMode = false;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    const settings = getSettings();
                    settings.adminMode = false;
                    saveSettings(settings);
                    // –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–∏–ª–∏ - –≤—ã–∫–ª—é—á–∞–µ–º –∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    if (isEditMode) {
                        isEditMode = false;
                        if (workflowMode) {
                            renderWorkflow();
                        } else {
                            loadPrompts();
                        }
                    }
                    updateEditModeToggle();
                    showToast('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω');
                }
            });
            
            document.getElementById('edit-mode-on')?.addEventListener('click', () => {
                if (!isAdminMode) {
                    showEditModeConfirmModal();
                }
            });
            
            document.getElementById('confirm-edit-mode-btn')?.addEventListener('click', () => {
                isAdminMode = true;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const settings = getSettings();
                settings.adminMode = true;
                saveSettings(settings);
                updateEditModeToggle();
                hideEditModeConfirmModal();
                showToast('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á—ë–Ω');
            });
            
            // –†–∞–∑–¥–µ–ª "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            document.getElementById('advanced-settings-toggle')?.addEventListener('click', () => {
                const content = document.getElementById('advanced-settings-content');
                const arrow = document.getElementById('advanced-settings-arrow');
                if (content && arrow) {
                    content.classList.toggle('hidden');
                    arrow.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
                }
            });
            
            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–ø–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            document.getElementById('open-app-data-btn')?.addEventListener('click', async () => {
                try {
                    if (window.__TAURI__) {
                        await window.__TAURI__.core.invoke('open_app_data_dir');
                    } else {
                        showToast('–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
                    }
                } catch (e) {
                    
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É');
                }
            });
            
            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ª–æ–≥–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
            document.getElementById('open-archive-log-btn')?.addEventListener('click', async () => {
                await showArchiveLogModal();
            });
            
            // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
            document.getElementById('clear-archive-log-btn')?.addEventListener('click', async () => {
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –ª–æ–≥ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π?')) {
                    try {
                        await window.__TAURI__.core.invoke('clear_archive_log');
                        await showArchiveLogModal(); // –û–±–Ω–æ–≤–ª—è–µ–º
                        showToast('–õ–æ–≥ –æ—á–∏—â–µ–Ω');
                    } catch (e) {
                        
                    }
                }
            });
            
            // –ü–æ–∏—Å–∫ –≤ –ª–æ–≥–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
            document.getElementById('archive-log-search')?.addEventListener('input', (e) => {
                const search = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#archive-log-tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(search) ? '' : 'none';
                });
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ mousedown –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
            const modalCloseHandlers = [
                ['edit-mode-confirm-modal', hideEditModeConfirmModal],
                ['settings-modal', hideSettingsModal],
                ['archive-log-modal', hideArchiveLogModal],
                ['add-tab-modal', hideAddTabModal],
                ['reset-modal', hideResetModal],
                ['input-constructor-modal', hideInputConstructorModal],
                ['dynamic-input-modal', hideDynamicInputModal]
            ];
            
            modalCloseHandlers.forEach(([id, handler]) => {
                document.getElementById(id)?.addEventListener('mousedown', (e) => {
                    if (e.target.id === id) handler();
                });
            });
        });

    </script>
</body>
</html>
