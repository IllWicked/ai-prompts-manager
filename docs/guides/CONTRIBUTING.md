# Работа с проектом

[← Назад к INDEX](../INDEX.md)

> **Внутренний проект** — документация для себя после перерыва в разработке.

> **Новый разработчик?** Начни с [QUICKSTART.md](QUICKSTART.md)

## Связанные документы

| Документ | Описание |
|----------|----------|
| [QUICKSTART](QUICKSTART.md) | Быстрый старт |
| [TESTING](TESTING.md) | Чеклист тестирования |
| [LIMITATIONS](../reference/LIMITATIONS.md) | Ограничения и edge cases |
| [GLOSSARY](../reference/GLOSSARY.md) | Глоссарий терминов |
| [TROUBLESHOOTING-SELECTORS](../reference/TROUBLESHOOTING-SELECTORS.md) | Диагностика селекторов Claude |

---

## Разработка

### Запуск в dev-режиме

```bash
cd src-tauri
cargo tauri dev
```

### Сборка

```bash
cd src-tauri
cargo tauri build
```

## Обновление при изменениях Claude.ai

Claude.ai периодически обновляет разметку. Если что-то сломалось:

### Симптомы

- Сайдбар не скрывается
- Отправка промптов не работает
- Мониторинг генерации не работает

→ **Полная инструкция по диагностике и исправлению:** [TROUBLESHOOTING-SELECTORS.md](../reference/TROUBLESHOOTING-SELECTORS.md)

### Быстрое исправление (TL;DR)

1. F12 в Claude WebView → найди элемент через Inspector
2. Обнови селектор в `src-tauri/scripts/selectors.json`
3. Перезапусти `cargo tauri dev`

## Project Binding (привязка к проектам)

Система позволяет привязать вкладку APM к проекту Claude.

### Как работает

1. Пользователь отправляет блок с флагом "Новый проект" (P)
2. `createProjectViaAPI()` создаёт проект через внутренний API Claude
3. UUID сохраняется, текущая вкладка APM становится "владельцем"
4. Кнопки "Чат" скрыты на других вкладках APM
5. При скачивании архива из этого проекта — привязка завершается

### Продолжение проекта

При открытии страницы проекта в Claude автоматически появляется кнопка "Продолжить проект":
- `checkForContinueProject()` — автопроверка URL
- `continueProject()` — привязка к найденному проекту
- `initProjectUrlTracking()` — отслеживание URL

### Технические детали

Создание проекта и чатов использует CDP (Chrome DevTools Protocol):
- `eval_in_claude_with_result()` — выполняет JS с `awaitPromise: true`
- Результат fetch возвращается напрямую без модификации URL
- `invalidateOrgCache()` — сброс кэша при подозрении на смену аккаунта

## File Attachments (вложения файлов)

### Прикрепление к блоку

1. ПКМ по блоку → "Прикрепить файлы"
2. Выбор файлов в диалоге
3. Файлы отображаются в панели вложений под блоком

### При отправке

1. Файлы конвертируются в base64
2. Прикрепляются к input Claude через `attach_file_to_claude`
3. Ожидается загрузка через счётчик `waitForFilesUploaded`

## Dynamic Input (динамические поля)

### Конструктор полей

1. ПКМ по блоку → "Добавить инструкцию" → "Ввод с заменой"
2. Клик по кнопке инструкции → "Настроить поля"
3. Добавление/редактирование полей с label, placeholder, prefix

### Использование

1. Клик по кнопке инструкции → модалка с полями
2. Ввод значений → применение в текст промпта
3. Опциональные поля можно скрывать/показывать

## Language System (языковая система)

### Автосклонение

Система автоматически генерирует все 24 падежных формы прилагательных из базовой формы (им.п. м.р.):
- `generateAdjectiveForms()` — генерация всех форм
- `transformWord()` — преобразование с сохранением падежа

### Автодетекция

При переключении вкладки APM язык определяется автоматически:
- `detectAndUpdateLanguageFromTab()` — анализ контента
- `detectLanguageInText()` — поиск любой формы слова языка

### Замена языков

При смене языка в селекторе:
- `changeLanguage()` автоматически заменяет все формы во всех блоках
- Базовые формы языков определены в `languages.js`

## Theme System (темы)

### Поддерживаемые темы

- `light` — светлая
- `dark` — тёмная
- `system` — следует за системой

### Синхронизация с окном

`syncWindowBackground()` — устанавливает цвет фона окна Tauri через команду `set_window_background`.

## Debug Mode

Для детального логирования установи `DEBUG = true` в `dist/js/config.js`.

## Project Manager (project-manager.py)

Скрипт для управления промптами и релизами находится в папке `project-manager/`.

### Что делает

**Промпты:**
- Импорт вкладок из JSON файлов
- Переименование и удаление вкладок
- Изменение порядка вкладок
- Push промптов на GitHub (автоматическое обновление версий)

**Релизы:**
- Изменение версии приложения (tauri.conf.json, Cargo.toml, index.html)
- Редактирование Release Notes
- Создание тега и push на GitHub (триггерит сборку)

### Использование

```bash
cd project-manager
python project-manager.py
```

Откроется интерактивное меню.

### Добавление/обновление вкладки

1. Экспортируй вкладку из приложения (Настройки → Экспорт)
2. Положи JSON-файл в папку `project-manager/` (рядом со скриптом)
3. Запусти `cd project-manager && python project-manager.py`
4. Выбери "Push" → подтверди отправку на GitHub

### Структура промптов

Промпты хранятся в папке `prompts/`:

| Файл | Описание |
|------|----------|
| `manifest.json` | Манифест с версиями и метаданными |
| `*.json` | JSON файлы отдельных вкладок |

Приложение загружает промпты с GitHub при первом запуске и автоматически проверяет обновления.

## Troubleshooting

> **Подробнее об ограничениях:** [LIMITATIONS.md](../reference/LIMITATIONS.md)

### Приложение не запускается

- Убедись, что установлен WebView2 Runtime
- Попробуй запустить от имени администратора
- Проверь антивирус — может блокировать

### Claude WebView пустой/белый

- Проверь интернет-соединение
- Открой claude.ai в браузере — работает?
- Сбрось данные: Настройки → Сбросить всё

### Кнопка "Отправить в Claude" не работает

- Claude.ai мог обновить разметку
- См. [04-CLAUDE.md](../04-CLAUDE.md#обновление-селекторов)
- Проверь консоль Claude WebView (F12)

### Файлы не прикрепляются

- Проверь что файл существует
- Проверь консоль на ошибки
- Попробуй файл меньшего размера (< 10 MB)

### Workflow не сохраняется

- Проверь свободное место в localStorage (F12 → Application)
- Экспортируй данные и сбрось приложение
- См. [LIMITATIONS.md](../reference/LIMITATIONS.md#localstorage-5-10-mb-лимит)

### Автообновление не работает

- Проверь интернет
- Убедись, что endpoint в tauri.conf.json правильный
- Проверь, что релиз опубликован на GitHub

### CDP Timeout при создании проекта

- Увеличь timeout в вызове (до 30 сек)
- Проверь интернет-соединение
- См. [LIMITATIONS.md](../reference/LIMITATIONS.md#cdp-timeout)

---

## Чеклист перед релизом

→ Полный чеклист: [TESTING.md](TESTING.md)

```
□ Приложение запускается
□ Claude WebView загружается
□ Отправка блоков работает
□ Прикрепление файлов работает
□ Workflow сохраняется
□ Export/Import работает
□ Темы переключаются
```

---

## Структура кода

См. [01-OVERVIEW.md](../01-OVERVIEW.md) и [02-FRONTEND.md](../02-FRONTEND.md)
