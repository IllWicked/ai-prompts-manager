# Тестирование

[← Назад к INDEX](../INDEX.md)

## Unit-тесты (Jest)

> **Статус:** ✅ Реализовано (v4.2.0)
> 
> **Детали:** [UNIT-TESTS-PLAN.md](../UNIT-TESTS-PLAN.md) | [tests/README.md](../../tests/README.md)

### Запуск тестов

```bash
# Все тесты
npm test

# С watch mode
npm run test:watch

# Конкретный модуль
npm run test:storage
npm run test:tabs
npm run test:undo
npm run test:workflow
npm run test:utils
npm run test:export-import
```

### Статистика

| Метрика | Значение |
|---------|----------|
| Test Suites | 7 passed |
| Tests | 260 passed, 5 skipped |
| Время | ~3.6s |

### Покрытие по модулям

| Модуль | Тестов | Описание |
|--------|--------|----------|
| storage.js | 52 | Валидация, repair, localStorage |
| tabs.js | 51 | CRUD вкладок, переименование |
| undo.js | 44 | Undo/redo, debounce, per-tab history |
| connections.js | 35 | Связи workflow, проверка циклов |
| utils.js | 39 | escapeHtml, debounce, ID генерация |
| export-import.js | 28 | Export/import циклы |

---

## Перед каждым релизом

### Базовый чеклист

- [ ] Приложение запускается без ошибок
- [ ] Claude WebView загружается
- [ ] Темная/светлая тема переключается
- [ ] Данные сохраняются после перезапуска
- [ ] Селекторы Claude работают (обновить дату в TROUBLESHOOTING-SELECTORS.md)

---

## Тестирование по компонентам

### UI / Workflow

| Действие | Ожидаемый результат |
|----------|---------------------|
| Создать блок | Блок появляется на canvas |
| Переместить блок | Позиция сохраняется после перезагрузки |
| Изменить размер блока | Размер сохраняется |
| Создать связь между блоками | Линия отрисовывается, связь сохраняется |
| Удалить связь | Линия исчезает |
| Ctrl+Z | Отмена последнего действия |
| Ctrl+Y | Повтор действия |
| Ctrl+A | Выделение всех блоков |
| Delete | Удаление выделенных блоков |
| Ctrl+C / Ctrl+V | Копирование и вставка блоков |
| Свернуть блок | Блок сворачивается, состояние сохраняется |
| Zoom (Ctrl+Scroll) | Масштаб изменяется плавно |
| Pan (Middle Mouse) | Canvas перемещается |

### Export / Import

| Действие | Ожидаемый результат |
|----------|---------------------|
| Экспорт вкладки | Скачивается JSON файл |
| Импорт вкладки | Вкладка появляется, данные корректны |
| Импорт с позициями workflow | Позиции восстанавливаются |
| Импорт без позиций | Автоматическое размещение |

### Claude интеграция

| Действие | Ожидаемый результат |
|----------|---------------------|
| Показать панель Claude | Панель появляется с анимацией |
| Скрыть панель | Панель скрывается |
| Переключить таб Claude (1/2/3) | Таб переключается |
| Отправить блок в Claude | Текст вставляется, сообщение отправляется |
| Прикрепить файл к блоку | Файл отображается в панели вложений |
| Отправить блок с файлом | Файл прикрепляется к сообщению |
| Создать новый проект (флаг P) | Проект создается через API |
| Создать новый чат (флаг N) | Открывается новый чат |
| Мониторинг генерации | Кнопка показывает статус генерации |
| Закрыть таб Claude | Таб закрывается, данные сохраняются |

### Downloads Manager

| Действие | Ожидаемый результат |
|----------|---------------------|
| Скачать файл из Claude | Файл появляется в списке |
| Открыть скачанный файл | Файл открывается в системе |
| Отправить файл в Claude | Файл прикрепляется к input |
| Multi-select (Shift+click) | Несколько файлов выделяются |
| Удалить файл из списка | Запись удаляется |
| Изменить путь загрузок | Новый путь сохраняется |

### Настройки

| Действие | Ожидаемый результат |
|----------|---------------------|
| Переключить тему (Light/Dark/System) | Тема применяется сразу |
| Переключить автообновление | Настройка сохраняется |
| Сбросить приложение | Данные очищаются, кроме downloads path |
| Archive Log | Записи отображаются, ссылки работают |

### Обновления

| Действие | Ожидаемый результат |
|----------|---------------------|
| Проверить обновления приложения | Показывается статус |
| Проверить обновления промптов | Показывается модалка или "актуально" |
| Применить обновление промптов | Вкладки обновляются |

---

## Тестирование после изменений

### После изменения селекторов Claude

```
□ Левый сайдбар скрывается корректно
□ Отправка сообщения работает
□ Мониторинг генерации работает
□ Прикрепление файлов работает
□ Ghost button не появляется
```

### После изменения Tauri commands

```
□ Команда работает в dev режиме
□ Команда работает в production build
□ Ошибки обрабатываются корректно (try/catch)
□ Параметры валидируются
```

### После изменения workflow

```
□ Блоки рендерятся корректно
□ Позиции сохраняются
□ Связи отрисовываются
□ Undo/Redo работает
□ Копирование сохраняет связи
```

### После изменения системы обновлений

```
□ Манифест загружается с GitHub
□ Версии сравниваются корректно
□ Новые вкладки добавляются
□ Обновленные вкладки мержатся
□ Кастомные вкладки не перезаписываются
```

---

## Проверка в разных условиях

### Без интернета

```
□ Приложение запускается
□ Локальные данные доступны
□ Сообщение об ошибке при проверке обновлений
□ Claude показывает страницу ошибки
```

### При большом объеме данных

```
□ 50+ блоков в одной вкладке
□ 10+ вкладок
□ Workflow с множеством связей
□ Производительность приемлема
```

### После сброса приложения

```
□ localStorage очищен
□ Дефолтные вкладки загружаются
□ Путь загрузок сохранен
□ Archive log сохранен (backup)
```

---

## Автоматические проверки при запуске

Приложение автоматически проверяет:

1. **Версия данных** — при изменении версии выполняется миграция или сброс
2. **Структура вкладок** — невалидные вкладки восстанавливаются
3. **Селекторы Claude** — fallback на альтернативные селекторы
4. **WebView загрузка** — retry механизм (до 3 попыток, 10 сек таймаут)

---

## Логирование для отладки

### Включить debug логи

```javascript
// dist/js/config.js
const DEBUG = true;
```

### Что логируется

- `[APM]` — общие логи приложения
- Tauri events — события от backend
- CDP результаты — ответы из Claude WebView

### Где смотреть

| WebView | Как открыть DevTools |
|---------|---------------------|
| Main (UI) | F12 в окне приложения |
| Claude | F12 когда панель Claude активна |
| Toolbar | Правый клик → Inspect (если доступно) |

---

## Связанные документы

- [CONTRIBUTING.md](CONTRIBUTING.md) — Разработка и troubleshooting
- [../reference/LIMITATIONS.md](../reference/LIMITATIONS.md) — Известные ограничения
- [../reference/FAQ.md](../reference/FAQ.md) — Часто задаваемые вопросы
- [QUICKSTART.md](QUICKSTART.md) — Быстрый старт
