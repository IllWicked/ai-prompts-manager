# Ограничения и Edge Cases

[← Назад к INDEX](../INDEX.md)

## Системные требования

| Компонент | Минимальная версия | Рекомендуемая |
|-----------|-------------------|---------------|
| **Windows** | 10 (1809+) | 11 |
| **WebView2 Runtime** | 100.0 | Latest |
| **Rust** | 1.75+ | 1.80+ |
| **Node.js** | 18+ | 20+ LTS |
| **RAM** | 4 GB | 8 GB+ |
| **Диск** | 200 MB | 500 MB+ |

> **Примечание:** Каждый Claude WebView занимает ~200-500 MB RAM.

---

## Известные ограничения

### localStorage (~5-10 MB лимит)

**Проблема:** Браузерный localStorage имеет ограничение ~5-10 MB в зависимости от браузера.

**Симптомы:**
- Данные перестают сохраняться
- Ошибки в консоли: `QuotaExceededError`
- Потеря данных при перезапуске

**Решения:**
1. Экспортируй старые вкладки в файлы
2. Удали неиспользуемые вкладки
3. Очисти workflow-позиции для неактивных вкладок

**Мониторинг:**
```javascript
// Проверить использование localStorage
let total = 0;
for (let key in localStorage) {
    if (localStorage.hasOwnProperty(key)) {
        total += localStorage[key].length * 2; // UTF-16
    }
}
console.log('localStorage used:', (total / 1024 / 1024).toFixed(2), 'MB');
```

---

### Claude.ai обновления

**Проблема:** Claude.ai регулярно обновляет разметку без предупреждения.

**Симптомы:**
- Сайдбар не скрывается
- Отправка сообщений не работает
- Мониторинг генерации сломан
- Ghost button появляется

**Решение:** Обновить селекторы в `src-tauri/scripts/selectors.json`

→ См. [04-CLAUDE.md](../04-CLAUDE.md#обновление-селекторов)

---

### CDP Timeout

**Проблема:** Операции через CDP имеют таймаут (5-30 сек в зависимости от типа).

**Симптомы:**
- Создание проекта "зависает"
- Ошибка "CDP timeout"

→ Подробнее о таймаутах и решениях: [03-BACKEND.md#cdp-timeouts](../03-BACKEND.md#cdp-timeouts)

---

### Максимум 3 таба Claude

**Ограничение:** Приложение поддерживает только 3 независимых чата Claude.

**Причина:** Архитектурное решение для баланса памяти и удобства.

**Workaround:** Использовать "Новый чат" (флаг N) вместо создания нового таба.

---

### WebView2 Runtime

**Требование:** WebView2 Runtime должен быть установлен на Windows.

**Симптомы:**
- Приложение не запускается
- Ошибка "WebView2 not found"

**Решение:** Установить [WebView2 Runtime](https://developer.microsoft.com/en-us/microsoft-edge/webview2/)

---

### Только Windows

**Ограничение:** Приложение работает только на Windows из-за:
- WebView2 (Windows-only)
- Windows-specific APIs в Rust коде

---

### Только онлайн режим

**Ограничение:** Claude.ai требует интернет-соединение.

**Что работает офлайн:**
- Редактирование локальных вкладок
- Workflow редактор
- Export/Import

**Что не работает офлайн:**
- Панель Claude
- Проверка обновлений
- Создание проектов

---

## Edge Cases

### Одновременное редактирование

**Случай:** Открыто несколько окон приложения.

**Поведение:** Последнее сохранение перезаписывает данные.

**Рекомендация:** Использовать только одно окно приложения.

---

### Большие файлы вложений

**Ограничение:** 
- Максимальный размер файла: **50 MB** (константа `MAX_ATTACHMENT_SIZE`)
- Файлы конвертируются в base64, что увеличивает размер ~33%

**Поведение:**
- При превышении лимита — ошибка с указанием размера
- Файл не читается в память, ошибка возвращается сразу

**Рекомендация:** Для оптимальной производительности не прикреплять файлы > 10 MB.

---

### Циклические связи

**Защита:** Система предотвращает создание циклов в workflow.

```javascript
// wouldCreateCycle() проверяет перед добавлением связи
if (wouldCreateCycle(fromBlockId, toBlockId)) {
    // Связь не создаётся
}
```

---

### Дубликаты ID вкладок

**Защита:** При создании вкладки проверяется уникальность ID.

**Edge case:** При импорте вкладки с существующим ID предлагается:
- Перезаписать
- Создать с новым ID
- Отменить

---

### Потеря фокуса при drag

**Случай:** Drag начат, но мышь ушла за пределы окна.

**Защита:** `resetDragResizeState()` вызывается при потере фокуса.

---

### Retry механизм Claude табов

**При создании табов 2/3:**

1. WebView создаётся, начинается загрузка
2. Ожидание события `claude-page-loaded` до 10 сек
3. Таймаут → `reload_claude_tab()`
4. До 3 попыток
5. Максимум 30 сек на таб

---

### Race condition при быстром переключении

**Случай:** Быстрое переключение между вкладками APM.

**Защита:** Debounce на сохранении (2 сек).

---

### Обновление Remote Prompts

**Важно:** При обновлении remote промптов вкладка полностью перезаписывается.

**Симптомы потери данных:**
- Пользователь изменил содержимое remote вкладки
- Вышло обновление промптов
- После обновления все пользовательские изменения потеряны

**Рекомендации:**
1. Для кастомизации создавай копию remote вкладки (новую вкладку)
2. Или экспортируй изменённую вкладку перед обновлением
3. Remote вкладки предназначены для получения обновлений, не для редактирования

> **Примечание:** В версиях до 4.2.0 был флаг `userModified`, но он был удалён. Сейчас защиты от перезаписи нет — remote вкладки полностью заменяются при обновлении.

---

## Workarounds

### Ghost Button

**Проблема:** Появляется невидимая кнопка, перехватывающая клики.

**Решение в коде:**
```javascript
// claude_helpers.js
function hideGhostButton() {
    const indicator = __findEl__('ui.ghostButtonIndicator');
    if (indicator) {
        const btn = indicator.closest('button');
        if (btn) btn.style.display = 'none';
    }
}
setupCombinedObserver(); // Объединённый MutationObserver для автоскрытия
```

---

### Sidebar Overlap

**Проблема:** Сайдбар Claude перекрывает UI.

**Решение в коде:**
```javascript
function hideSidebar() {
    const nav = __findEl__('navigation.leftNav');
    if (nav) nav.style.pointerEvents = 'none';
}
```

---

### Z-Order WebViews

**Проблема:** Новые WebView создаются под существующими.

**Решение:** `recreate_toolbar()` пересоздаёт toolbar и downloads WebView поверх Claude.

---

### URL Change Detection

**Проблема:** Стандартные события не ловят SPA-навигацию Claude.

**Решение:**
```javascript
// Перехват history API
const originalPushState = history.pushState;
history.pushState = function(...args) {
    originalPushState.apply(this, args);
    notifyUrlChange();
};

// Backup проверка каждые 2 сек
setInterval(checkUrlChange, 2000);
```

---

## Производительность

### Критичные места

| Функция | Когда вызывать | Избегать |
|---------|----------------|----------|
| `renderWorkflow()` | При изменении данных | В циклах |
| `saveWorkflowState()` | Debounced (авто) | Напрямую в циклах |
| `saveAllTabs()` | После изменений | Частые вызовы |
| `getAllTabs()` | Один раз, кэшировать | В каждом рендере |

### Рекомендации

1. **Используй `preserveScroll: true`** где возможно
2. **Batch DOM операции** — собирай изменения, применяй разом
3. **Кэшируй `getAllTabs()`** — не вызывай в циклах
4. **Debounce input handlers** — особенно textarea

---

## Отладка проблем

### Приложение не запускается

```
□ WebView2 Runtime установлен?
□ Антивирус не блокирует?
□ Запуск от администратора помогает?
```

### Claude WebView пустой

```
□ Интернет работает?
□ claude.ai открывается в браузере?
□ Попробуй Настройки → Сбросить всё
```

### Данные не сохраняются

```
□ localStorage не переполнен?
□ Консоль показывает ошибки?
□ Перезапуск помогает?
```

---

## Связанные документы

- [FAQ.md](FAQ.md) — Часто задаваемые вопросы
- [../04-CLAUDE.md](../04-CLAUDE.md) — Интеграция с Claude
- [../guides/CONTRIBUTING.md](../guides/CONTRIBUTING.md) — Troubleshooting
- [SECURITY.md](SECURITY.md) — Безопасность
